<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lunes de UNO (beta)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --uno-red: #ED1C24;
      --uno-yellow: #FFDE00;
      --uno-green: #00A651;
      --uno-blue: #0072BC;
      --bg: #0f0f1a;
      --surface: #1a1a2e;
      --surface-2: #242442;
      --surface-3: #2e2e50;
      --text: #f0f0f5;
      --text-muted: #8888a8;
      --border: #3a3a5c;
      --danger: #ff4d6a;
      --success: #4dff91;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ---- Header (logo + flags) ---- */
    .app-header {
      position: fixed; top: 0; left: 0; right: 0; z-index: 200;
      height: 10vh;
      min-height: 52px;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 1rem;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }
    .header-logo {
      display: flex; align-items: center; gap: .5rem;
      text-decoration: none; color: var(--text);
      height: 95%;
    }
    .header-logo svg {
      height: 95%;
      width: auto;
      max-height: 10vh;
      display: block;
    }
    .lang-switcher {
      display: flex; gap: .4rem;
      height: 95%;
      align-items: center;
    }
    .lang-btn {
      height: 95%;
      min-width: 40px; border-radius: 6px; cursor: pointer;
      border: 2px solid transparent; overflow: hidden;
      transition: all .2s; opacity: .55;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.35rem; line-height: 1;
      background: var(--surface-2);
    }
    .lang-btn:hover { opacity: .85; }
    .lang-btn.active { opacity: 1; border-color: var(--uno-yellow); box-shadow: 0 2px 12px rgba(255,222,0,.25); }

    @media print { .app-header { display: none !important; } .round-roast { display: none !important; } }

    /* ---- Shared Layout ---- */
    .screen {
      display: none;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 2rem 1rem;
      animation: fadeIn .35s ease;
    }
    .screen.active { display: flex; }
    .screen { padding-top: calc(10vh + 2rem); }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    h1, h2, h3, h4 { font-family: 'Fredoka One', cursive; letter-spacing: .02em; }

    /* ---- Buttons ---- */
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: .5rem;
      border: none; border-radius: 14px; cursor: pointer;
      font-family: 'Inter', sans-serif; font-weight: 600;
      transition: all .2s ease;
    }
    .btn:active { transform: scale(.97); }
    .btn:disabled { opacity: .35; cursor: not-allowed; transform: none; }

    .btn-primary {
      background: linear-gradient(135deg, var(--uno-red), #ff4060);
      color: #fff; font-size: 1.15rem; padding: 1rem 2.5rem;
      box-shadow: 0 6px 24px rgba(237,28,36,.35);
    }
    .btn-primary:hover:not(:disabled) { box-shadow: 0 8px 32px rgba(237,28,36,.5); transform: translateY(-2px); }

    .btn-secondary {
      background: var(--surface-2); color: var(--text);
      font-size: .95rem; padding: .75rem 1.5rem; border: 1px solid var(--border);
    }
    .btn-secondary:hover:not(:disabled) { background: var(--surface-3); }

    .btn-small {
      font-size: .8rem; padding: .45rem 1rem; border-radius: 8px;
    }

    .btn-icon {
      width: 38px; height: 38px; padding: 0; border-radius: 10px;
      background: var(--surface-2); color: var(--text); border: 1px solid var(--border);
      font-size: 1.1rem;
    }

    /* ---- Cards ---- */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1.5rem;
      width: 100%;
      max-width: 480px;
    }

    /* ---- Inputs ---- */
    .input-group { display: flex; flex-direction: column; gap: .4rem; }
    .input-group label { font-size: .85rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: .06em; }

    input[type="text"], input[type="number"], select {
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-size: 1rem;
      padding: .7rem 1rem;
      outline: none;
      transition: border-color .2s;
      width: 100%;
    }
    input:focus, select:focus { border-color: var(--uno-blue); }
    input[type="number"] { -moz-appearance: textfield; }
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; }

    /* ---- HOME SCREEN ---- */
    #home { justify-content: center; gap: 2.5rem; text-align: center; }
    .logo-title {
      font-size: 3.2rem;
      background: linear-gradient(135deg, var(--uno-red), var(--uno-yellow), var(--uno-green), var(--uno-blue));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text;
      filter: drop-shadow(0 2px 12px rgba(237,28,36,.3));
    }
    .logo-sub { color: var(--text-muted); font-size: 1rem; margin-top: .5rem; }

    .home-beta-links { margin-top: 2rem; display: flex; align-items: center; justify-content: center; gap: .5rem; flex-wrap: wrap; font-size: .85rem; }
    .home-beta-links .under-construction {
      font-size: .85rem; color: var(--text-muted);
      text-decoration: none; border-bottom: 1px dashed var(--border);
    }
    .home-beta-links .under-construction:hover { color: var(--uno-yellow); }
    .home-beta-links .beta-sep { color: var(--border); }
    /* Share (beta) */
    .share-card { margin-top: 1rem; }
    .share-card h4 { margin-bottom: .75rem; font-size: 1rem; color: var(--text-muted); }
    .share-actions { display: flex; flex-direction: column; gap: .75rem; }
    .share-photo-row { display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-start; justify-content: center; margin-top: .5rem; }
    .share-photo-box { text-align: center; max-width: 220px; }
    .share-photo-box img { width: 100%; border-radius: 12px; border: 2px solid var(--border); display: block; }
    .share-photo-box .share-photo-label { font-size: .75rem; color: var(--text-muted); margin-top: .35rem; }
    .share-photo-box .btn-small { margin-top: .5rem; }
    .photo-upload-wrap { margin: .5rem 0; }
    .photo-upload-wrap input[type="file"] { font-size: .85rem; color: var(--text); }
    /* Stats example */
    #stats { gap: 1.25rem; padding-top: calc(52px + 1rem); }
    .stats-card { max-width: 520px; }
    .stats-card h3 { font-size: 1.1rem; margin-bottom: .75rem; color: var(--uno-yellow); }
    .stats-table { width: 100%; border-collapse: collapse; font-size: .9rem; }
    .stats-table th, .stats-table td { padding: .5rem .6rem; text-align: left; border-bottom: 1px solid var(--border); }
    .stats-table th { color: var(--text-muted); font-weight: 600; font-size: .75rem; text-transform: uppercase; }
    .stats-badge { display: inline-block; padding: .2rem .5rem; border-radius: 8px; font-size: .8rem; font-weight: 600; }
    .stats-badge.gold { background: rgba(255,222,0,.2); color: var(--uno-yellow); }
    .stats-badge.silver { background: rgba(192,192,192,.2); color: #c0c0c0; }
    .stats-badge.bronze { background: rgba(205,127,50,.2); color: #cd7f32; }
    .stats-example-note { font-size: .8rem; color: var(--text-muted); margin-top: 1rem; }

    .uno-cards {
      display: flex; gap: .6rem; justify-content: center; margin-bottom: .5rem;
    }
    .uno-card-mini {
      width: 72px; height: 105px; border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-family: 'Fredoka One', cursive; font-size: 1.1rem; font-weight: bold; color: #fff;
      box-shadow: 0 4px 16px rgba(0,0,0,.35);
      transform: rotate(var(--rot, 0deg));
      background: #1a1a1a;
      border: 2px solid #333;
      position: relative;
      overflow: hidden;
    }
    .uno-card-mini::before {
      content: ''; position: absolute; inset: 0;
      background: linear-gradient(135deg,
        var(--uno-red) 0 25%, var(--uno-yellow) 25% 50%,
        var(--uno-green) 50% 75%, var(--uno-blue) 75% 100%);
      opacity: .35;
      border-radius: 6px;
    }
    .uno-card-mini span { position: relative; z-index: 1; text-shadow: 0 1px 2px rgba(0,0,0,.8); }

    /* ---- SETUP SCREEN ---- */
    #setup { gap: 1.5rem; padding-top: calc(52px + 1.5rem); }
    #setup .card + .card { margin-top: 0; }

    .player-inputs { display: flex; flex-direction: column; gap: .75rem; margin-top: .75rem; }
    .player-input-row {
      display: flex; align-items: center; gap: .5rem;
    }
    .player-color {
      width: 14px; height: 14px; border-radius: 50%; flex-shrink: 0;
    }
    .player-input-row input { flex: 1; }

    .points-presets {
      display: flex; flex-wrap: wrap; gap: .5rem; margin-top: .75rem;
    }
    .preset-btn {
      padding: .5rem 1rem; border-radius: 10px; border: 1px solid var(--border);
      background: var(--surface-2); color: var(--text); cursor: pointer;
      font-family: 'Inter', sans-serif; font-size: .9rem; font-weight: 500;
      transition: all .2s;
    }
    .preset-btn:hover, .preset-btn.selected {
      border-color: var(--uno-yellow); background: rgba(255,222,0,.12); color: var(--uno-yellow);
    }

    .setup-footer { margin-top: .5rem; }

    /* Number selector */
    .number-selector {
      display: flex; align-items: center; gap: 1rem; margin-top: .75rem;
    }
    .number-display {
      font-family: 'Fredoka One', cursive; font-size: 2.2rem;
      width: 60px; text-align: center; color: var(--uno-yellow);
    }

    /* ---- GAME SCREEN ---- */
    #game { gap: 1.25rem; padding-top: calc(52px + 1rem); }

    .game-header {
      display: flex; align-items: center; justify-content: space-between;
      width: 100%; max-width: 480px;
    }
    .game-header h2 { font-size: 1.4rem; }

    .round-badge {
      background: var(--uno-blue); color: #fff;
      padding: .3rem .9rem; border-radius: 20px;
      font-size: .85rem; font-weight: 600;
    }

    .scoreboard {
      width: 100%; max-width: 480px;
      border-collapse: separate;
      border-spacing: 0;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
    }
    .scoreboard th, .scoreboard td {
      padding: .65rem .75rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    .scoreboard th {
      background: var(--surface-2);
      font-size: .75rem;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: var(--text-muted);
      font-weight: 600;
    }
    .scoreboard tr:last-child td { border-bottom: none; }
    .scoreboard .player-name-cell {
      display: flex; align-items: center; gap: .5rem; font-weight: 600;
    }
    .scoreboard .total-cell {
      font-family: 'Fredoka One', cursive;
      font-size: 1.1rem;
    }
    .scoreboard .over-limit { color: var(--danger); }
    .scoreboard .winner-row { background: rgba(77, 255, 145, .08); }

    .round-inputs { display: flex; flex-direction: column; gap: .65rem; }
    .round-input-row {
      display: flex; align-items: center; gap: .75rem;
    }
    .round-input-row .player-label {
      display: flex; align-items: center; gap: .5rem;
      font-weight: 600; font-size: .95rem;
      min-width: 120px;
    }
    .round-input-row input {
      width: 90px; text-align: center;
      font-size: 1.1rem; font-weight: 600;
      padding: .6rem .5rem;
    }

    .game-actions {
      display: flex; gap: .75rem; flex-wrap: wrap; justify-content: center;
    }

    /* Progress bar */
    .progress-container { width: 100%; max-width: 480px; }
    .progress-label {
      display: flex; justify-content: space-between;
      font-size: .8rem; color: var(--text-muted); margin-bottom: .35rem;
    }
    .progress-bar {
      height: 6px; background: var(--surface-2); border-radius: 3px; overflow: hidden;
    }
    .progress-fill {
      height: 100%; border-radius: 3px;
      transition: width .4s ease;
      background: linear-gradient(90deg, var(--uno-green), var(--uno-yellow), var(--uno-red));
    }

    /* Round history */
    .round-history {
      width: 100%; max-width: 480px;
    }
    /* Round roast carousel */
    .round-roast {
      width: 100%; max-width: 480px;
      display: none;
      flex-direction: column;
      gap: .5rem;
    }
    .round-roast.visible { display: flex; }
    .round-roast-slides {
      min-height: 80px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
    }
    .round-roast-slide {
      display: none;
      padding: 1rem 1.25rem;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: .95rem;
      line-height: 1.4;
      min-height: 80px;
      box-sizing: border-box;
    }
    .round-roast-slide.active {
      display: flex;
    }
    .round-roast-slide.roast { color: var(--danger); }
    .round-roast-slide.brag { color: var(--success); }
    .round-roast-dots {
      display: flex;
      justify-content: center;
      gap: .5rem;
    }
    .round-roast-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--surface-3);
      border: none;
      cursor: pointer;
      padding: 0;
      transition: transform .2s, background .2s;
    }
    .round-roast-dot:hover { background: var(--border); }
    .round-roast-dot.active { background: var(--uno-yellow); transform: scale(1.2); }

    .round-history h3 { font-size: 1rem; margin-bottom: .75rem; color: var(--text-muted); }
    .round-history-table {
      width: 100%; border-collapse: separate; border-spacing: 0;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 14px; overflow: hidden;
      font-size: .85rem;
    }
    .round-history-table th, .round-history-table td {
      padding: .5rem .6rem; text-align: center;
      border-bottom: 1px solid var(--border);
    }
    .round-history-table th {
      background: var(--surface-2); font-size: .7rem;
      text-transform: uppercase; letter-spacing: .04em;
      color: var(--text-muted); font-weight: 600;
    }
    .round-history-table tr:last-child td { border-bottom: none; }
    .round-history-table td:first-child { font-weight: 600; text-align: left; padding-left: .75rem; }
    .round-history-table th:first-child { text-align: left; padding-left: .75rem; }
    .round-history-table .edit-cell {
      cursor: pointer; color: var(--uno-blue); font-weight: 600;
    }
    .round-history-table .edit-cell:hover { text-decoration: underline; }

    /* ---- RESULTS SCREEN ---- */
    #results { gap: 1.5rem; padding-top: calc(52px + 1.5rem); text-align: center; }

    .trophy { font-size: 4rem; margin-bottom: .25rem; }
    .winner-name {
      font-family: 'Fredoka One', cursive; font-size: 2rem;
      background: linear-gradient(135deg, var(--uno-yellow), #ffaa00);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .winner-subtitle { color: var(--text-muted); font-size: .95rem; margin-top: .25rem; }

    .final-standings {
      width: 100%; max-width: 480px;
    }
    .standing-row {
      display: flex; align-items: center; gap: 1rem;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 12px; padding: .85rem 1rem; margin-bottom: .5rem;
      transition: background .2s;
    }
    .standing-row:first-child { border-color: var(--uno-yellow); background: rgba(255,222,0,.06); }
    .standing-position {
      font-family: 'Fredoka One', cursive; font-size: 1.3rem;
      width: 36px; text-align: center;
    }
    .standing-position.gold { color: var(--uno-yellow); }
    .standing-position.silver { color: #c0c0c0; }
    .standing-position.bronze { color: #cd7f32; }
    .standing-info { flex: 1; text-align: left; }
    .standing-info .name { font-weight: 600; font-size: 1rem; }
    .standing-score {
      font-family: 'Fredoka One', cursive; font-size: 1.2rem;
    }

    .results-actions {
      display: flex; gap: .75rem; flex-wrap: wrap; justify-content: center;
      margin-top: .5rem;
    }

    /* ---- EDIT MODAL ---- */
    .modal-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,.6); backdrop-filter: blur(4px);
      z-index: 100; align-items: center; justify-content: center;
      padding: 1rem;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 1.75rem;
      width: 100%; max-width: 400px;
      animation: fadeIn .25s ease;
    }
    .modal h3 { margin-bottom: 1rem; font-size: 1.15rem; }
    .modal-inputs { display: flex; flex-direction: column; gap: .65rem; }
    .modal-input-row {
      display: flex; align-items: center; justify-content: space-between; gap: 1rem;
    }
    .modal-input-row label { font-weight: 600; font-size: .9rem; }
    .modal-input-row input { width: 90px; text-align: center; font-weight: 600; }
    .modal-actions { display: flex; gap: .75rem; margin-top: 1.25rem; justify-content: flex-end; }

    /* ---- PRINT STYLES ---- */
    @media print {
      body { background: #fff; color: #000; }
      .screen { padding: 0; min-height: auto; }
      .no-print { display: none !important; }
      .card, .scoreboard, .round-history-table, .standing-row {
        background: #fff; border-color: #ddd; color: #000;
      }
      .scoreboard th, .round-history-table th { background: #f5f5f5; color: #333; }
      .scoreboard td, .round-history-table td { color: #000; }
      .logo-title, .winner-name {
        -webkit-text-fill-color: #000;
        background: none; color: #000;
      }
      .standing-position.gold { color: #b8860b; -webkit-text-fill-color: #b8860b; }
      .trophy { font-size: 2rem; }
      .print-header {
        display: block !important;
        text-align: center; margin-bottom: 1rem;
        font-family: 'Fredoka One', cursive; font-size: 1.5rem;
      }
      .standing-row { border-color: #ccc; }
      .standing-row:first-child { border-color: #b8860b; }
    }

    .print-header { display: none; }

    /* ---- Walk of Shame ---- */
    .walk-of-shame {
      width: 100%; max-width: 480px;
      display: none;
    }
    .walk-of-shame.visible { display: block; }
    .walk-of-shame h3 {
      font-size: .95rem; color: var(--danger); margin-bottom: .5rem;
      display: flex; align-items: center; gap: .4rem;
    }
    .shame-list {
      display: flex; flex-direction: column; gap: .4rem;
    }
    .shame-row {
      display: flex; align-items: center; gap: .6rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: .55rem .75rem;
    }
    .shame-rank {
      font-family: 'Fredoka One', cursive;
      font-size: 1rem; width: 24px; text-align: center;
      color: var(--danger);
    }
    .shame-name {
      flex: 1; font-weight: 600; font-size: .9rem;
      display: flex; align-items: center; gap: .4rem;
    }
    .shame-badge {
      background: rgba(255,77,106,.15);
      color: var(--danger);
      padding: .2rem .6rem;
      border-radius: 8px;
      font-size: .8rem;
      font-weight: 700;
      white-space: nowrap;
    }

    /* ---- Copy Toast ---- */
    .copy-toast {
      position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%) translateY(20px);
      background: var(--success); color: #000;
      padding: .6rem 1.5rem; border-radius: 12px;
      font-weight: 600; font-size: .9rem;
      opacity: 0; transition: all .3s ease;
      z-index: 999; pointer-events: none;
    }
    .copy-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    /* ---- Hat Pulse ---- */
    @keyframes hatPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.3) rotate(8deg); }
      100% { transform: scale(1); }
    }
    .hat-pulse { animation: hatPulse .35s ease; }

    /* ---- Suffering Chart ---- */
    .suffering-section { margin-top: 1.5rem; }
    .suffering-section h3 { font-size: 1.1rem; margin-bottom: .75rem; color: var(--danger); }
    #sufferingChart {
      width: 100%; height: 280px;
      border-radius: 12px;
      background: var(--surface-2);
      border: 1px solid var(--border);
    }
    .chart-legend {
      display: flex; flex-wrap: wrap; gap: .75rem; margin-top: .5rem;
      justify-content: center; font-size: .8rem;
    }
    .chart-legend-item { display: flex; align-items: center; gap: .3rem; }
    .chart-legend-dot { width: 10px; height: 10px; border-radius: 50%; }

    /* ---- Modo Asado Toggle ---- */
    .asado-toggle-row {
      display: flex; align-items: center; gap: .75rem;
      margin-top: 1.5rem;
      font-size: .95rem; font-weight: 600; color: var(--text-muted);
    }
    .asado-switch {
      position: relative; width: 52px; height: 28px;
      background: var(--surface-2); border: 1px solid var(--border);
      border-radius: 14px; cursor: pointer;
      transition: background .3s;
    }
    .asado-switch input { display: none; }
    .asado-switch .slider {
      position: absolute; top: 2px; left: 2px;
      width: 22px; height: 22px; border-radius: 50%;
      background: var(--text-muted);
      transition: all .3s; display: flex; align-items: center; justify-content: center;
      font-size: .75rem;
    }
    .asado-switch input:checked + .slider {
      left: 26px; background: #ff6b35;
    }
    .asado-switch input:checked ~ .asado-switch { background: rgba(255,107,53,.2); }
    body.asado .asado-switch { background: rgba(255,107,53,.25); border-color: #ff6b35; }

    /* ---- Modo Asado Theme ---- */
    body.asado {
      --bg: #1a0e08;
      --surface: #2a1a0e;
      --surface-2: #3d2b1f;
      --surface-3: #4a3728;
      --text: #f5e6d0;
      --text-muted: #a08060;
      --border: #5a4030;
      --danger: #ff6b35;
      --success: #7cb342;
      --uno-red: #e64a19;
      --uno-yellow: #ffb300;
      --uno-green: #7cb342;
      --uno-blue: #78909c;
    }
    body.asado .btn-primary {
      background: linear-gradient(135deg, #e64a19, #ff6b35);
      box-shadow: 0 6px 24px rgba(230,74,25,.35);
    }
    body.asado .progress-fill {
      background: linear-gradient(90deg, #c62828, #e64a19, #ff6b35, #ffb300, #4e342e);
    }
    body.asado .logo-title {
      background: linear-gradient(135deg, #e64a19, #ffb300, #7cb342, #78909c);
      -webkit-background-clip: text; background-clip: text;
    }
    body.asado .round-roast-slide.roast { color: #ff6b35; }
    body.asado .round-roast-slide.brag { color: #7cb342; }

    /* ---- Flying Meat (Modo Asado) ---- */
    .flying-meat {
      position: fixed;
      z-index: 50;
      pointer-events: none;
      user-select: none;
      animation: meatFly var(--fly-dur, 6s) linear forwards;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,.4));
      max-width: 120px;
      height: auto;
    }
    @keyframes meatFly {
      0% {
        transform: translate(var(--start-x), var(--start-y)) rotate(0deg) scale(0.5);
        opacity: 0;
      }
      10% {
        opacity: 1;
        transform: translate(var(--start-x), var(--start-y)) rotate(30deg) scale(1);
      }
      90% {
        opacity: 1;
      }
      100% {
        transform: translate(var(--end-x), var(--end-y)) rotate(var(--spin, 720deg)) scale(0.6);
        opacity: 0;
      }
    }

    /* ---- Responsive ---- */
    @media (max-width: 500px) {
      .logo-title { font-size: 2.4rem; }
      .round-input-row .player-label { min-width: 90px; font-size: .85rem; }
      .round-input-row input { width: 75px; }
      .scoreboard th, .scoreboard td { padding: .5rem .4rem; font-size: .85rem; }
    }
  </style>
</head>
<body>

  <!-- ============ HEADER (logo + flags) ============ -->
  <header class="app-header no-print">
    <a href="#" class="header-logo" id="headerLogo" onclick="playNextSound(); showScreen('home'); return false;" aria-label="Lunes de UNO">
      <svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <!-- Galera negra (top hat): brim + crown -->
        <ellipse cx="20" cy="28" rx="14" ry="4" fill="#0a0a0a"/>
        <path d="M8 28 L8 12 Q8 6 20 6 Q32 6 32 12 L32 28 Z" fill="#0a0a0a"/>
        <ellipse cx="20" cy="12" rx="12" ry="3" fill="#111"/>
        <rect x="10" y="12" width="20" height="16" fill="#0a0a0a"/>
      </svg>
    </a>
    <div class="lang-switcher">
      <button class="lang-btn active" id="langEs" onclick="setLang('es')" title="EspaÃ±ol">ðŸ‡ºðŸ‡¾</button>
      <button class="lang-btn" id="langEn" onclick="setLang('en')" title="English">ðŸ‡ºðŸ‡¸</button>
      <button class="lang-btn" id="langPt" onclick="setLang('pt')" title="PortuguÃªs">ðŸ‡§ðŸ‡·</button>
      <button class="lang-btn" id="langDe" onclick="setLang('de')" title="Deutsch">ðŸ‡©ðŸ‡ª</button>
    </div>
  </header>

  <!-- ============ HOME ============ -->
  <div id="home" class="screen active">
    <div>
      <div class="uno-cards">
        <div class="uno-card-mini" style="--rot:-8deg;"><span>+4</span></div>
        <div class="uno-card-mini" style="--rot:-3deg;"><span>+4</span></div>
        <div class="uno-card-mini" style="--rot:3deg;"><span>+4</span></div>
        <div class="uno-card-mini" style="--rot:8deg;"><span>+4</span></div>
      </div>
      <h1 class="logo-title">Lunes de UNO</h1>
      <p class="logo-sub" data-i18n="home_sub"></p>
    </div>
    <button class="btn btn-primary" onclick="showScreen('setup')" data-i18n="home_start"></button>
    <div class="asado-toggle-row">
      <label class="asado-switch">
        <input type="checkbox" id="asadoToggle" onchange="toggleAsado()">
        <span class="slider">ðŸ¥©</span>
      </label>
      <span data-i18n="asado_mode"></span>
    </div>
    <p class="home-beta-links">
      <a href="index.html" class="under-construction" data-i18n="home_back_stable">VersiÃ³n estable</a>
      <span class="beta-sep">Â·</span>
      <a href="#" class="under-construction" onclick="showScreen('stats'); return false;" data-i18n="home_example_stats">EstadÃ­sticas de ejemplo</a>
    </p>
  </div>

  <!-- ============ SETUP ============ -->
  <div id="setup" class="screen">
    <h2 style="font-size:1.6rem; margin-bottom:.5rem;" data-i18n="setup_title"></h2>

    <div class="card">
      <div class="input-group">
        <label data-i18n="setup_players_label"></label>
        <div class="number-selector">
          <button class="btn btn-icon" onclick="changePlayerCount(-1)">-</button>
          <div class="number-display" id="playerCountDisplay">2</div>
          <button class="btn btn-icon" onclick="changePlayerCount(1)">+</button>
        </div>
      </div>
      <div class="player-inputs" id="playerInputs"></div>
    </div>

    <div class="card">
      <div class="input-group">
        <label data-i18n="setup_points_label"></label>
        <div class="points-presets" id="pointsPresets">
          <button class="preset-btn" data-val="200" onclick="selectPoints(this, 200)">200</button>
          <button class="preset-btn" data-val="300" onclick="selectPoints(this, 300)">300</button>
          <button class="preset-btn selected" data-val="500" onclick="selectPoints(this, 500)">500</button>
          <button class="preset-btn" data-val="1000" onclick="selectPoints(this, 1000)">1000</button>
        </div>
        <div style="display:flex; align-items:center; gap:.5rem; margin-top:.75rem;">
          <input type="number" id="customPoints" placeholder="" data-i18n-ph="setup_custom_placeholder" min="50" style="flex:1;" oninput="onCustomPoints()">
        </div>
      </div>
    </div>

    <div class="setup-footer">
      <button class="btn btn-primary" id="startGameBtn" onclick="startGame()" data-i18n="setup_start_btn"></button>
    </div>

    <button class="btn btn-secondary btn-small no-print" onclick="showScreen('home')" style="margin-top:.5rem;" data-i18n="back_btn"></button>
  </div>

  <!-- ============ GAME ============ -->
  <div id="game" class="screen">
    <div class="game-header">
      <h2 id="gameTitle">Lunes de UNO</h2>
      <span class="round-badge" id="roundBadge"></span>
    </div>

    <!-- Progress of leading player -->
    <div class="progress-container" id="progressContainer">
      <div class="progress-label">
        <span id="progressLeader">-</span>
        <span id="progressText">0 / 500</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width:0%"></div>
      </div>
    </div>

    <!-- Current Scoreboard -->
    <table class="scoreboard" id="scoreboard"></table>

    <!-- Walk of Shame -->
    <div class="walk-of-shame no-print" id="walkOfShame">
      <h3><span>ðŸ’€</span> <span data-i18n="shame_title"></span></h3>
      <div class="shame-list" id="shameList"></div>
    </div>

    <!-- Round Score Input -->
    <div class="card" id="roundInputCard">
      <h4 style="margin-bottom:.75rem; font-size:1rem;" data-i18n="game_enter_scores"></h4>
      <div class="round-inputs" id="roundInputs"></div>
      <div class="game-actions" style="margin-top:1rem;">
        <button class="btn btn-primary" style="font-size:1rem; padding:.75rem 2rem;" onclick="submitRound()" data-i18n="game_end_round"></button>
      </div>
    </div>

    <!-- Round roast carousel (after each round) -->
    <div class="round-roast no-print" id="roundRoastCarousel">
      <div class="round-roast-slides" id="roundRoastSlides"></div>
      <div class="round-roast-dots" id="roundRoastDots"></div>
    </div>

    <!-- Round History -->
    <div class="round-history" id="roundHistoryContainer" style="display:none;">
      <h3 data-i18n="game_round_history"></h3>
      <table class="round-history-table" id="roundHistoryTable"></table>
    </div>

    <button class="btn btn-secondary btn-small no-print" onclick="confirmQuit()" style="margin-top:.5rem; color:var(--danger);" data-i18n="game_quit"></button>
  </div>

  <!-- ============ RESULTS ============ -->
  <div id="results" class="screen">
    <div class="print-header">Lunes de UNO - Final Scores</div>
    <div class="trophy">&#127942;</div>
    <div>
      <div class="winner-name" id="winnerName">-</div>
      <p class="winner-subtitle" data-i18n="results_winner_sub"></p>
    </div>

    <div class="final-standings" id="finalStandings"></div>

    <!-- Paseo de la vergÃ¼enza / Walk of shame -->
    <div class="card" id="walkOfShameCard" style="display:none;">
      <h3 id="walkTitle"></h3>
      <p id="walkLine" style="margin-top:.35rem;"></p>
      <p id="walkRound" style="margin-top:.25rem; font-size:.85rem; color:var(--text-muted);"></p>
    </div>

    <!-- Full breakdown for print -->
    <div class="round-history" id="resultsHistoryContainer">
      <h3 data-i18n="results_breakdown"></h3>
      <table class="round-history-table" id="resultsHistoryTable"></table>
    </div>

    <div class="results-actions no-print">
      <button class="btn btn-secondary" onclick="printResults()"><span>&#128424;</span> <span data-i18n="results_print"></span></button>
      <button class="btn btn-secondary" onclick="showEditableHistory()"><span>&#9998;</span> <span data-i18n="results_edit"></span></button>
      <button class="btn btn-secondary" onclick="copyToClipboard()"><span>ðŸ“²</span> <span data-i18n="share_whatsapp"></span></button>
      <button class="btn btn-primary" onclick="newGame()" data-i18n="results_new_game"></button>
    </div>

    <!-- Share (beta) -->
    <div class="card share-card no-print">
      <h4 data-i18n="share_title">Compartir resultados</h4>
      <div class="share-actions">
        <button type="button" class="btn btn-secondary btn-small" onclick="downloadCertificado()">
          <span>ðŸ“œ</span> <span data-i18n="share_cert">Certificado de Desastre</span>
        </button>
        <div class="photo-upload-wrap">
          <label style="display:block; font-size:.85rem; margin-bottom:.35rem;" data-i18n="share_upload_photo">Subir foto con puntajes</label>
          <input type="file" id="sharePhotoInput" accept="image/*" onchange="onSharePhotoChange(event)">
        </div>
        <div class="share-photo-row" id="sharePhotoRow" style="display:none;">
          <div class="share-photo-box">
            <img id="sharePhotoOriginal" alt="Imagen para compartir" />
            <div class="share-photo-label" data-i18n="share_original">Imagen con puntajes</div>
            <button type="button" class="btn btn-small btn-secondary" onclick="downloadShareImage()" data-i18n="share_download_original">Descargar imagen</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============ STATS (example) ============ -->
  <div id="stats" class="screen">
    <h2 data-i18n="stats_title">EstadÃ­sticas de ejemplo</h2>
    <p class="stats-example-note" data-i18n="stats_subtitle">Datos inventados para mostrar cÃ³mo se verÃ­an las estadÃ­sticas.</p>
    <div class="card stats-card" id="statsCard"></div>
    <div class="card stats-card suffering-section">
      <h3 data-i18n="stats_suffering_title"></h3>
      <canvas id="sufferingChart"></canvas>
      <div class="chart-legend" id="chartLegend"></div>
    </div>
    <button class="btn btn-secondary btn-small" onclick="showScreen('home')" data-i18n="back_btn">Volver</button>
  </div>

  <!-- Copy toast -->
  <div class="copy-toast" id="copyToast"></div>

  <!-- ============ EDIT MODAL ============ -->
  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <h3 id="editModalTitle"></h3>
      <div class="modal-inputs" id="editModalInputs"></div>
      <div class="modal-actions">
        <button class="btn btn-secondary btn-small" onclick="closeEditModal()" data-i18n="modal_cancel"></button>
        <button class="btn btn-primary btn-small" onclick="saveEditRound()" data-i18n="modal_save"></button>
      </div>
    </div>
  </div>

<script>
// ============ I18N ============
const STRINGS = {
  es: {
    home_sub: 'Contador de puntos, bÃ³',
    home_start: 'Arrancar partida nueva',
    home_under_construction: 'En construcciÃ³n: compartir resultados',
    home_back_stable: 'VersiÃ³n estable',
    home_example_stats: 'EstadÃ­sticas de ejemplo',
    share_title: 'Compartir resultados',
    share_pdf_roast: 'Descargar PDF (roast al Ãºltimo)',
    share_cert: 'Certificado de Desastre',
    share_upload_photo: 'Subir foto y cartoon con puntajes',
    share_original: 'Original',
    share_cartoon: 'Cartoon con puntajes',
    share_download_original: 'Descargar original',
    share_download_cartoon: 'Descargar cartoon',
    stats_title: 'EstadÃ­sticas de ejemplo',
    stats_subtitle: 'Datos inventados para mostrar cÃ³mo se verÃ­an las estadÃ­sticas.',
    stats_wins: 'Victorias',
    stats_biggest_round: 'Ronda mÃ¡s brava',
    stats_most_roasts: 'Veces Ãºltimo en ronda',
    setup_title: 'Partida nueva',
    setup_players_label: 'Â¿CuÃ¡ntos juegan?',
    setup_points_label: 'Â¿Hasta cuÃ¡ntos puntos?',
    setup_custom_placeholder: 'Ponele lo que quieras...',
    setup_start_btn: 'Â¡Dale que va!',
    back_btn: 'Volver',
    game_enter_scores: 'Metele los puntos de la ronda',
    game_end_round: 'Cerrar ronda',
    game_round_history: 'Lo que fue pasando',
    game_quit: 'Rajar del juego',
    game_round: 'Ronda',
    game_player: 'Jugador',
    game_total: 'Total',
    game_no_scores: 'TodavÃ­a no arrancÃ³ nadie',
    game_pts: 'pts',
    game_edit: 'editar',
    game_alert_no_scores: 'Bo, metele algÃºn puntaje a alguien por lo menos.',
    game_confirm_quit: 'Â¿Posta te querÃ©s ir? Se pierde todo eh.',
    shame_title: 'Paseo de la VergÃ¼enza',
    shame_round_lost: 'ronda perdida',
    shame_rounds_lost: 'rondas perdidas',
    share_whatsapp: 'Mandale al grupo',
    share_copied: 'Â¡Copiado al portapapeles!',
    asado_mode: 'Modo Asado ðŸ¥©',
    stats_suffering_title: 'LÃ­nea de Sufrimiento',
    stats_suffering_yaxis: 'Nivel de sufrimiento',
    results_winner_sub: 'Â¡ganÃ³ con menos puntos, quÃ© crack!',
    results_breakdown: 'Ronda por ronda',
    results_print: 'Imprimir',
    results_edit: 'Editar puntajes',
    results_new_game: 'Otra partidita',
    modal_edit_round: 'Editar Ronda',
    modal_cancel: 'Na, dejÃ¡',
    modal_save: 'Guardar',
    player_placeholder: 'Jugador',
  },
  en: {
    home_sub: 'Score Tracker',
    home_start: 'Start New Game',
    home_under_construction: 'Under construction: share results',
    home_back_stable: 'Stable version',
    home_example_stats: 'Example stats',
    share_title: 'Share results',
    share_pdf_roast: 'Download PDF (roast last place)',
    share_cert: 'Certificate of Disaster',
    share_upload_photo: 'Upload photo & cartoon with scores',
    share_original: 'Original',
    share_cartoon: 'Cartoon with scores',
    share_download_original: 'Download original',
    share_download_cartoon: 'Download cartoon',
    stats_title: 'Example statistics',
    stats_subtitle: 'Made-up data to show what stats could look like.',
    stats_wins: 'Wins',
    stats_biggest_round: 'Biggest single round',
    stats_most_roasts: 'Times last in a round',
    setup_title: 'New Game',
    setup_players_label: 'Number of Players',
    setup_points_label: 'Points to Play',
    setup_custom_placeholder: 'Custom...',
    setup_start_btn: 'Start Game',
    back_btn: 'Back',
    game_enter_scores: 'Enter Round Scores',
    game_end_round: 'End Round',
    game_round_history: 'Round History',
    game_quit: 'Quit Game',
    game_round: 'Round',
    game_player: 'Player',
    game_total: 'Total',
    game_no_scores: 'No scores yet',
    game_pts: 'pts',
    game_edit: 'edit',
    game_alert_no_scores: 'Enter at least one score for this round.',
    game_confirm_quit: 'Are you sure you want to quit this game?',
    shame_title: 'Walk of Shame',
    shame_round_lost: 'round lost',
    shame_rounds_lost: 'rounds lost',
    share_whatsapp: 'Share to group',
    share_copied: 'Copied to clipboard!',
    asado_mode: 'BBQ Mode ðŸ¥©',
    stats_suffering_title: 'Suffering Line',
    stats_suffering_yaxis: 'Suffering Level',
    results_winner_sub: 'wins with the lowest score!',
    results_breakdown: 'Round Breakdown',
    results_print: 'Print Scores',
    results_edit: 'Edit Scores',
    results_new_game: 'New Game',
    modal_edit_round: 'Edit Round',
    modal_cancel: 'Cancel',
    modal_save: 'Save',
    player_placeholder: 'Player',
  },
  pt: {
    home_sub: 'Marcador de pontos',
    home_start: 'ComeÃ§ar nova partida',
    home_under_construction: 'Em construÃ§Ã£o: compartilhar resultados',
    home_back_stable: 'VersÃ£o estÃ¡vel',
    home_example_stats: 'EstatÃ­sticas de exemplo',
    share_title: 'Compartilhar resultados',
    share_pdf_roast: 'Baixar PDF (roast do Ãºltimo)',
    share_cert: 'Certificado de Desastre',
    share_upload_photo: 'Enviar foto com pontuaÃ§Ãµes',
    share_original: 'Imagem com pontuaÃ§Ãµes',
    share_cartoon: 'Cartoon com pontuaÃ§Ãµes',
    share_download_original: 'Baixar imagem',
    share_download_cartoon: 'Baixar cartoon',
    stats_title: 'EstatÃ­sticas de exemplo',
    stats_subtitle: 'Dados inventados sÃ³ para mostrar como ficaria.',
    stats_wins: 'VitÃ³rias',
    stats_biggest_round: 'Rodada mais pesada',
    stats_most_roasts: 'Vezes em Ãºltimo na rodada',
    setup_title: 'Nova partida',
    setup_players_label: 'Quantos jogam?',
    setup_points_label: 'AtÃ© quantos pontos?',
    setup_custom_placeholder: 'Coloca o valor que quiser...',
    setup_start_btn: 'Bora jogar!',
    back_btn: 'Voltar',
    game_enter_scores: 'Coloca os pontos da rodada',
    game_end_round: 'Fechar rodada',
    game_round_history: 'O que jÃ¡ rolou',
    game_quit: 'Sair do jogo',
    game_round: 'Rodada',
    game_player: 'Jogador',
    game_total: 'Total',
    game_no_scores: 'NinguÃ©m marcou ainda',
    game_pts: 'pts',
    game_edit: 'editar',
    game_alert_no_scores: 'Bota pelo menos um pontinho pra alguÃ©m.',
    game_confirm_quit: 'Tem certeza que quer sair? Perde tudo hein.',
    shame_title: 'Passeio da vergonha',
    shame_round_lost: 'rodada perdida',
    shame_rounds_lost: 'rodadas perdidas',
    share_whatsapp: 'Mandar no grupo',
    share_copied: 'Copiado para a Ã¡rea de transferÃªncia!',
    asado_mode: 'Modo Churrasco ðŸ¥©',
    stats_suffering_title: 'Linha do sofrimento',
    stats_suffering_yaxis: 'NÃ­vel de sofrimento',
    results_winner_sub: 'ganhou com menos pontos, mito!',
    results_breakdown: 'Rodada por rodada',
    results_print: 'Imprimir pontos',
    results_edit: 'Editar pontuaÃ§Ãµes',
    results_new_game: 'Outra partida',
    modal_edit_round: 'Editar rodada',
    modal_cancel: 'Deixa pra lÃ¡',
    modal_save: 'Salvar',
    player_placeholder: 'Jogador',
  },
  de: {
    home_sub: 'Punktestand fÃ¼r UNO',
    home_start: 'Neues Spiel starten',
    home_under_construction: 'Im Bau: Ergebnisse teilen',
    home_back_stable: 'Stabile Version',
    home_example_stats: 'Beispielstatistiken',
    share_title: 'Ergebnisse teilen',
    share_pdf_roast: 'PDF laden (Roast fÃ¼r den Letzten)',
    share_cert: 'Desaster-Zertifikat',
    share_upload_photo: 'Foto mit Punkten hochladen',
    share_original: 'Bild mit Punkten',
    share_cartoon: 'Cartoon mit Punkten',
    share_download_original: 'Bild herunterladen',
    share_download_cartoon: 'Cartoon herunterladen',
    stats_title: 'Beispielstatistiken',
    stats_subtitle: 'Ausgedachte Daten zur Demo.',
    stats_wins: 'Siege',
    stats_biggest_round: 'HÃ¤rteste Runde',
    stats_most_roasts: 'Am hÃ¤ufigsten Letzter',
    setup_title: 'Neues Spiel',
    setup_players_label: 'Wie viele spielen?',
    setup_points_label: 'Bis zu wie vielen Punkten?',
    setup_custom_placeholder: 'Eigene Punktzahl...',
    setup_start_btn: 'Los gehtâ€™s!',
    back_btn: 'ZurÃ¼ck',
    game_enter_scores: 'Rundenpunkte eintragen',
    game_end_round: 'Runde beenden',
    game_round_history: 'Bisherige Runden',
    game_quit: 'Spiel verlassen',
    game_round: 'Runde',
    game_player: 'Spieler',
    game_total: 'Gesamt',
    game_no_scores: 'Noch keine Punkte',
    game_pts: 'Pkt',
    game_edit: 'bearbeiten',
    game_alert_no_scores: 'Trag wenigstens einen Punkt fÃ¼r jemanden ein.',
    game_confirm_quit: 'Willst du das Spiel wirklich beenden? Alles geht verloren.',
    shame_title: 'Gang der Schande',
    shame_round_lost: 'verlorene Runde',
    shame_rounds_lost: 'verlorene Runden',
    share_whatsapp: 'In die Gruppe schicken',
    share_copied: 'In die Zwischenablage kopiert!',
    asado_mode: 'Grillmodus ðŸ¥©',
    stats_suffering_title: 'Leidenslinie',
    stats_suffering_yaxis: 'Leidens-Level',
    results_winner_sub: 'gewinnt mit der niedrigsten Punktzahl!',
    results_breakdown: 'RundenÃ¼bersicht',
    results_print: 'Punkte drucken',
    results_edit: 'Punkte bearbeiten',
    results_new_game: 'Neues Spiel',
    modal_edit_round: 'Runde bearbeiten',
    modal_cancel: 'Abbrechen',
    modal_save: 'Speichern',
    player_placeholder: 'Spieler',
  }
};

// Messages for round roast carousel: 2 at last (most pts), 1 at second-last, 1 at first (least pts)
const CAROUSEL_MSGS = {
  es: {
    last: [
      'Bo {name}, te comiste todos los puntos de la mesa ðŸ˜‚',
      '{name} juntÃ³ mÃ¡s puntos que boleto de STM, ta bravo.',
      'Â¿{name} estaba jugando al UNO o al â€œsumÃ¡ todo, boâ€?',
      'Pa, {name}, dejale algÃºn punto a los demÃ¡s, Â¿no?',
      'Alguien avÃ­sele a {name} que acÃ¡ gana el que tiene menos, ta.',
    ],
    secondLast: [
      '{name} zafÃ³ por poquito de ser el desastre de la ronda.',
      'Bo {name}, casi quedÃ¡s Ãºltimo tambiÃ©n, ojo ahÃ­.',
    ],
    first: [
      'Â¡{name} saliÃ³ hecho un crack esta ronda, bo! ðŸ†',
      '{name} se fue livianito de puntos, ta que bien jugado.',
      'Esta ronda fue toda de {name}, tremendo nivel.',
    ],
  },
  en: {
    last: [
      '{name} went full send and took the whole pile! ðŸ˜‚',
      '{name} collected more than the dealer. Yikes.',
      'Was {name} playing UNO or â€œadd everythingâ€?',
      '{name} built a monument to points! ðŸ—¿',
      'Someone tell {name} that the lowest score wins.',
    ],
    secondLast: [
      '{name} came second atâ€¦ hoarding. So close.',
      '{name} almost had the highest round. Next time!',
    ],
    first: [
      '{name} crushed it this round! ðŸ†',
      '{name} kept it low. That\'s how you play!',
      'That round belonged to {name}. Applause.',
    ],
  },
};

let currentLang = localStorage.getItem('lunesdeuno_lang') || 'es';
let roundRoastInterval = null;

function t(key) {
  return (STRINGS[currentLang] && STRINGS[currentLang][key]) || STRINGS.en[key] || key;
}

function setLang(lang) {
  currentLang = lang;
  localStorage.setItem('lunesdeuno_lang', lang);
  document.documentElement.lang = lang;

  // Update flag buttons
  const btnEs = document.getElementById('langEs');
  const btnEn = document.getElementById('langEn');
  const btnPt = document.getElementById('langPt');
  const btnDe = document.getElementById('langDe');
  if (btnEs) btnEs.classList.toggle('active', lang === 'es');
  if (btnEn) btnEn.classList.toggle('active', lang === 'en');
  if (btnPt) btnPt.classList.toggle('active', lang === 'pt');
  if (btnDe) btnDe.classList.toggle('active', lang === 'de');

  // Apply all data-i18n
  document.querySelectorAll('[data-i18n]').forEach(el => {
    el.textContent = t(el.dataset.i18n);
  });
  document.querySelectorAll('[data-i18n-ph]').forEach(el => {
    el.placeholder = t(el.dataset.i18nPh);
  });

  // Re-render dynamic content if a game screen is active
  if (document.getElementById('setup').classList.contains('active')) renderPlayerInputs();
  if (document.getElementById('game').classList.contains('active')) renderGame();
  if (document.getElementById('results').classList.contains('active')) renderResults();
  if (document.getElementById('stats').classList.contains('active')) renderStats();
}

// ============ STATE ============
let state = {
  playerCount: 2,
  maxPoints: 500,
  players: [],
  rounds: [],
  currentRound: 0,
  gameOver: false
};

const PLAYER_COLORS = [
  '#ED1C24', '#FFDE00', '#00A651', '#0072BC',
  '#FF6B35', '#A855F7', '#EC4899', '#14B8A6',
  '#F97316', '#6366F1'
];

// ============ NAVIGATION ============
function showScreen(id) {
  if (id !== 'game' && roundRoastInterval) {
    clearInterval(roundRoastInterval);
    roundRoastInterval = null;
  }
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if (id === 'setup') initSetup();
  if (id === 'game') renderGame();
  if (id === 'results') renderResults();
  if (id === 'stats') renderStats();
}

// ============ SETUP ============
function initSetup() {
  renderPlayerInputs();
  validateSetup();
}

function changePlayerCount(delta) {
  state.playerCount = Math.max(2, Math.min(10, state.playerCount + delta));
  document.getElementById('playerCountDisplay').textContent = state.playerCount;
  renderPlayerInputs();
}

function renderPlayerInputs() {
  const container = document.getElementById('playerInputs');
  const existing = container.querySelectorAll('input');
  const oldValues = Array.from(existing).map(i => i.value);

  const isAsado = document.body.classList.contains('asado');
  let html = '';
  for (let i = 0; i < state.playerCount; i++) {
    const color = PLAYER_COLORS[i % PLAYER_COLORS.length];
    const val = oldValues[i] || '';
    const dot = isAsado ? `<span style="font-size:1.1rem;">${getAsadoEmoji(i)}</span>` :
      `<div class="player-color" style="background:${color}"></div>`;
    html += `
      <div class="player-input-row">
        ${dot}
        <input type="text" placeholder="${t('player_placeholder')} ${i + 1}" value="${val}" maxlength="20" oninput="validateSetup()">
      </div>`;
  }
  container.innerHTML = html;
  validateSetup();
}

function selectPoints(btn, val) {
  document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  state.maxPoints = val;
  document.getElementById('customPoints').value = '';
  validateSetup();
}

function onCustomPoints() {
  const v = parseInt(document.getElementById('customPoints').value);
  document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('selected'));
  if (v && v >= 50) {
    state.maxPoints = v;
  }
  validateSetup();
}

function validateSetup() {
  const inputs = document.querySelectorAll('#playerInputs input');
  const allNamed = Array.from(inputs).every(i => i.value.trim().length > 0);
  const hasPoints = state.maxPoints >= 50;
  document.getElementById('startGameBtn').disabled = !(allNamed && hasPoints);
}

function startGame() {
  const inputs = document.querySelectorAll('#playerInputs input');
  state.players = Array.from(inputs).map((inp, i) => ({
    name: inp.value.trim() || `${t('player_placeholder')} ${i+1}`,
    color: PLAYER_COLORS[i % PLAYER_COLORS.length]
  }));
  state.rounds = [];
  state.currentRound = 0;
  state.gameOver = false;
  showScreen('game');
}

// ============ ROUND ROAST CAROUSEL ============
function getRoundRanking(roundScores) {
  const withIdx = state.players.map((p, i) => ({ idx: i, name: p.name, score: roundScores[i] || 0 }));
  const byScoreDesc = [...withIdx].sort((a, b) => b.score - a.score);
  return {
    first: byScoreDesc[byScoreDesc.length - 1],
    secondLast: byScoreDesc.length >= 2 ? byScoreDesc[1] : byScoreDesc[0],
    last: byScoreDesc[0],
  };
}

function buildRoastMessages(roundScores) {
  const rank = getRoundRanking(roundScores);
  const lang = currentLang in CAROUSEL_MSGS ? currentLang : 'es';
  const M = CAROUSEL_MSGS[lang];
  const pick = (arr, name) => arr[Math.floor(Math.random() * arr.length)].replace(/\{name\}/g, name);
  return [
    pick(M.last, rank.last.name),
    pick(M.last, rank.last.name),
    pick(M.secondLast, rank.secondLast.name),
    pick(M.first, rank.first.name),
  ];
}

function setRoundRoastSlide(index) {
  const slides = document.querySelectorAll('.round-roast-slide');
  const dots = document.querySelectorAll('.round-roast-dot');
  slides.forEach((s, i) => s.classList.toggle('active', i === index));
  dots.forEach((d, i) => d.classList.toggle('active', i === index));
}

function updateRoundRoastCarousel(messages, startAutoAdvance) {
  if (roundRoastInterval) clearInterval(roundRoastInterval);
  roundRoastInterval = null;

  const container = document.getElementById('roundRoastCarousel');
  const slidesEl = document.getElementById('roundRoastSlides');
  const dotsEl = document.getElementById('roundRoastDots');
  if (!messages || messages.length === 0) {
    container.classList.remove('visible');
    return;
  }

  const classes = ['roast', 'roast', 'roast', 'brag'];
  slidesEl.innerHTML = messages.map((text, i) =>
    `<div class="round-roast-slide ${classes[i]}" data-index="${i}">${text}</div>`
  ).join('');
  dotsEl.innerHTML = messages.map((_, i) =>
    `<button type="button" class="round-roast-dot" aria-label="Slide ${i + 1}" onclick="setRoundRoastSlide(${i})"></button>`
  ).join('');

  container.classList.add('visible');
  setRoundRoastSlide(0);
  container.scrollIntoView({ behavior: 'smooth', block: 'center' });

  if (startAutoAdvance && messages.length > 1) {
    let idx = 0;
    roundRoastInterval = setInterval(() => {
      idx = (idx + 1) % messages.length;
      setRoundRoastSlide(idx);
    }, 3200);
  }
}

// ============ WALK OF SHAME ============
function getRoundLossCounts() {
  const losses = state.players.map(() => 0);
  state.rounds.forEach(round => {
    const maxScore = Math.max(...round);
    if (maxScore > 0) {
      round.forEach((s, i) => { if (s === maxScore) losses[i]++; });
    }
  });
  return state.players
    .map((p, i) => ({ idx: i, name: p.name, color: p.color, losses: losses[i] }))
    .filter(p => p.losses > 0)
    .sort((a, b) => b.losses - a.losses)
    .slice(0, 3);
}

function renderWalkOfShame() {
  const container = document.getElementById('walkOfShame');
  const list = document.getElementById('shameList');
  const shamers = getRoundLossCounts();
  if (shamers.length === 0) {
    container.classList.remove('visible');
    return;
  }
  container.classList.add('visible');
  const rankEmoji = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'];
  const isAsado = document.body.classList.contains('asado');
  list.innerHTML = shamers.map((p, i) => {
    const dot = isAsado ? `<span style="font-size:1rem;">${getAsadoEmoji(shamers[i].idx)}</span>` :
      `<div class="player-color" style="background:${p.color}"></div>`;
    return `<div class="shame-row">
      <div class="shame-rank">${rankEmoji[i] || (i+1)}</div>
      <div class="shame-name">${dot} ${p.name}</div>
      <div class="shame-badge">${p.losses} ${p.losses === 1 ? t('shame_round_lost') : t('shame_rounds_lost')}</div>
    </div>`;
  }).join('');
}

// ============ GAME ============
function getTotals() {
  return state.players.map((_, pi) =>
    state.rounds.reduce((sum, round) => sum + (round[pi] || 0), 0)
  );
}

function getLeaderIndex() {
  const totals = getTotals();
  let minIdx = 0;
  totals.forEach((t, i) => { if (t < totals[minIdx]) minIdx = i; });
  return minIdx;
}

function getMaxTotal() {
  return Math.max(...getTotals(), 0);
}

function renderGame() {
  const totals = getTotals();
  const roundNum = state.rounds.length + 1;

  document.getElementById('gameTitle').textContent = 'Lunes de UNO';
  document.getElementById('roundBadge').textContent = `${t('game_round')} ${roundNum}`;

  // Progress
  const maxT = getMaxTotal();
  const leaderIdx = totals.indexOf(Math.max(...totals));
  const pct = Math.min((maxT / state.maxPoints) * 100, 100);
  document.getElementById('progressLeader').textContent =
    maxT > 0 ? `${state.players[leaderIdx].name}: ${totals[leaderIdx]} ${t('game_pts')}` : t('game_no_scores');
  document.getElementById('progressText').textContent = `${maxT} / ${state.maxPoints}`;
  document.getElementById('progressFill').style.width = pct + '%';

  // Scoreboard
  renderScoreboard(totals);

  // Walk of Shame
  renderWalkOfShame();

  // Round inputs
  renderRoundInputs();

  // Round roast carousel (after each round)
  if (state.rounds.length > 0) {
    const messages = state.lastRoundRoastMessages || buildRoastMessages(state.rounds[state.rounds.length - 1]);
    if (!state.lastRoundRoastMessages) state.lastRoundRoastMessages = messages;
    updateRoundRoastCarousel(messages, state.justSubmittedRound === true);
    if (state.justSubmittedRound) state.justSubmittedRound = false;
  } else {
    document.getElementById('roundRoastCarousel').classList.remove('visible');
  }

  // Round history
  renderRoundHistory();
}

function renderScoreboard(totals) {
  const table = document.getElementById('scoreboard');
  let html = `<thead><tr><th>${t('game_player')}</th><th style="text-align:right;">${t('game_total')}</th></tr></thead><tbody>`;
  const sorted = state.players.map((p, i) => ({...p, idx: i, total: totals[i]}))
    .sort((a, b) => a.total - b.total);

  const isAsado = document.body.classList.contains('asado');
  sorted.forEach(p => {
    const overLimit = p.total >= state.maxPoints;
    const isLowest = p.total === sorted[0].total && state.rounds.length > 0;
    const dot = isAsado ? `<span style="font-size:1.1rem;">${getAsadoEmoji(p.idx)}</span>` :
      `<div class="player-color" style="background:${p.color}"></div>`;
    html += `<tr class="${isLowest && state.rounds.length > 0 ? 'winner-row' : ''}">
      <td><div class="player-name-cell">
        ${dot}
        ${p.name}
      </div></td>
      <td style="text-align:right;" class="total-cell ${overLimit ? 'over-limit' : ''}">${p.total}</td>
    </tr>`;
  });
  html += '</tbody>';
  table.innerHTML = html;
}

function renderRoundInputs() {
  if (state.gameOver) {
    document.getElementById('roundInputCard').style.display = 'none';
    return;
  }
  document.getElementById('roundInputCard').style.display = '';
  const container = document.getElementById('roundInputs');
  const isAsado = document.body.classList.contains('asado');
  let html = '';
  state.players.forEach((p, i) => {
    const dot = isAsado ? `<span style="font-size:1.1rem;">${getAsadoEmoji(i)}</span>` :
      `<div class="player-color" style="background:${p.color}"></div>`;
    html += `
      <div class="round-input-row">
        <div class="player-label">
          ${dot}
          ${p.name}
        </div>
        <input type="number" id="roundScore_${i}" placeholder="0" min="0">
      </div>`;
  });
  container.innerHTML = html;
}

function submitRound() {
  const scores = state.players.map((_, i) => {
    const val = parseInt(document.getElementById(`roundScore_${i}`).value) || 0;
    return Math.max(0, val);
  });

  if (scores.every(s => s === 0)) {
    alert(t('game_alert_no_scores'));
    return;
  }

  state.rounds.push(scores);
  state.currentRound = state.rounds.length;
  state.lastRoundRoastMessages = buildRoastMessages(scores);
  state.justSubmittedRound = true;

  const totals = getTotals();
  if (totals.some(t => t >= state.maxPoints)) {
    state.gameOver = true;
    showScreen('results');
    return;
  }

  renderGame();
}

function renderRoundHistory() {
  const container = document.getElementById('roundHistoryContainer');
  if (state.rounds.length === 0) {
    container.style.display = 'none';
    return;
  }
  container.style.display = '';

  const table = document.getElementById('roundHistoryTable');
  let html = `<thead><tr><th>${t('game_round')}</th>`;
  state.players.forEach(p => { html += `<th>${p.name}</th>`; });
  html += '<th class="no-print"></th></tr></thead><tbody>';

  state.rounds.forEach((round, ri) => {
    html += `<tr><td>R${ri + 1}</td>`;
    round.forEach(s => { html += `<td>${s}</td>`; });
    html += `<td class="edit-cell no-print" onclick="openEditModal(${ri})">${t('game_edit')}</td></tr>`;
  });

  const totals = getTotals();
  html += `<tr style="font-weight:700; background:var(--surface-2);"><td>${t('game_total')}</td>`;
  totals.forEach(t => { html += `<td>${t}</td>`; });
  html += '<td class="no-print"></td></tr>';

  html += '</tbody>';
  table.innerHTML = html;
}

// ============ EDIT MODAL ============
let editingRound = -1;

function openEditModal(roundIdx) {
  editingRound = roundIdx;
  document.getElementById('editModalTitle').textContent = `${t('modal_edit_round')} ${roundIdx + 1}`;
  const container = document.getElementById('editModalInputs');
  let html = '';
  state.players.forEach((p, i) => {
    html += `
      <div class="modal-input-row">
        <label>${p.name}</label>
        <input type="number" id="editScore_${i}" value="${state.rounds[roundIdx][i]}" min="0">
      </div>`;
  });
  container.innerHTML = html;
  document.getElementById('editModal').classList.add('active');
}

function closeEditModal() {
  document.getElementById('editModal').classList.remove('active');
  editingRound = -1;
}

function saveEditRound() {
  if (editingRound < 0) return;
  state.players.forEach((_, i) => {
    state.rounds[editingRound][i] = Math.max(0, parseInt(document.getElementById(`editScore_${i}`).value) || 0);
  });
  closeEditModal();

  const totals = getTotals();
  const wasOver = state.gameOver;
  state.gameOver = totals.some(t => t >= state.maxPoints);

  if (state.gameOver && document.getElementById('results').classList.contains('active')) {
    renderResults();
  } else if (state.gameOver && !wasOver) {
    showScreen('results');
  } else if (!state.gameOver && wasOver) {
    showScreen('game');
  } else {
    if (document.getElementById('game').classList.contains('active')) renderGame();
    if (document.getElementById('results').classList.contains('active')) renderResults();
  }
}

// ============ RESULTS ============
function renderResults() {
  const totals = getTotals();
  const standings = state.players.map((p, i) => ({...p, idx: i, total: totals[i]}))
    .sort((a, b) => a.total - b.total);

  document.getElementById('winnerName').textContent = standings[0].name;

  const container = document.getElementById('finalStandings');
  const medals = ['gold', 'silver', 'bronze'];
  const isAsado = document.body.classList.contains('asado');
  let html = '';
  standings.forEach((p, i) => {
    const dot = isAsado ? `<span style="font-size:1.1rem;">${getAsadoEmoji(p.idx)}</span>` :
      `<div class="player-color" style="background:${p.color}"></div>`;
    html += `
      <div class="standing-row">
        <div class="standing-position ${medals[i] || ''}">${i + 1}</div>
        <div class="standing-info">
          <div class="name" style="display:flex;align-items:center;gap:.4rem;">
            ${dot}
            ${p.name}
          </div>
        </div>
        <div class="standing-score">${p.total} ${t('game_pts')}</div>
      </div>`;
  });
  container.innerHTML = html;

  renderResultsHistory();
  renderWalkOfShame();
}

function getWalkOfShameData() {
  if (!state.players.length || !state.rounds.length) return null;
  const totals = getTotals();
  let lastIdx = 0;
  totals.forEach((t, i) => { if (t > totals[lastIdx]) lastIdx = i; });
  let worstPts = 0;
  let worstRound = -1;
  state.rounds.forEach((round, ri) => {
    const v = round[lastIdx] || 0;
    if (v > worstPts) {
      worstPts = v;
      worstRound = ri + 1;
    }
  });
  return {
    name: state.players[lastIdx].name,
    total: totals[lastIdx],
    worstPts,
    worstRound
  };
}

function renderWalkOfShame() {
  const card = document.getElementById('walkOfShameCard');
  if (!card) return;
  const data = getWalkOfShameData();
  if (!data) {
    card.style.display = 'none';
    return;
  }
  card.style.display = '';
  const titleEl = document.getElementById('walkTitle');
  const lineEl = document.getElementById('walkLine');
  const roundEl = document.getElementById('walkRound');
  titleEl.textContent = t('shame_title');
  lineEl.textContent = `${data.name} - ${data.total} ${t('game_pts')}`;
  if (data.worstRound > 0 && data.worstPts > 0) {
    const labelSing = t('shame_round_lost');
    const labelPlur = t('shame_rounds_lost');
    const label = data.worstPts === 1 ? labelSing : labelPlur;
    if (currentLang === 'es') {
      roundEl.textContent = `Peor ronda: R${data.worstRound} con ${data.worstPts} puntos (${label}).`;
    } else if (currentLang === 'pt') {
      roundEl.textContent = `Pior rodada: R${data.worstRound} com ${data.worstPts} pontos (${label}).`;
    } else if (currentLang === 'de') {
      roundEl.textContent = `Schlechteste Runde: R${data.worstRound} mit ${data.worstPts} Punkten (${label}).`;
    } else {
      roundEl.textContent = `Worst round: R${data.worstRound} with ${data.worstPts} points (${label}).`;
    }
  } else {
    roundEl.textContent = '';
  }
}

function renderResultsHistory() {
  const table = document.getElementById('resultsHistoryTable');
  let html = `<thead><tr><th>${t('game_round')}</th>`;
  state.players.forEach(p => { html += `<th>${p.name}</th>`; });
  html += '</tr></thead><tbody>';

  state.rounds.forEach((round, ri) => {
    html += `<tr><td>R${ri + 1}</td>`;
    round.forEach(s => { html += `<td>${s}</td>`; });
    html += '</tr>';
  });

  const totals = getTotals();
  html += `<tr style="font-weight:700; background:var(--surface-2);"><td>${t('game_total')}</td>`;
  totals.forEach(t => { html += `<td>${t}</td>`; });
  html += '</tr></tbody>';
  table.innerHTML = html;
}

function showEditableHistory() {
  const table = document.getElementById('resultsHistoryTable');
  let html = `<thead><tr><th>${t('game_round')}</th>`;
  state.players.forEach(p => { html += `<th>${p.name}</th>`; });
  html += '<th></th></tr></thead><tbody>';

  state.rounds.forEach((round, ri) => {
    html += `<tr><td>R${ri + 1}</td>`;
    round.forEach(s => { html += `<td>${s}</td>`; });
    html += `<td class="edit-cell" onclick="openEditModal(${ri})">${t('game_edit')}</td></tr>`;
  });

  const totals = getTotals();
  html += `<tr style="font-weight:700; background:var(--surface-2);"><td>${t('game_total')}</td>`;
  totals.forEach(t => { html += `<td>${t}</td>`; });
  html += '<td></td></tr></tbody>';
  table.innerHTML = html;
}

function printResults() {
  window.print();
}

function newGame() {
  state = {
    playerCount: 2, maxPoints: 500,
    players: [], rounds: [], currentRound: 0, gameOver: false
  };
  document.getElementById('playerCountDisplay').textContent = '2';
  showScreen('home');
}

function confirmQuit() {
  if (confirm(t('game_confirm_quit'))) {
    newGame();
  }
}

// ============ SHARE (beta): PDF roast ============
const PDF_ROASTS = {
  es: [
    'Â¡{name} se llevÃ³ todos los puntos a casa! ðŸ ðŸ“¦',
    '{name} jugÃ³ al "sumÃ¡ todo" en vez del UNO. ðŸ˜‚',
    'Alguien avÃ­sele a {name} que acÃ¡ gana el que tiene menos.',
    '{name}: el rey/la reina de los puntos. (Del malo.)',
  ],
  en: [
    '{name} took the whole pile home! ðŸ ðŸ“¦',
    '{name} was playing "add everything" instead of UNO. ðŸ˜‚',
    'Someone tell {name} the lowest score wins.',
    '{name}: royalty of points. (The bad kind.)',
  ],
  pt: [
    '{name} levou todos os pontos pra casa! ðŸ ðŸ“¦',
    '{name} estava jogando \"soma tudo\" em vez de UNO. ðŸ˜‚',
    'Avisem {name} que aqui ganha quem tem menos pontos.',
    '{name}: rei/rainha dos pontos (do jeito ruim).',
  ],
  de: [
    '{name} hat alle Punkte mit nach Hause genommen! ðŸ ðŸ“¦',
    '{name} hat wohl \"alles addieren\" statt UNO gespielt. ðŸ˜‚',
    'Sagt {name}, dass hier die niedrigste Punktzahl gewinnt.',
    '{name}: KÃ¶nig/in der Punkte (der schlechten Art).',
  ],
};

function downloadPDFRoast() {
  if (typeof jspdf === 'undefined') {
    alert('PDF library not loaded. Check your connection.');
    return;
  }
  var totals = getTotals();
  var standings = state.players.map(function (p, i) { return { name: p.name, total: totals[i], idx: i }; })
    .sort(function (a, b) { return a.total - b.total; });
  var lastPlace = standings[standings.length - 1];
  var lang = currentLang in PDF_ROASTS ? currentLang : 'es';
  var roast = PDF_ROASTS[lang][Math.floor(Math.random() * PDF_ROASTS[lang].length)].replace(/\{name\}/g, lastPlace.name);
  var shameBase;
  if (lang === 'es') {
    shameBase = `Paseo de la VergÃ¼enza: ${lastPlace.name} terminÃ³ Ãºltimo con ${lastPlace.total} pts.`;
  } else if (lang === 'pt') {
    shameBase = `Passeio da vergonha: ${lastPlace.name} ficou em Ãºltimo com ${lastPlace.total} pts.`;
  } else if (lang === 'de') {
    shameBase = `Gang der Schande: ${lastPlace.name} ist Letzter mit ${lastPlace.total} Pkt.`;
  } else {
    shameBase = `Walk of Shame: ${lastPlace.name} finished last with ${lastPlace.total} pts.`;
  }
  var roastBlock = shameBase + '\\n\\n' + roast;

  var doc = new jspdf.jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
  var w = doc.internal.pageSize.getWidth();
  var h = doc.internal.pageSize.getHeight();
  var margin = 18;
  var y = 0;

  // ---- Header: full-width UNO bar ----
  doc.setFillColor(237, 28, 36);
  doc.rect(0, 0, w, 24, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(26);
  doc.setFont('helvetica', 'bold');
  doc.text('LUNES DE UNO', w / 2, 14, { align: 'center' });
  doc.setFontSize(9);
  doc.setFont('helvetica', 'normal');
  doc.text(currentLang === 'es' ? 'Resultado final' : 'Final scores', w / 2, 21, { align: 'center' });
  y = 32;

  // ---- Standings card ----
  doc.setDrawColor(58, 58, 92);
  doc.setFillColor(26, 26, 46);
  doc.setLineWidth(0.5);
  doc.roundedRect(margin, y, w - 2 * margin, 8 + standings.length * 10, 4, 4, 'FD');
  doc.roundedRect(margin, y, w - 2 * margin, 8 + standings.length * 10, 4, 4, 'S');
  doc.setTextColor(240, 240, 245);
  doc.setFontSize(11);
  doc.setFont('helvetica', 'bold');
  doc.text(currentLang === 'es' ? 'PuntuaciÃ³n' : 'Scores', margin + 6, y + 7);
  y += 14;
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(11);
  standings.forEach(function (p, i) {
    var medal = i === 0 ? '\u{1F947} ' : i === 1 ? '\u{1F948} ' : i === 2 ? '\u{1F949} ' : (i + 1) + '. ';
    doc.text(medal + p.name + '  â€”  ' + p.total + ' ' + t('game_pts'), margin + 8, y);
    y += 10;
  });
  y += 16;

  // ---- Roast section: speech bubble ----
  var roastTitle = (currentLang === 'es' ? 'MenciÃ³n especial' : 'Special mention') + ' \u{1F602}';
  doc.setFont('helvetica', 'bold');
  doc.setFontSize(12);
  doc.setTextColor(255, 222, 0);
  doc.text(roastTitle, margin, y);
  y += 8;
  doc.setFont('helvetica', 'normal');
  var roastLines = doc.splitTextToSize(roastBlock, w - 2 * margin - 24);
  var bubbleH = Math.max(28, roastLines.length * 6 + 16);
  doc.setFillColor(255, 250, 235);
  doc.setDrawColor(255, 222, 0);
  doc.setLineWidth(1.2);
  doc.roundedRect(margin, y - 2, w - 2 * margin, bubbleH, 5, 5, 'FD');
  doc.roundedRect(margin, y - 2, w - 2 * margin, bubbleH, 5, 5, 'S');
  doc.setTextColor(140, 40, 50);
  doc.setFontSize(11);
  doc.text(roastLines, margin + 10, y + 10);
  y += bubbleH + 14;

  // ---- Footer ----
  doc.setTextColor(136, 136, 168);
  doc.setFontSize(8);
  doc.text('Lunes de UNO \u2014 ' + (currentLang === 'es' ? 'contador de puntos' : 'score tracker'), w / 2, h - 10, { align: 'center' });

  doc.save('LunesDeUNO-' + lastPlace.name.replace(/\s/g, '') + '.pdf');
}

// ============ SHARE (beta): Photo with scores ============
let sharePhotoState = { originalDataUrl: null };

function drawScoresOnCanvas(canvas, img) {
  const ctx = canvas.getContext('2d');
  const maxW = 400, maxH = 300;
  let w = img.width, h = img.height;
  if (w > maxW || h > maxH) {
    const r = Math.min(maxW / w, maxH / h);
    w = Math.round(w * r); h = Math.round(h * r);
  }
  canvas.width = w; canvas.height = h;
  ctx.drawImage(img, 0, 0, w, h);
  const totals = getTotals();
  const standings = state.players.map((p, i) => ({ ...p, total: totals[i] })).sort((a, b) => a.total - b.total);
  ctx.font = 'bold 14px Inter, sans-serif';
  ctx.fillStyle = 'rgba(0,0,0,0.7)';
  ctx.strokeStyle = 'rgba(255,255,255,0.9)';
  ctx.lineWidth = 2;
  let ty = 24;
  standings.forEach((p, i) => {
    const text = (i + 1) + '. ' + p.name + ' â€” ' + p.total + ' pts';
    ctx.strokeText(text, 10, ty);
    ctx.fillText(text, 10, ty);
    ty += 22;
  });
}

function onSharePhotoChange(ev) {
  const file = ev.target.files && ev.target.files[0];
  if (!file || !file.type.startsWith('image/')) return;
  // Clear previous preview so the UI always reflects the new upload
  sharePhotoState.originalDataUrl = null;
  var elOriginal = document.getElementById('sharePhotoOriginal');
  var row = document.getElementById('sharePhotoRow');
  var input = document.getElementById('sharePhotoInput');
  row.style.display = 'none';
  elOriginal.removeAttribute('src');
  var reader = new FileReader();
  reader.onload = function () {
    var img = new Image();
    img.onload = function () {
      var canvasOrig = document.createElement('canvas');
      drawScoresOnCanvas(canvasOrig, img);
      sharePhotoState.originalDataUrl = canvasOrig.toDataURL('image/png');
      elOriginal.src = sharePhotoState.originalDataUrl;
      row.style.display = 'flex';
      input.value = '';
    };
    img.src = reader.result;
  };
  reader.readAsDataURL(file);
}

function downloadShareImage(which) {
  const dataUrl = sharePhotoState.originalDataUrl;
  if (!dataUrl) return;
  const a = document.createElement('a');
  a.href = dataUrl;
  a.download = 'LunesDeUNO-' + which + '.png';
  a.click();
}

// ============ STATS (example data) ============
const EXAMPLE_STATS = {
  wins: [
    { name: 'Ana', wins: 4, badge: 'gold' },
    { name: 'Bruno', wins: 2, badge: 'silver' },
    { name: 'Cata', wins: 1, badge: 'bronze' },
    { name: 'Dani', wins: 0, badge: '' },
  ],
  biggestRound: [
    { name: 'Dani', round: 8, pts: 89 },
    { name: 'Bruno', round: 5, pts: 76 },
    { name: 'Cata', round: 3, pts: 72 },
    { name: 'Ana', round: 2, pts: 65 },
  ],
  mostRoasts: [
    { name: 'Dani', count: 5 },
    { name: 'Bruno', count: 3 },
    { name: 'Cata', count: 2 },
    { name: 'Ana', count: 0 },
  ],
};

function renderStats() {
  const container = document.getElementById('statsCard');
  const lang = currentLang;
  const winsLabel = t('stats_wins');
  const biggestLabel = t('stats_biggest_round');
  const roastsLabel = t('stats_most_roasts');
  let html = '';
  html += '<h3>' + winsLabel + '</h3><table class="stats-table"><thead><tr><th>' + (lang === 'es' ? 'Jugador' : 'Player') + '</th><th>' + (lang === 'es' ? 'Partidas ganadas' : 'Games won') + '</th></tr></thead><tbody>';
  EXAMPLE_STATS.wins.forEach(function (r) {
    html += '<tr><td>' + r.name + '</td><td><span class="stats-badge ' + r.badge + '">' + r.wins + '</span></td></tr>';
  });
  html += '</tbody></table>';
  html += '<h3 style="margin-top:1.25rem;">' + biggestLabel + '</h3><table class="stats-table"><thead><tr><th>' + (lang === 'es' ? 'Jugador' : 'Player') + '</th><th>' + (lang === 'es' ? 'Ronda' : 'Round') + '</th><th>Pts</th></tr></thead><tbody>';
  EXAMPLE_STATS.biggestRound.forEach(function (r) {
    html += '<tr><td>' + r.name + '</td><td>R' + r.round + '</td><td>' + r.pts + '</td></tr>';
  });
  html += '</tbody></table>';
  html += '<h3 style="margin-top:1.25rem;">' + roastsLabel + '</h3><table class="stats-table"><thead><tr><th>' + (lang === 'es' ? 'Jugador' : 'Player') + '</th><th>#</th></tr></thead><tbody>';
  EXAMPLE_STATS.mostRoasts.forEach(function (r) {
    html += '<tr><td>' + r.name + '</td><td>' + r.count + '</td></tr>';
  });
  html += '</tbody></table>';
  container.innerHTML = html;
  setTimeout(renderSufferingChart, 50);
}

// ============ +4 SOUND BOARD ============
let soundCtx = null;
let soundIndex = 0;

function playNextSound() {
  if (!soundCtx) soundCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (soundCtx.state === 'suspended') soundCtx.resume();
  const sounds = [playSadTrombone, playAirHorn, playDramaticSting, playFuneralMarch];
  sounds[soundIndex % sounds.length]();
  soundIndex++;
  const logo = document.querySelector('.header-logo svg');
  if (logo) { logo.classList.remove('hat-pulse'); void logo.offsetWidth; logo.classList.add('hat-pulse'); }
}

function playTone(freq, type, start, dur, gainVal) {
  const osc = soundCtx.createOscillator();
  const gain = soundCtx.createGain();
  osc.type = type; osc.frequency.value = freq;
  gain.gain.value = gainVal || 0.3;
  osc.connect(gain); gain.connect(soundCtx.destination);
  osc.start(soundCtx.currentTime + start);
  osc.stop(soundCtx.currentTime + start + dur);
  gain.gain.setValueAtTime(gainVal || 0.3, soundCtx.currentTime + start);
  gain.gain.exponentialRampToValueAtTime(0.001, soundCtx.currentTime + start + dur);
}

function playSadTrombone() {
  [293.66, 277.18, 261.63, 246.94].forEach((f, i) => playTone(f, 'sawtooth', i * 0.3, 0.3, 0.2));
}

function playAirHorn() {
  [200, 250, 200, 250].forEach((f, i) => playTone(f, 'sawtooth', i * 0.08, 0.12, 0.25));
  playTone(220, 'sawtooth', 0.32, 0.5, 0.3);
}

function playDramaticSting() {
  [440, 554, 659, 880].forEach((f, i) => playTone(f, 'square', i * 0.08, 0.15, 0.15));
  playTone(220, 'sawtooth', 0.4, 0.6, 0.2);
}

function playFuneralMarch() {
  const notes = [
    [261.63, 0, 0.5], [261.63, 0.5, 0.25], [261.63, 0.75, 0.25],
    [261.63, 1.0, 0.75], [311.13, 1.0, 0.75],
    [293.66, 1.75, 0.25], [293.66, 2.0, 0.25], [261.63, 2.25, 0.25],
    [261.63, 2.5, 0.5], [246.94, 2.5, 0.5]
  ];
  notes.forEach(([f, s, d]) => playTone(f, 'triangle', s, d, 0.2));
}

// ============ MANDALE AL GRUPO ============
function copyToClipboard() {
  const totals = getTotals();
  const standings = state.players.map((p, i) => ({ ...p, total: totals[i], idx: i }))
    .sort((a, b) => a.total - b.total);
  const isAsado = document.body.classList.contains('asado');
  const header = isAsado ? 'ðŸ¥©ðŸ”¥ LUNES DE UNO â€” EDICIÃ“N ASADO ðŸ”¥ðŸ¥©' : 'ðŸƒ LUNES DE UNO ðŸƒ';
  const posEmojis = ['ðŸ†', 'ðŸ˜', 'ðŸ˜¬', 'ðŸ« ', 'ðŸ’€'];
  const posQuips = currentLang === 'es'
    ? ['Â¡CRACK!', 'zafÃ³', 'meh', 'ojo...', 'F']
    : ['CHAMP!', 'survived', 'meh', 'yikes...', 'F'];
  let lines = [header, ''];
  standings.forEach((p, i) => {
    const emoji = i === 0 ? posEmojis[0] : i === standings.length - 1 ? 'ðŸ’€' : (posEmojis[Math.min(i, 4)]);
    const quip = i === 0 ? posQuips[0] : i === standings.length - 1 ? posQuips[4] : (posQuips[Math.min(i, 4)]);
    lines.push(`${emoji} ${p.name}: ${p.total} pts â€” ${quip}`);
  });
  lines.push('');
  lines.push(`ðŸ“Š ${state.rounds.length} ${currentLang === 'es' ? 'rondas' : 'rounds'} Â· ${currentLang === 'es' ? 'lÃ­mite' : 'limit'} ${state.maxPoints}`);
  const lastPlace = standings[standings.length - 1];
  const closers = currentLang === 'es'
    ? [`Bo ${lastPlace.name}, dejÃ¡ el UNO y jugÃ¡ al dominÃ³ ðŸ˜‚`, `${lastPlace.name} se llevÃ³ todos los puntos a casa ðŸ `, `Alguien avÃ­sele a ${lastPlace.name} que acÃ¡ gana el que tiene menos ðŸ’€`]
    : [`${lastPlace.name}, maybe try checkers instead ðŸ˜‚`, `${lastPlace.name} took the whole pile home ðŸ `, `Someone tell ${lastPlace.name} the lowest score wins ðŸ’€`];
  lines.push(closers[Math.floor(Math.random() * closers.length)]);
  const text = lines.join('\n');
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => showCopyToast());
  } else {
    const ta = document.createElement('textarea');
    ta.value = text; ta.style.position = 'fixed'; ta.style.opacity = '0';
    document.body.appendChild(ta); ta.select(); document.execCommand('copy');
    document.body.removeChild(ta); showCopyToast();
  }
}

function showCopyToast() {
  const toast = document.getElementById('copyToast');
  toast.textContent = t('share_copied');
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2000);
}

// ============ CERTIFICADO DE DESASTRE ============
const CERT_ROASTS = {
  es: [
    '{name} ha demostrado un nivel excepcional de acumulaciÃ³n de puntos, superando toda expectativa razonable.',
    'Se certifica que {name} no tiene la mÃ¡s mÃ­nima idea de cÃ³mo funciona el UNO, pero pone mucha onda.',
    '{name} batiÃ³ rÃ©cords de puntos que nadie querÃ­a batir. Un verdadero campeÃ³n del desastre.',
    'Con {total} puntos, {name} se convierte en leyenda. Del tipo que nadie quiere ser.',
  ],
  en: [
    '{name} has demonstrated an exceptional level of point accumulation, surpassing all reasonable expectations.',
    'It is certified that {name} has absolutely no clue how UNO works, but tries really hard.',
    '{name} broke records that nobody wanted broken. A true champion of disaster.',
    'With {total} points, {name} becomes a legend. The kind nobody wants to be.',
  ],
};

function downloadCertificado() {
  if (typeof jspdf === 'undefined') { alert('PDF library not loaded.'); return; }
  const totals = getTotals();
  const standings = state.players.map((p, i) => ({ name: p.name, total: totals[i], idx: i }))
    .sort((a, b) => a.total - b.total);
  const lastPlace = standings[standings.length - 1];
  const lang = currentLang in CERT_ROASTS ? currentLang : 'es';
  const roast = CERT_ROASTS[lang][Math.floor(Math.random() * CERT_ROASTS[lang].length)]
    .replace(/\{name\}/g, lastPlace.name).replace(/\{total\}/g, lastPlace.total);
  const serialNum = 'CERT-' + Math.random().toString(16).substr(2, 6).toUpperCase();
  const dateStr = new Date().toLocaleDateString(lang === 'es' ? 'es-UY' : 'en-US', { year: 'numeric', month: 'long', day: 'numeric' });

  const doc = new jspdf.jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
  const w = doc.internal.pageSize.getWidth();
  const h = doc.internal.pageSize.getHeight();

  // Background
  doc.setFillColor(15, 15, 26);
  doc.rect(0, 0, w, h, 'F');

  // Decorative double border
  doc.setDrawColor(237, 28, 36); doc.setLineWidth(3);
  doc.rect(8, 8, w - 16, h - 16);
  doc.setDrawColor(255, 222, 0); doc.setLineWidth(1.5);
  doc.rect(13, 13, w - 26, h - 26);

  // Corner decorations
  const corners = [[18, 18], [w - 23, 18], [18, h - 23], [w - 23, h - 23]];
  doc.setFillColor(255, 222, 0);
  corners.forEach(([cx, cy]) => { doc.circle(cx, cy, 3, 'F'); });

  // Header
  doc.setTextColor(255, 222, 0);
  doc.setFontSize(10); doc.setFont('helvetica', 'normal');
  doc.text(lang === 'es' ? 'ASOCIACIÃ“N URUGUAYA DE PERDEDORES' : 'INTERNATIONAL LOSERS ASSOCIATION', w / 2, 28, { align: 'center' });

  doc.setTextColor(237, 28, 36);
  doc.setFontSize(36); doc.setFont('helvetica', 'bold');
  doc.text(lang === 'es' ? 'CERTIFICADO DE DESASTRE' : 'CERTIFICATE OF DISASTER', w / 2, 45, { align: 'center' });

  // Subtitle
  doc.setTextColor(136, 136, 168);
  doc.setFontSize(11); doc.setFont('helvetica', 'normal');
  doc.text(lang === 'es' ? 'Se certifica por la presente que' : 'This is to certify that', w / 2, 58, { align: 'center' });

  // Player name
  doc.setTextColor(255, 222, 0);
  doc.setFontSize(32); doc.setFont('helvetica', 'bold');
  doc.text(lastPlace.name, w / 2, 74, { align: 'center' });

  // Score
  doc.setTextColor(255, 77, 106);
  doc.setFontSize(14); doc.setFont('helvetica', 'normal');
  doc.text(lastPlace.total + ' ' + t('game_pts'), w / 2, 83, { align: 'center' });

  // Roast text in a bubble
  doc.setFillColor(26, 26, 46);
  doc.setDrawColor(90, 90, 140);
  doc.setLineWidth(0.5);
  const roastLines = doc.splitTextToSize(roast, w - 80);
  const bubbleH = Math.max(20, roastLines.length * 6 + 12);
  doc.roundedRect(35, 90, w - 70, bubbleH, 4, 4, 'FD');
  doc.setTextColor(240, 240, 245);
  doc.setFontSize(11);
  doc.text(roastLines, w / 2, 99, { align: 'center' });

  // Standings mini-table
  let sy = 90 + bubbleH + 12;
  doc.setTextColor(136, 136, 168);
  doc.setFontSize(9); doc.setFont('helvetica', 'bold');
  doc.text(lang === 'es' ? 'CLASIFICACIÃ“N FINAL' : 'FINAL STANDINGS', w / 2, sy, { align: 'center' });
  sy += 6;
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(10);
  standings.forEach((p, i) => {
    const medal = i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : i === 2 ? 'ðŸ¥‰' : (i + 1) + '.';
    doc.setTextColor(i === standings.length - 1 ? 255 : 200, i === standings.length - 1 ? 77 : 200, i === standings.length - 1 ? 106 : 200);
    doc.text(`${medal}  ${p.name}  â€”  ${p.total} pts`, w / 2, sy, { align: 'center' });
    sy += 6;
  });

  // Wax seal
  const sealX = w - 50, sealY = h - 45;
  doc.setFillColor(200, 30, 30);
  doc.circle(sealX, sealY, 14, 'F');
  doc.setFillColor(180, 20, 20);
  doc.circle(sealX, sealY, 11, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(7); doc.setFont('helvetica', 'bold');
  doc.text('VERIFICADO', sealX, sealY - 2, { align: 'center' });
  doc.setFontSize(5);
  doc.text('LUNES DE UNO', sealX, sealY + 3, { align: 'center' });

  // Signature
  doc.setDrawColor(136, 136, 168);
  doc.setLineWidth(0.3);
  doc.line(40, h - 35, 110, h - 35);
  doc.setTextColor(136, 136, 168);
  doc.setFontSize(8); doc.setFont('helvetica', 'normal');
  doc.text(lang === 'es' ? 'El Presidente del UNO' : 'The President of UNO', 75, h - 31, { align: 'center' });

  // Serial & date
  doc.setTextColor(90, 90, 140);
  doc.setFontSize(7);
  doc.text(serialNum, 20, h - 14);
  doc.text(dateStr, w - 20, h - 14, { align: 'right' });

  doc.save('CertificadoDeDesastre-' + lastPlace.name.replace(/\s/g, '') + '.pdf');
}

// ============ LÃNEA DE SUFRIMIENTO ============
const EXAMPLE_ROUNDS = [
  [15, 45, 30, 60],
  [20, 10, 55, 40],
  [35, 25, 10, 50],
  [10, 55, 40, 20],
  [25, 30, 15, 45],
  [40, 20, 35, 55],
  [5, 35, 50, 30],
  [30, 15, 25, 89],
];
const EXAMPLE_PLAYERS = [
  { name: 'Ana', color: '#ED1C24' },
  { name: 'Bruno', color: '#FFDE00' },
  { name: 'Cata', color: '#00A651' },
  { name: 'Dani', color: '#0072BC' },
];

const SUFFERING_ANNOTATIONS = {
  es: ['AcÃ¡ se pudriÃ³ todo', 'El +4 legendario', 'Momento de silencio'],
  en: ['Everything went wrong here', 'The legendary +4', 'Moment of silence'],
};

function renderSufferingChart() {
  const canvas = document.getElementById('sufferingChart');
  if (!canvas) return;
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.parentElement.getBoundingClientRect();
  const W = Math.max(rect.width - 32, 300);
  const H = 260;
  canvas.width = W * dpr; canvas.height = H * dpr;
  canvas.style.width = W + 'px'; canvas.style.height = H + 'px';
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);

  const cumulative = EXAMPLE_PLAYERS.map((_, pi) => {
    let sum = 0;
    return [0, ...EXAMPLE_ROUNDS.map(r => (sum += r[pi]))];
  });
  const maxVal = Math.max(...cumulative.flat());
  const padL = 55, padR = 20, padT = 20, padB = 35;
  const chartW = W - padL - padR, chartH = H - padT - padB;
  const numRounds = EXAMPLE_ROUNDS.length;
  const stepX = chartW / numRounds;

  // Grid
  ctx.strokeStyle = 'rgba(136,136,168,0.15)'; ctx.lineWidth = 1;
  for (let i = 0; i <= 5; i++) {
    const y = padT + (chartH / 5) * i;
    ctx.beginPath(); ctx.moveTo(padL, y); ctx.lineTo(padL + chartW, y); ctx.stroke();
    ctx.fillStyle = '#8888a8'; ctx.font = '10px Inter, sans-serif'; ctx.textAlign = 'right';
    ctx.fillText(Math.round(maxVal - (maxVal / 5) * i), padL - 6, y + 4);
  }

  // Y-axis label
  ctx.save(); ctx.translate(12, padT + chartH / 2);
  ctx.rotate(-Math.PI / 2); ctx.fillStyle = '#ff4d6a'; ctx.font = 'bold 10px Inter, sans-serif';
  ctx.textAlign = 'center'; ctx.fillText(t('stats_suffering_yaxis'), 0, 0); ctx.restore();

  // X-axis labels
  ctx.fillStyle = '#8888a8'; ctx.font = '10px Inter, sans-serif'; ctx.textAlign = 'center';
  for (let r = 0; r <= numRounds; r++) {
    const x = padL + stepX * r;
    ctx.fillText(r === 0 ? '0' : 'R' + r, x, H - padB + 16);
  }

  // Lines
  cumulative.forEach((data, pi) => {
    ctx.strokeStyle = EXAMPLE_PLAYERS[pi].color;
    ctx.lineWidth = 2.5; ctx.lineJoin = 'round';
    ctx.beginPath();
    data.forEach((val, ri) => {
      const x = padL + stepX * ri;
      const y = padT + chartH - (val / maxVal) * chartH;
      if (ri === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
    });
    ctx.stroke();

    // Points
    data.forEach((val, ri) => {
      const x = padL + stepX * ri;
      const y = padT + chartH - (val / maxVal) * chartH;
      ctx.fillStyle = EXAMPLE_PLAYERS[pi].color;
      ctx.beginPath(); ctx.arc(x, y, 3.5, 0, Math.PI * 2); ctx.fill();
    });
  });

  // Annotations
  const lang = currentLang in SUFFERING_ANNOTATIONS ? currentLang : 'es';
  const annots = SUFFERING_ANNOTATIONS[lang];
  ctx.font = 'bold 9px Inter, sans-serif'; ctx.textAlign = 'left';

  // Biggest single jump for Dani (round 8: 89pts)
  const annotX1 = padL + stepX * 8;
  const annotY1 = padT + chartH - (cumulative[3][8] / maxVal) * chartH;
  ctx.fillStyle = '#ff4d6a';
  ctx.fillText(annots[0], annotX1 - 60, annotY1 - 10);

  // Biggest single round for Bruno (round 4: 55pts)
  const annotX2 = padL + stepX * 4;
  const annotY2 = padT + chartH - (cumulative[1][4] / maxVal) * chartH;
  ctx.fillStyle = '#ffde00';
  ctx.fillText(annots[1], annotX2 + 6, annotY2 - 6);

  // Ana's low round (round 7: 5pts)
  const annotX3 = padL + stepX * 7;
  const annotY3 = padT + chartH - (cumulative[0][7] / maxVal) * chartH;
  ctx.fillStyle = '#4dff91';
  ctx.fillText(annots[2], annotX3 - 80, annotY3 + 14);

  // Legend
  const legendEl = document.getElementById('chartLegend');
  if (legendEl) {
    legendEl.innerHTML = EXAMPLE_PLAYERS.map(p =>
      `<span class="chart-legend-item"><span class="chart-legend-dot" style="background:${p.color}"></span>${p.name}</span>`
    ).join('');
  }
}

// ============ MODO ASADO ============
const ASADO_EMOJIS = ['ðŸ¥©', 'ðŸ–', 'ðŸŒ­', 'ðŸ«’', 'ðŸ”¥', 'ðŸ§…', 'ðŸ«‘', 'ðŸ§„', 'ðŸž', 'ðŸŒ¶ï¸'];

const ASADO_CAROUSEL_MSGS = {
  es: {
    last: [
      '{name} estÃ¡ mÃ¡s quemado que la tira de asado que nadie querÃ­a ðŸ”¥',
      '{name} juntÃ³ mÃ¡s puntos que sal tiene el vacÃ­o, bo.',
      'A {name} le faltÃ³ vuelta y vuelta, se carbonizÃ³ esta ronda.',
      '{name} se pasÃ³ de cocciÃ³n, ta hecho carbÃ³n.',
      'Pa, {name}, mÃ¡s quemado que chorizo olvidado en la parrilla.',
    ],
    secondLast: [
      '{name} quedÃ³ a punto, casi se pasa de cocciÃ³n.',
      '{name} estÃ¡ jugoso todavÃ­a, pero ojo con la prÃ³xima vuelta.',
    ],
    first: [
      '{name} saliÃ³ al punto justo, tÃ©rmino medio perfecto ðŸ¥©',
      '{name} es el asador de esta mesa, tremendo nivel.',
      'Esta ronda {name} la clavÃ³ como un buen vacÃ­o a la brasa.',
    ],
  },
  en: {
    last: [
      '{name} is more burnt than forgotten ribs on the grill ðŸ”¥',
      '{name} collected more points than salt on a steak.',
      '{name} forgot to flip and got charred this round.',
      '{name} is well-done. Way too well-done.',
      '{name} got roasted harder than the sausages.',
    ],
    secondLast: [
      '{name} is medium-rare, almost overcooked.',
      '{name} is still juicy, but watch out next round.',
    ],
    first: [
      '{name} came out medium-rare perfection ðŸ¥©',
      '{name} is the grill master of this table.',
      '{name} nailed it like a perfect cut on the BBQ.',
    ],
  },
};

let asadoMode = false;
let originalCarouselMsgs = null;
let meatInterval = null;
const ASADO_IMAGES = [
  'assets/image-9bf8c041-0dcc-4664-a43d-b08c00b056a6.png',
  'assets/image-f89188ae-0fab-4b0d-906f-3d074070604c.png',
  'assets/image-9f0bc4e9-7a6e-4737-8f3d-94efcbed10d2.png',
  'assets/image-6203ef81-62d7-487c-9967-86da2115146f.png',
  'assets/image-93c33789-9afd-43c2-b3e3-1c1bc4fc3b59.png',
  'assets/image-806503c2-fa15-447a-8ca7-6cbcccb02136.png',
  'assets/image-3683c8ad-4a76-418c-ab0e-1bbbc360b46e.png',
];

function spawnFlyingMeat() {
  const el = document.createElement('img');
  el.className = 'flying-meat';
  const src = ASADO_IMAGES[Math.floor(Math.random() * ASADO_IMAGES.length)];
  el.src = src;
  const side = Math.floor(Math.random() * 4);
  let startX, startY, endX, endY;
  const W = window.innerWidth, H = window.innerHeight;
  if (side === 0) { startX = -40; startY = Math.random() * H; endX = W + 60; endY = Math.random() * H; }
  else if (side === 1) { startX = W + 40; startY = Math.random() * H; endX = -60; endY = Math.random() * H; }
  else if (side === 2) { startX = Math.random() * W; startY = -40; endX = Math.random() * W; endY = H + 60; }
  else { startX = Math.random() * W; startY = H + 40; endX = Math.random() * W; endY = -60; }
  const dur = 4 + Math.random() * 5;
  const spin = 360 + Math.random() * 720;
  const size = 1.2 + Math.random() * 1.5;
  el.style.setProperty('--start-x', startX + 'px');
  el.style.setProperty('--start-y', startY + 'px');
  el.style.setProperty('--end-x', endX + 'px');
  el.style.setProperty('--end-y', endY + 'px');
  el.style.setProperty('--fly-dur', dur + 's');
  el.style.setProperty('--spin', spin + 'deg');
  el.style.fontSize = size + 'rem';
  el.style.top = '0';
  el.style.left = '0';
  document.body.appendChild(el);
  setTimeout(() => el.remove(), dur * 1000 + 200);
}

function startMeatRain() {
  if (meatInterval) return;
  meatInterval = setInterval(spawnFlyingMeat, 800);
}

function stopMeatRain() {
  if (meatInterval) { clearInterval(meatInterval); meatInterval = null; }
  document.querySelectorAll('.flying-meat').forEach(el => el.remove());
}

function getAsadoEmoji(playerIdx) {
  return ASADO_EMOJIS[playerIdx % ASADO_EMOJIS.length];
}

function toggleAsado() {
  asadoMode = document.getElementById('asadoToggle').checked;
  localStorage.setItem('lunesdeuno_asado', asadoMode ? 'on' : 'off');
  applyAsadoMode();
}

function applyAsadoMode() {
  if (asadoMode) {
    document.body.classList.add('asado');
    if (!originalCarouselMsgs) originalCarouselMsgs = JSON.parse(JSON.stringify(CAROUSEL_MSGS));
    Object.keys(ASADO_CAROUSEL_MSGS).forEach(lang => {
      CAROUSEL_MSGS[lang] = ASADO_CAROUSEL_MSGS[lang];
    });
    startMeatRain();
  } else {
    document.body.classList.remove('asado');
    if (originalCarouselMsgs) {
      Object.keys(originalCarouselMsgs).forEach(lang => {
        CAROUSEL_MSGS[lang] = originalCarouselMsgs[lang];
      });
    }
    stopMeatRain();
  }
  if (document.getElementById('game').classList.contains('active')) renderGame();
  if (document.getElementById('results').classList.contains('active')) renderResults();
}

// ============ INIT ============
// Asado mode starts OFF by default; we only store the last choice for future use.
asadoMode = false;
const asadoToggleEl = document.getElementById('asadoToggle');
if (asadoToggleEl) asadoToggleEl.checked = false;

setLang(currentLang);
initSetup();
</script>
</body>
</html>
