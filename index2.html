<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lunes de UNO (beta)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --uno-red: #ED1C24;
      --uno-yellow: #FFDE00;
      --uno-green: #00A651;
      --uno-blue: #0072BC;
      --bg: #0f0f1a;
      --surface: #1a1a2e;
      --surface-2: #242442;
      --surface-3: #2e2e50;
      --text: #f0f0f5;
      --text-muted: #8888a8;
      --border: #3a3a5c;
      --danger: #ff4d6a;
      --success: #4dff91;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ---- Header (logo + flags) ---- */
    .app-header {
      position: fixed; top: 0; left: 0; right: 0; z-index: 200;
      height: 52px;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 1rem;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }
    .header-logo {
      display: flex; align-items: center; gap: .5rem;
      text-decoration: none; color: var(--text);
    }
    .header-logo svg {
      width: 36px; height: 36px;
      display: block;
    }
    .lang-switcher {
      display: flex; gap: .4rem;
    }
    .lang-btn {
      width: 40px; height: 28px; border-radius: 6px; cursor: pointer;
      border: 2px solid transparent; overflow: hidden;
      transition: all .2s; opacity: .55;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.35rem; line-height: 1;
      background: var(--surface-2);
    }
    .lang-btn:hover { opacity: .85; }
    .lang-btn.active { opacity: 1; border-color: var(--uno-yellow); box-shadow: 0 2px 12px rgba(255,222,0,.25); }

    @media print { .app-header { display: none !important; } .round-roast { display: none !important; } }

    /* ---- Shared Layout ---- */
    .screen {
      display: none;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 2rem 1rem;
      animation: fadeIn .35s ease;
    }
    .screen.active { display: flex; }
    .screen { padding-top: calc(52px + 2rem); }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    h1, h2, h3, h4 { font-family: 'Fredoka One', cursive; letter-spacing: .02em; }

    /* ---- Buttons ---- */
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: .5rem;
      border: none; border-radius: 14px; cursor: pointer;
      font-family: 'Inter', sans-serif; font-weight: 600;
      transition: all .2s ease;
    }
    .btn:active { transform: scale(.97); }
    .btn:disabled { opacity: .35; cursor: not-allowed; transform: none; }

    .btn-primary {
      background: linear-gradient(135deg, var(--uno-red), #ff4060);
      color: #fff; font-size: 1.15rem; padding: 1rem 2.5rem;
      box-shadow: 0 6px 24px rgba(237,28,36,.35);
    }
    .btn-primary:hover:not(:disabled) { box-shadow: 0 8px 32px rgba(237,28,36,.5); transform: translateY(-2px); }

    .btn-secondary {
      background: var(--surface-2); color: var(--text);
      font-size: .95rem; padding: .75rem 1.5rem; border: 1px solid var(--border);
    }
    .btn-secondary:hover:not(:disabled) { background: var(--surface-3); }

    .btn-small {
      font-size: .8rem; padding: .45rem 1rem; border-radius: 8px;
    }

    .btn-icon {
      width: 38px; height: 38px; padding: 0; border-radius: 10px;
      background: var(--surface-2); color: var(--text); border: 1px solid var(--border);
      font-size: 1.1rem;
    }

    /* ---- Cards ---- */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1.5rem;
      width: 100%;
      max-width: 480px;
    }

    /* ---- Inputs ---- */
    .input-group { display: flex; flex-direction: column; gap: .4rem; }
    .input-group label { font-size: .85rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: .06em; }

    input[type="text"], input[type="number"], select {
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-size: 1rem;
      padding: .7rem 1rem;
      outline: none;
      transition: border-color .2s;
      width: 100%;
    }
    input:focus, select:focus { border-color: var(--uno-blue); }
    input[type="number"] { -moz-appearance: textfield; }
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; }

    /* ---- HOME SCREEN ---- */
    #home { justify-content: center; gap: 2.5rem; text-align: center; }
    .logo-title {
      font-size: 3.2rem;
      background: linear-gradient(135deg, var(--uno-red), var(--uno-yellow), var(--uno-green), var(--uno-blue));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text;
      filter: drop-shadow(0 2px 12px rgba(237,28,36,.3));
    }
    .logo-sub { color: var(--text-muted); font-size: 1rem; margin-top: .5rem; }

    .home-beta-links { margin-top: 2rem; display: flex; align-items: center; justify-content: center; gap: .5rem; flex-wrap: wrap; font-size: .85rem; }
    .home-beta-links .under-construction {
      font-size: .85rem; color: var(--text-muted);
      text-decoration: none; border-bottom: 1px dashed var(--border);
    }
    .home-beta-links .under-construction:hover { color: var(--uno-yellow); }
    .home-beta-links .beta-sep { color: var(--border); }
    /* Share (beta) */
    .share-card { margin-top: 1rem; }
    .share-card h4 { margin-bottom: .75rem; font-size: 1rem; color: var(--text-muted); }
    .share-actions { display: flex; flex-direction: column; gap: .75rem; }
    .share-photo-row { display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-start; justify-content: center; margin-top: .5rem; }
    .share-photo-box { text-align: center; max-width: 220px; }
    .share-photo-box img { width: 100%; border-radius: 12px; border: 2px solid var(--border); display: block; }
    .share-photo-box .share-photo-label { font-size: .75rem; color: var(--text-muted); margin-top: .35rem; }
    .share-photo-box .btn-small { margin-top: .5rem; }
    .photo-upload-wrap { margin: .5rem 0; }
    .photo-upload-wrap input[type="file"] { font-size: .85rem; color: var(--text); }
    /* Stats example */
    #stats { gap: 1.25rem; padding-top: 2rem; }
    .stats-card { max-width: 520px; }
    .stats-card h3 { font-size: 1.1rem; margin-bottom: .75rem; color: var(--uno-yellow); }
    .stats-table { width: 100%; border-collapse: collapse; font-size: .9rem; }
    .stats-table th, .stats-table td { padding: .5rem .6rem; text-align: left; border-bottom: 1px solid var(--border); }
    .stats-table th { color: var(--text-muted); font-weight: 600; font-size: .75rem; text-transform: uppercase; }
    .stats-badge { display: inline-block; padding: .2rem .5rem; border-radius: 8px; font-size: .8rem; font-weight: 600; }
    .stats-badge.gold { background: rgba(255,222,0,.2); color: var(--uno-yellow); }
    .stats-badge.silver { background: rgba(192,192,192,.2); color: #c0c0c0; }
    .stats-badge.bronze { background: rgba(205,127,50,.2); color: #cd7f32; }
    .stats-example-note { font-size: .8rem; color: var(--text-muted); margin-top: 1rem; }

    .uno-cards {
      display: flex; gap: .6rem; justify-content: center; margin-bottom: .5rem;
    }
    .uno-card-mini {
      width: 48px; height: 70px; border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-family: 'Fredoka One', cursive; font-size: 1.1rem; font-weight: bold; color: #fff;
      box-shadow: 0 4px 16px rgba(0,0,0,.35);
      transform: rotate(var(--rot, 0deg));
      background: #1a1a1a;
      border: 2px solid #333;
      position: relative;
      overflow: hidden;
    }
    .uno-card-mini::before {
      content: ''; position: absolute; inset: 0;
      background: linear-gradient(135deg,
        var(--uno-red) 0 25%, var(--uno-yellow) 25% 50%,
        var(--uno-green) 50% 75%, var(--uno-blue) 75% 100%);
      opacity: .35;
      border-radius: 6px;
    }
    .uno-card-mini span { position: relative; z-index: 1; text-shadow: 0 1px 2px rgba(0,0,0,.8); }

    /* ---- SETUP SCREEN ---- */
    #setup { gap: 1.5rem; padding-top: 3rem; }
    #setup .card + .card { margin-top: 0; }

    .player-inputs { display: flex; flex-direction: column; gap: .75rem; margin-top: .75rem; }
    .player-input-row {
      display: flex; align-items: center; gap: .5rem;
    }
    .player-color {
      width: 14px; height: 14px; border-radius: 50%; flex-shrink: 0;
    }
    .player-input-row input { flex: 1; }

    .points-presets {
      display: flex; flex-wrap: wrap; gap: .5rem; margin-top: .75rem;
    }
    .preset-btn {
      padding: .5rem 1rem; border-radius: 10px; border: 1px solid var(--border);
      background: var(--surface-2); color: var(--text); cursor: pointer;
      font-family: 'Inter', sans-serif; font-size: .9rem; font-weight: 500;
      transition: all .2s;
    }
    .preset-btn:hover, .preset-btn.selected {
      border-color: var(--uno-yellow); background: rgba(255,222,0,.12); color: var(--uno-yellow);
    }

    .setup-footer { margin-top: .5rem; }

    /* Number selector */
    .number-selector {
      display: flex; align-items: center; gap: 1rem; margin-top: .75rem;
    }
    .number-display {
      font-family: 'Fredoka One', cursive; font-size: 2.2rem;
      width: 60px; text-align: center; color: var(--uno-yellow);
    }

    /* ---- GAME SCREEN ---- */
    #game { gap: 1.25rem; padding-top: 2rem; }

    .game-header {
      display: flex; align-items: center; justify-content: space-between;
      width: 100%; max-width: 480px;
    }
    .game-header h2 { font-size: 1.4rem; }

    .round-badge {
      background: var(--uno-blue); color: #fff;
      padding: .3rem .9rem; border-radius: 20px;
      font-size: .85rem; font-weight: 600;
    }

    .scoreboard {
      width: 100%; max-width: 480px;
      border-collapse: separate;
      border-spacing: 0;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
    }
    .scoreboard th, .scoreboard td {
      padding: .65rem .75rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    .scoreboard th {
      background: var(--surface-2);
      font-size: .75rem;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: var(--text-muted);
      font-weight: 600;
    }
    .scoreboard tr:last-child td { border-bottom: none; }
    .scoreboard .player-name-cell {
      display: flex; align-items: center; gap: .5rem; font-weight: 600;
    }
    .scoreboard .total-cell {
      font-family: 'Fredoka One', cursive;
      font-size: 1.1rem;
    }
    .scoreboard .over-limit { color: var(--danger); }
    .scoreboard .winner-row { background: rgba(77, 255, 145, .08); }

    .round-inputs { display: flex; flex-direction: column; gap: .65rem; }
    .round-input-row {
      display: flex; align-items: center; gap: .75rem;
    }
    .round-input-row .player-label {
      display: flex; align-items: center; gap: .5rem;
      font-weight: 600; font-size: .95rem;
      min-width: 120px;
    }
    .round-input-row input {
      width: 90px; text-align: center;
      font-size: 1.1rem; font-weight: 600;
      padding: .6rem .5rem;
    }

    .game-actions {
      display: flex; gap: .75rem; flex-wrap: wrap; justify-content: center;
    }

    /* Progress bar */
    .progress-container { width: 100%; max-width: 480px; }
    .progress-label {
      display: flex; justify-content: space-between;
      font-size: .8rem; color: var(--text-muted); margin-bottom: .35rem;
    }
    .progress-bar {
      height: 6px; background: var(--surface-2); border-radius: 3px; overflow: hidden;
    }
    .progress-fill {
      height: 100%; border-radius: 3px;
      transition: width .4s ease;
      background: linear-gradient(90deg, var(--uno-green), var(--uno-yellow), var(--uno-red));
    }

    /* Round history */
    .round-history {
      width: 100%; max-width: 480px;
    }
    /* Round roast carousel */
    .round-roast {
      width: 100%; max-width: 480px;
      display: none;
      flex-direction: column;
      gap: .5rem;
    }
    .round-roast.visible { display: flex; }
    .round-roast-slides {
      min-height: 80px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
    }
    .round-roast-slide {
      display: none;
      padding: 1rem 1.25rem;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: .95rem;
      line-height: 1.4;
      min-height: 80px;
      box-sizing: border-box;
    }
    .round-roast-slide.active {
      display: flex;
    }
    .round-roast-slide.roast { color: var(--danger); }
    .round-roast-slide.brag { color: var(--success); }
    .round-roast-dots {
      display: flex;
      justify-content: center;
      gap: .5rem;
    }
    .round-roast-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--surface-3);
      border: none;
      cursor: pointer;
      padding: 0;
      transition: transform .2s, background .2s;
    }
    .round-roast-dot:hover { background: var(--border); }
    .round-roast-dot.active { background: var(--uno-yellow); transform: scale(1.2); }

    .round-history h3 { font-size: 1rem; margin-bottom: .75rem; color: var(--text-muted); }
    .round-history-table {
      width: 100%; border-collapse: separate; border-spacing: 0;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 14px; overflow: hidden;
      font-size: .85rem;
    }
    .round-history-table th, .round-history-table td {
      padding: .5rem .6rem; text-align: center;
      border-bottom: 1px solid var(--border);
    }
    .round-history-table th {
      background: var(--surface-2); font-size: .7rem;
      text-transform: uppercase; letter-spacing: .04em;
      color: var(--text-muted); font-weight: 600;
    }
    .round-history-table tr:last-child td { border-bottom: none; }
    .round-history-table td:first-child { font-weight: 600; text-align: left; padding-left: .75rem; }
    .round-history-table th:first-child { text-align: left; padding-left: .75rem; }
    .round-history-table .edit-cell {
      cursor: pointer; color: var(--uno-blue); font-weight: 600;
    }
    .round-history-table .edit-cell:hover { text-decoration: underline; }

    /* ---- RESULTS SCREEN ---- */
    #results { gap: 1.5rem; padding-top: 2.5rem; text-align: center; }

    .trophy { font-size: 4rem; margin-bottom: .25rem; }
    .winner-name {
      font-family: 'Fredoka One', cursive; font-size: 2rem;
      background: linear-gradient(135deg, var(--uno-yellow), #ffaa00);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .winner-subtitle { color: var(--text-muted); font-size: .95rem; margin-top: .25rem; }

    .final-standings {
      width: 100%; max-width: 480px;
    }
    .standing-row {
      display: flex; align-items: center; gap: 1rem;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 12px; padding: .85rem 1rem; margin-bottom: .5rem;
      transition: background .2s;
    }
    .standing-row:first-child { border-color: var(--uno-yellow); background: rgba(255,222,0,.06); }
    .standing-position {
      font-family: 'Fredoka One', cursive; font-size: 1.3rem;
      width: 36px; text-align: center;
    }
    .standing-position.gold { color: var(--uno-yellow); }
    .standing-position.silver { color: #c0c0c0; }
    .standing-position.bronze { color: #cd7f32; }
    .standing-info { flex: 1; text-align: left; }
    .standing-info .name { font-weight: 600; font-size: 1rem; }
    .standing-score {
      font-family: 'Fredoka One', cursive; font-size: 1.2rem;
    }

    .results-actions {
      display: flex; gap: .75rem; flex-wrap: wrap; justify-content: center;
      margin-top: .5rem;
    }

    /* ---- EDIT MODAL ---- */
    .modal-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,.6); backdrop-filter: blur(4px);
      z-index: 100; align-items: center; justify-content: center;
      padding: 1rem;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 1.75rem;
      width: 100%; max-width: 400px;
      animation: fadeIn .25s ease;
    }
    .modal h3 { margin-bottom: 1rem; font-size: 1.15rem; }
    .modal-inputs { display: flex; flex-direction: column; gap: .65rem; }
    .modal-input-row {
      display: flex; align-items: center; justify-content: space-between; gap: 1rem;
    }
    .modal-input-row label { font-weight: 600; font-size: .9rem; }
    .modal-input-row input { width: 90px; text-align: center; font-weight: 600; }
    .modal-actions { display: flex; gap: .75rem; margin-top: 1.25rem; justify-content: flex-end; }

    /* ---- PRINT STYLES ---- */
    @media print {
      body { background: #fff; color: #000; }
      .screen { padding: 0; min-height: auto; }
      .no-print { display: none !important; }
      .card, .scoreboard, .round-history-table, .standing-row {
        background: #fff; border-color: #ddd; color: #000;
      }
      .scoreboard th, .round-history-table th { background: #f5f5f5; color: #333; }
      .scoreboard td, .round-history-table td { color: #000; }
      .logo-title, .winner-name {
        -webkit-text-fill-color: #000;
        background: none; color: #000;
      }
      .standing-position.gold { color: #b8860b; -webkit-text-fill-color: #b8860b; }
      .trophy { font-size: 2rem; }
      .print-header {
        display: block !important;
        text-align: center; margin-bottom: 1rem;
        font-family: 'Fredoka One', cursive; font-size: 1.5rem;
      }
      .standing-row { border-color: #ccc; }
      .standing-row:first-child { border-color: #b8860b; }
    }

    .print-header { display: none; }

    /* ---- Responsive ---- */
    @media (max-width: 500px) {
      .logo-title { font-size: 2.4rem; }
      .round-input-row .player-label { min-width: 90px; font-size: .85rem; }
      .round-input-row input { width: 75px; }
      .scoreboard th, .scoreboard td { padding: .5rem .4rem; font-size: .85rem; }
    }
  </style>
</head>
<body>

  <!-- ============ HEADER (logo + flags) ============ -->
  <header class="app-header no-print">
    <a href="#" class="header-logo" onclick="showScreen('home'); return false;" aria-label="Lunes de UNO">
      <svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <!-- Galera negra (top hat): brim + crown -->
        <ellipse cx="20" cy="28" rx="14" ry="4" fill="#0a0a0a"/>
        <path d="M8 28 L8 12 Q8 6 20 6 Q32 6 32 12 L32 28 Z" fill="#0a0a0a"/>
        <ellipse cx="20" cy="12" rx="12" ry="3" fill="#111"/>
        <rect x="10" y="12" width="20" height="16" fill="#0a0a0a"/>
      </svg>
    </a>
    <div class="lang-switcher">
      <button class="lang-btn active" id="langEs" onclick="setLang('es')" title="EspaÃ±ol">ðŸ‡ºðŸ‡¾</button>
      <button class="lang-btn" id="langEn" onclick="setLang('en')" title="English">ðŸ‡ºðŸ‡¸</button>
    </div>
  </header>

  <!-- ============ HOME ============ -->
  <div id="home" class="screen active">
    <div>
      <div class="uno-cards">
        <div class="uno-card-mini" style="--rot:-8deg;"><span>+4</span></div>
        <div class="uno-card-mini" style="--rot:-3deg;"><span>+4</span></div>
        <div class="uno-card-mini" style="--rot:3deg;"><span>+4</span></div>
        <div class="uno-card-mini" style="--rot:8deg;"><span>+4</span></div>
      </div>
      <h1 class="logo-title">Lunes de UNO</h1>
      <p class="logo-sub" data-i18n="home_sub"></p>
    </div>
    <button class="btn btn-primary" onclick="showScreen('setup')" data-i18n="home_start"></button>
    <p class="home-beta-links">
      <a href="index.html" class="under-construction" data-i18n="home_back_stable">VersiÃ³n estable</a>
      <span class="beta-sep">Â·</span>
      <a href="#" class="under-construction" onclick="showScreen('stats'); return false;" data-i18n="home_example_stats">EstadÃ­sticas de ejemplo</a>
    </p>
  </div>

  <!-- ============ SETUP ============ -->
  <div id="setup" class="screen">
    <h2 style="font-size:1.6rem; margin-bottom:.5rem;" data-i18n="setup_title"></h2>

    <div class="card">
      <div class="input-group">
        <label data-i18n="setup_players_label"></label>
        <div class="number-selector">
          <button class="btn btn-icon" onclick="changePlayerCount(-1)">-</button>
          <div class="number-display" id="playerCountDisplay">2</div>
          <button class="btn btn-icon" onclick="changePlayerCount(1)">+</button>
        </div>
      </div>
      <div class="player-inputs" id="playerInputs"></div>
    </div>

    <div class="card">
      <div class="input-group">
        <label data-i18n="setup_points_label"></label>
        <div class="points-presets" id="pointsPresets">
          <button class="preset-btn" data-val="200" onclick="selectPoints(this, 200)">200</button>
          <button class="preset-btn" data-val="300" onclick="selectPoints(this, 300)">300</button>
          <button class="preset-btn selected" data-val="500" onclick="selectPoints(this, 500)">500</button>
          <button class="preset-btn" data-val="1000" onclick="selectPoints(this, 1000)">1000</button>
        </div>
        <div style="display:flex; align-items:center; gap:.5rem; margin-top:.75rem;">
          <input type="number" id="customPoints" placeholder="" data-i18n-ph="setup_custom_placeholder" min="50" style="flex:1;" oninput="onCustomPoints()">
        </div>
      </div>
    </div>

    <div class="setup-footer">
      <button class="btn btn-primary" id="startGameBtn" onclick="startGame()" data-i18n="setup_start_btn"></button>
    </div>

    <button class="btn btn-secondary btn-small no-print" onclick="showScreen('home')" style="margin-top:.5rem;" data-i18n="back_btn"></button>
  </div>

  <!-- ============ GAME ============ -->
  <div id="game" class="screen">
    <div class="game-header">
      <h2 id="gameTitle">Lunes de UNO</h2>
      <span class="round-badge" id="roundBadge"></span>
    </div>

    <!-- Progress of leading player -->
    <div class="progress-container" id="progressContainer">
      <div class="progress-label">
        <span id="progressLeader">-</span>
        <span id="progressText">0 / 500</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width:0%"></div>
      </div>
    </div>

    <!-- Current Scoreboard -->
    <table class="scoreboard" id="scoreboard"></table>

    <!-- Round Score Input -->
    <div class="card" id="roundInputCard">
      <h4 style="margin-bottom:.75rem; font-size:1rem;" data-i18n="game_enter_scores"></h4>
      <div class="round-inputs" id="roundInputs"></div>
      <div class="game-actions" style="margin-top:1rem;">
        <button class="btn btn-primary" style="font-size:1rem; padding:.75rem 2rem;" onclick="submitRound()" data-i18n="game_end_round"></button>
      </div>
    </div>

    <!-- Round roast carousel (after each round) -->
    <div class="round-roast no-print" id="roundRoastCarousel">
      <div class="round-roast-slides" id="roundRoastSlides"></div>
      <div class="round-roast-dots" id="roundRoastDots"></div>
    </div>

    <!-- Round History -->
    <div class="round-history" id="roundHistoryContainer" style="display:none;">
      <h3 data-i18n="game_round_history"></h3>
      <table class="round-history-table" id="roundHistoryTable"></table>
    </div>

    <button class="btn btn-secondary btn-small no-print" onclick="confirmQuit()" style="margin-top:.5rem; color:var(--danger);" data-i18n="game_quit"></button>
  </div>

  <!-- ============ RESULTS ============ -->
  <div id="results" class="screen">
    <div class="print-header">Lunes de UNO - Final Scores</div>
    <div class="trophy">&#127942;</div>
    <div>
      <div class="winner-name" id="winnerName">-</div>
      <p class="winner-subtitle" data-i18n="results_winner_sub"></p>
    </div>

    <div class="final-standings" id="finalStandings"></div>

    <!-- Full breakdown for print -->
    <div class="round-history" id="resultsHistoryContainer">
      <h3 data-i18n="results_breakdown"></h3>
      <table class="round-history-table" id="resultsHistoryTable"></table>
    </div>

    <div class="results-actions no-print">
      <button class="btn btn-secondary" onclick="printResults()"><span>&#128424;</span> <span data-i18n="results_print"></span></button>
      <button class="btn btn-secondary" onclick="showEditableHistory()"><span>&#9998;</span> <span data-i18n="results_edit"></span></button>
      <button class="btn btn-primary" onclick="newGame()" data-i18n="results_new_game"></button>
    </div>

    <!-- Share (beta) -->
    <div class="card share-card no-print">
      <h4 data-i18n="share_title">Compartir resultados</h4>
      <div class="share-actions">
        <button type="button" class="btn btn-secondary btn-small" onclick="downloadPDFRoast()">
          <span>&#128196;</span> <span data-i18n="share_pdf_roast">Descargar PDF (roast al Ãºltimo)</span>
        </button>
        <div class="photo-upload-wrap">
          <label style="display:block; font-size:.85rem; margin-bottom:.35rem;" data-i18n="share_upload_photo">Subir foto y cartoon con puntajes</label>
          <input type="file" id="sharePhotoInput" accept="image/*" onchange="onSharePhotoChange(event)">
        </div>
        <div class="share-photo-row" id="sharePhotoRow" style="display:none;">
          <div class="share-photo-box">
            <img id="sharePhotoOriginal" alt="Original" />
            <div class="share-photo-label" data-i18n="share_original">Original</div>
            <button type="button" class="btn btn-small btn-secondary" onclick="downloadShareImage('original')" data-i18n="share_download_original">Descargar original</button>
          </div>
          <div class="share-photo-box">
            <img id="sharePhotoCartoon" alt="Cartoon" />
            <div class="share-photo-label" data-i18n="share_cartoon">Cartoon con puntajes</div>
            <button type="button" class="btn btn-small btn-secondary" onclick="downloadShareImage('cartoon')" data-i18n="share_download_cartoon">Descargar cartoon</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============ STATS (example) ============ -->
  <div id="stats" class="screen">
    <h2 data-i18n="stats_title">EstadÃ­sticas de ejemplo</h2>
    <p class="stats-example-note" data-i18n="stats_subtitle">Datos inventados para mostrar cÃ³mo se verÃ­an las estadÃ­sticas.</p>
    <div class="card stats-card" id="statsCard"></div>
    <button class="btn btn-secondary btn-small" onclick="showScreen('home')" data-i18n="back_btn">Volver</button>
  </div>

  <!-- ============ EDIT MODAL ============ -->
  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <h3 id="editModalTitle"></h3>
      <div class="modal-inputs" id="editModalInputs"></div>
      <div class="modal-actions">
        <button class="btn btn-secondary btn-small" onclick="closeEditModal()" data-i18n="modal_cancel"></button>
        <button class="btn btn-primary btn-small" onclick="saveEditRound()" data-i18n="modal_save"></button>
      </div>
    </div>
  </div>

<script>
// ============ I18N ============
const STRINGS = {
  es: {
    home_sub: 'Contador de puntos, bÃ³',
    home_start: 'Arrancar partida nueva',
    home_under_construction: 'En construcciÃ³n: compartir resultados',
    home_back_stable: 'VersiÃ³n estable',
    home_example_stats: 'EstadÃ­sticas de ejemplo',
    share_title: 'Compartir resultados',
    share_pdf_roast: 'Descargar PDF (roast al Ãºltimo)',
    share_upload_photo: 'Subir foto y cartoon con puntajes',
    share_original: 'Original',
    share_cartoon: 'Cartoon con puntajes',
    share_download_original: 'Descargar original',
    share_download_cartoon: 'Descargar cartoon',
    stats_title: 'EstadÃ­sticas de ejemplo',
    stats_subtitle: 'Datos inventados para mostrar cÃ³mo se verÃ­an las estadÃ­sticas.',
    stats_wins: 'Victorias',
    stats_biggest_round: 'Ronda mÃ¡s brava',
    stats_most_roasts: 'Veces Ãºltimo en ronda',
    setup_title: 'Partida nueva',
    setup_players_label: 'Â¿CuÃ¡ntos juegan?',
    setup_points_label: 'Â¿Hasta cuÃ¡ntos puntos?',
    setup_custom_placeholder: 'Ponele lo que quieras...',
    setup_start_btn: 'Â¡Dale que va!',
    back_btn: 'Volver',
    game_enter_scores: 'Metele los puntos de la ronda',
    game_end_round: 'Cerrar ronda',
    game_round_history: 'Lo que fue pasando',
    game_quit: 'Rajar del juego',
    game_round: 'Ronda',
    game_player: 'Jugador',
    game_total: 'Total',
    game_no_scores: 'TodavÃ­a no arrancÃ³ nadie',
    game_pts: 'pts',
    game_edit: 'editar',
    game_alert_no_scores: 'Bo, metele algÃºn puntaje a alguien por lo menos.',
    game_confirm_quit: 'Â¿Posta te querÃ©s ir? Se pierde todo eh.',
    results_winner_sub: 'Â¡ganÃ³ con menos puntos, quÃ© crack!',
    results_breakdown: 'Ronda por ronda',
    results_print: 'Imprimir',
    results_edit: 'Editar puntajes',
    results_new_game: 'Otra partidita',
    modal_edit_round: 'Editar Ronda',
    modal_cancel: 'Na, dejÃ¡',
    modal_save: 'Guardar',
    player_placeholder: 'Jugador',
  },
  en: {
    home_sub: 'Score Tracker',
    home_start: 'Start New Game',
    home_under_construction: 'Under construction: share results',
    home_back_stable: 'Stable version',
    home_example_stats: 'Example stats',
    share_title: 'Share results',
    share_pdf_roast: 'Download PDF (roast last place)',
    share_upload_photo: 'Upload photo & cartoon with scores',
    share_original: 'Original',
    share_cartoon: 'Cartoon with scores',
    share_download_original: 'Download original',
    share_download_cartoon: 'Download cartoon',
    stats_title: 'Example statistics',
    stats_subtitle: 'Made-up data to show what stats could look like.',
    stats_wins: 'Wins',
    stats_biggest_round: 'Biggest single round',
    stats_most_roasts: 'Times last in a round',
    setup_title: 'New Game',
    setup_players_label: 'Number of Players',
    setup_points_label: 'Points to Play',
    setup_custom_placeholder: 'Custom...',
    setup_start_btn: 'Start Game',
    back_btn: 'Back',
    game_enter_scores: 'Enter Round Scores',
    game_end_round: 'End Round',
    game_round_history: 'Round History',
    game_quit: 'Quit Game',
    game_round: 'Round',
    game_player: 'Player',
    game_total: 'Total',
    game_no_scores: 'No scores yet',
    game_pts: 'pts',
    game_edit: 'edit',
    game_alert_no_scores: 'Enter at least one score for this round.',
    game_confirm_quit: 'Are you sure you want to quit this game?',
    results_winner_sub: 'wins with the lowest score!',
    results_breakdown: 'Round Breakdown',
    results_print: 'Print Scores',
    results_edit: 'Edit Scores',
    results_new_game: 'New Game',
    modal_edit_round: 'Edit Round',
    modal_cancel: 'Cancel',
    modal_save: 'Save',
    player_placeholder: 'Player',
  }
};

// Messages for round roast carousel: 2 at last (most pts), 1 at second-last, 1 at first (least pts)
const CAROUSEL_MSGS = {
  es: {
    last: [
      'Bo {name}, te comiste todos los puntos de la mesa ðŸ˜‚',
      '{name} juntÃ³ mÃ¡s puntos que boleto de STM, ta bravo.',
      'Â¿{name} estaba jugando al UNO o al â€œsumÃ¡ todo, boâ€?',
      'Pa, {name}, dejale algÃºn punto a los demÃ¡s, Â¿no?',
      'Alguien avÃ­sele a {name} que acÃ¡ gana el que tiene menos, ta.',
    ],
    secondLast: [
      '{name} zafÃ³ por poquito de ser el desastre de la ronda.',
      'Bo {name}, casi quedÃ¡s Ãºltimo tambiÃ©n, ojo ahÃ­.',
    ],
    first: [
      'Â¡{name} saliÃ³ hecho un crack esta ronda, bo! ðŸ†',
      '{name} se fue livianito de puntos, ta que bien jugado.',
      'Esta ronda fue toda de {name}, tremendo nivel.',
    ],
  },
  en: {
    last: [
      '{name} went full send and took the whole pile! ðŸ˜‚',
      '{name} collected more than the dealer. Yikes.',
      'Was {name} playing UNO or â€œadd everythingâ€?',
      '{name} built a monument to points! ðŸ—¿',
      'Someone tell {name} that the lowest score wins.',
    ],
    secondLast: [
      '{name} came second atâ€¦ hoarding. So close.',
      '{name} almost had the highest round. Next time!',
    ],
    first: [
      '{name} crushed it this round! ðŸ†',
      '{name} kept it low. That\'s how you play!',
      'That round belonged to {name}. Applause.',
    ],
  },
};

let currentLang = localStorage.getItem('lunesdeuno_lang') || 'es';
let roundRoastInterval = null;

function t(key) {
  return (STRINGS[currentLang] && STRINGS[currentLang][key]) || STRINGS.en[key] || key;
}

function setLang(lang) {
  currentLang = lang;
  localStorage.setItem('lunesdeuno_lang', lang);
  document.documentElement.lang = lang;

  // Update flag buttons
  document.getElementById('langEs').classList.toggle('active', lang === 'es');
  document.getElementById('langEn').classList.toggle('active', lang === 'en');

  // Apply all data-i18n
  document.querySelectorAll('[data-i18n]').forEach(el => {
    el.textContent = t(el.dataset.i18n);
  });
  document.querySelectorAll('[data-i18n-ph]').forEach(el => {
    el.placeholder = t(el.dataset.i18nPh);
  });

  // Re-render dynamic content if a game screen is active
  if (document.getElementById('setup').classList.contains('active')) renderPlayerInputs();
  if (document.getElementById('game').classList.contains('active')) renderGame();
  if (document.getElementById('results').classList.contains('active')) renderResults();
  if (document.getElementById('stats').classList.contains('active')) renderStats();
}

// ============ STATE ============
let state = {
  playerCount: 2,
  maxPoints: 500,
  players: [],
  rounds: [],
  currentRound: 0,
  gameOver: false
};

const PLAYER_COLORS = [
  '#ED1C24', '#FFDE00', '#00A651', '#0072BC',
  '#FF6B35', '#A855F7', '#EC4899', '#14B8A6',
  '#F97316', '#6366F1'
];

// ============ NAVIGATION ============
function showScreen(id) {
  if (id !== 'game' && roundRoastInterval) {
    clearInterval(roundRoastInterval);
    roundRoastInterval = null;
  }
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if (id === 'setup') initSetup();
  if (id === 'game') renderGame();
  if (id === 'results') renderResults();
  if (id === 'stats') renderStats();
}

// ============ SETUP ============
function initSetup() {
  renderPlayerInputs();
  validateSetup();
}

function changePlayerCount(delta) {
  state.playerCount = Math.max(2, Math.min(10, state.playerCount + delta));
  document.getElementById('playerCountDisplay').textContent = state.playerCount;
  renderPlayerInputs();
}

function renderPlayerInputs() {
  const container = document.getElementById('playerInputs');
  const existing = container.querySelectorAll('input');
  const oldValues = Array.from(existing).map(i => i.value);

  let html = '';
  for (let i = 0; i < state.playerCount; i++) {
    const color = PLAYER_COLORS[i % PLAYER_COLORS.length];
    const val = oldValues[i] || '';
    html += `
      <div class="player-input-row">
        <div class="player-color" style="background:${color}"></div>
        <input type="text" placeholder="${t('player_placeholder')} ${i + 1}" value="${val}" maxlength="20" oninput="validateSetup()">
      </div>`;
  }
  container.innerHTML = html;
  validateSetup();
}

function selectPoints(btn, val) {
  document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  state.maxPoints = val;
  document.getElementById('customPoints').value = '';
  validateSetup();
}

function onCustomPoints() {
  const v = parseInt(document.getElementById('customPoints').value);
  document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('selected'));
  if (v && v >= 50) {
    state.maxPoints = v;
  }
  validateSetup();
}

function validateSetup() {
  const inputs = document.querySelectorAll('#playerInputs input');
  const allNamed = Array.from(inputs).every(i => i.value.trim().length > 0);
  const hasPoints = state.maxPoints >= 50;
  document.getElementById('startGameBtn').disabled = !(allNamed && hasPoints);
}

function startGame() {
  const inputs = document.querySelectorAll('#playerInputs input');
  state.players = Array.from(inputs).map((inp, i) => ({
    name: inp.value.trim() || `${t('player_placeholder')} ${i+1}`,
    color: PLAYER_COLORS[i % PLAYER_COLORS.length]
  }));
  state.rounds = [];
  state.currentRound = 0;
  state.gameOver = false;
  showScreen('game');
}

// ============ ROUND ROAST CAROUSEL ============
function getRoundRanking(roundScores) {
  const withIdx = state.players.map((p, i) => ({ idx: i, name: p.name, score: roundScores[i] || 0 }));
  const byScoreDesc = [...withIdx].sort((a, b) => b.score - a.score);
  return {
    first: byScoreDesc[byScoreDesc.length - 1],
    secondLast: byScoreDesc.length >= 2 ? byScoreDesc[1] : byScoreDesc[0],
    last: byScoreDesc[0],
  };
}

function buildRoastMessages(roundScores) {
  const rank = getRoundRanking(roundScores);
  const lang = currentLang in CAROUSEL_MSGS ? currentLang : 'es';
  const M = CAROUSEL_MSGS[lang];
  const pick = (arr, name) => arr[Math.floor(Math.random() * arr.length)].replace(/\{name\}/g, name);
  return [
    pick(M.last, rank.last.name),
    pick(M.last, rank.last.name),
    pick(M.secondLast, rank.secondLast.name),
    pick(M.first, rank.first.name),
  ];
}

function setRoundRoastSlide(index) {
  const slides = document.querySelectorAll('.round-roast-slide');
  const dots = document.querySelectorAll('.round-roast-dot');
  slides.forEach((s, i) => s.classList.toggle('active', i === index));
  dots.forEach((d, i) => d.classList.toggle('active', i === index));
}

function updateRoundRoastCarousel(messages, startAutoAdvance) {
  if (roundRoastInterval) clearInterval(roundRoastInterval);
  roundRoastInterval = null;

  const container = document.getElementById('roundRoastCarousel');
  const slidesEl = document.getElementById('roundRoastSlides');
  const dotsEl = document.getElementById('roundRoastDots');
  if (!messages || messages.length === 0) {
    container.classList.remove('visible');
    return;
  }

  const classes = ['roast', 'roast', 'roast', 'brag'];
  slidesEl.innerHTML = messages.map((text, i) =>
    `<div class="round-roast-slide ${classes[i]}" data-index="${i}">${text}</div>`
  ).join('');
  dotsEl.innerHTML = messages.map((_, i) =>
    `<button type="button" class="round-roast-dot" aria-label="Slide ${i + 1}" onclick="setRoundRoastSlide(${i})"></button>`
  ).join('');

  container.classList.add('visible');
  setRoundRoastSlide(0);
  container.scrollIntoView({ behavior: 'smooth', block: 'center' });

  if (startAutoAdvance && messages.length > 1) {
    let idx = 0;
    roundRoastInterval = setInterval(() => {
      idx = (idx + 1) % messages.length;
      setRoundRoastSlide(idx);
    }, 3200);
  }
}

// ============ GAME ============
function getTotals() {
  return state.players.map((_, pi) =>
    state.rounds.reduce((sum, round) => sum + (round[pi] || 0), 0)
  );
}

function getLeaderIndex() {
  const totals = getTotals();
  let minIdx = 0;
  totals.forEach((t, i) => { if (t < totals[minIdx]) minIdx = i; });
  return minIdx;
}

function getMaxTotal() {
  return Math.max(...getTotals(), 0);
}

function renderGame() {
  const totals = getTotals();
  const roundNum = state.rounds.length + 1;

  document.getElementById('gameTitle').textContent = 'Lunes de UNO';
  document.getElementById('roundBadge').textContent = `${t('game_round')} ${roundNum}`;

  // Progress
  const maxT = getMaxTotal();
  const leaderIdx = totals.indexOf(Math.max(...totals));
  const pct = Math.min((maxT / state.maxPoints) * 100, 100);
  document.getElementById('progressLeader').textContent =
    maxT > 0 ? `${state.players[leaderIdx].name}: ${totals[leaderIdx]} ${t('game_pts')}` : t('game_no_scores');
  document.getElementById('progressText').textContent = `${maxT} / ${state.maxPoints}`;
  document.getElementById('progressFill').style.width = pct + '%';

  // Scoreboard
  renderScoreboard(totals);

  // Round inputs
  renderRoundInputs();

  // Round roast carousel (after each round)
  if (state.rounds.length > 0) {
    const messages = state.lastRoundRoastMessages || buildRoastMessages(state.rounds[state.rounds.length - 1]);
    if (!state.lastRoundRoastMessages) state.lastRoundRoastMessages = messages;
    updateRoundRoastCarousel(messages, state.justSubmittedRound === true);
    if (state.justSubmittedRound) state.justSubmittedRound = false;
  } else {
    document.getElementById('roundRoastCarousel').classList.remove('visible');
  }

  // Round history
  renderRoundHistory();
}

function renderScoreboard(totals) {
  const table = document.getElementById('scoreboard');
  let html = `<thead><tr><th>${t('game_player')}</th><th style="text-align:right;">${t('game_total')}</th></tr></thead><tbody>`;
  const sorted = state.players.map((p, i) => ({...p, idx: i, total: totals[i]}))
    .sort((a, b) => a.total - b.total);

  sorted.forEach(p => {
    const overLimit = p.total >= state.maxPoints;
    const isLowest = p.total === sorted[0].total && state.rounds.length > 0;
    html += `<tr class="${isLowest && state.rounds.length > 0 ? 'winner-row' : ''}">
      <td><div class="player-name-cell">
        <div class="player-color" style="background:${p.color}"></div>
        ${p.name}
      </div></td>
      <td style="text-align:right;" class="total-cell ${overLimit ? 'over-limit' : ''}">${p.total}</td>
    </tr>`;
  });
  html += '</tbody>';
  table.innerHTML = html;
}

function renderRoundInputs() {
  if (state.gameOver) {
    document.getElementById('roundInputCard').style.display = 'none';
    return;
  }
  document.getElementById('roundInputCard').style.display = '';
  const container = document.getElementById('roundInputs');
  let html = '';
  state.players.forEach((p, i) => {
    html += `
      <div class="round-input-row">
        <div class="player-label">
          <div class="player-color" style="background:${p.color}"></div>
          ${p.name}
        </div>
        <input type="number" id="roundScore_${i}" placeholder="0" min="0">
      </div>`;
  });
  container.innerHTML = html;
}

function submitRound() {
  const scores = state.players.map((_, i) => {
    const val = parseInt(document.getElementById(`roundScore_${i}`).value) || 0;
    return Math.max(0, val);
  });

  if (scores.every(s => s === 0)) {
    alert(t('game_alert_no_scores'));
    return;
  }

  state.rounds.push(scores);
  state.currentRound = state.rounds.length;
  state.lastRoundRoastMessages = buildRoastMessages(scores);
  state.justSubmittedRound = true;

  const totals = getTotals();
  if (totals.some(t => t >= state.maxPoints)) {
    state.gameOver = true;
    showScreen('results');
    return;
  }

  renderGame();
}

function renderRoundHistory() {
  const container = document.getElementById('roundHistoryContainer');
  if (state.rounds.length === 0) {
    container.style.display = 'none';
    return;
  }
  container.style.display = '';

  const table = document.getElementById('roundHistoryTable');
  let html = `<thead><tr><th>${t('game_round')}</th>`;
  state.players.forEach(p => { html += `<th>${p.name}</th>`; });
  html += '<th class="no-print"></th></tr></thead><tbody>';

  state.rounds.forEach((round, ri) => {
    html += `<tr><td>R${ri + 1}</td>`;
    round.forEach(s => { html += `<td>${s}</td>`; });
    html += `<td class="edit-cell no-print" onclick="openEditModal(${ri})">${t('game_edit')}</td></tr>`;
  });

  const totals = getTotals();
  html += `<tr style="font-weight:700; background:var(--surface-2);"><td>${t('game_total')}</td>`;
  totals.forEach(t => { html += `<td>${t}</td>`; });
  html += '<td class="no-print"></td></tr>';

  html += '</tbody>';
  table.innerHTML = html;
}

// ============ EDIT MODAL ============
let editingRound = -1;

function openEditModal(roundIdx) {
  editingRound = roundIdx;
  document.getElementById('editModalTitle').textContent = `${t('modal_edit_round')} ${roundIdx + 1}`;
  const container = document.getElementById('editModalInputs');
  let html = '';
  state.players.forEach((p, i) => {
    html += `
      <div class="modal-input-row">
        <label>${p.name}</label>
        <input type="number" id="editScore_${i}" value="${state.rounds[roundIdx][i]}" min="0">
      </div>`;
  });
  container.innerHTML = html;
  document.getElementById('editModal').classList.add('active');
}

function closeEditModal() {
  document.getElementById('editModal').classList.remove('active');
  editingRound = -1;
}

function saveEditRound() {
  if (editingRound < 0) return;
  state.players.forEach((_, i) => {
    state.rounds[editingRound][i] = Math.max(0, parseInt(document.getElementById(`editScore_${i}`).value) || 0);
  });
  closeEditModal();

  const totals = getTotals();
  const wasOver = state.gameOver;
  state.gameOver = totals.some(t => t >= state.maxPoints);

  if (state.gameOver && document.getElementById('results').classList.contains('active')) {
    renderResults();
  } else if (state.gameOver && !wasOver) {
    showScreen('results');
  } else if (!state.gameOver && wasOver) {
    showScreen('game');
  } else {
    if (document.getElementById('game').classList.contains('active')) renderGame();
    if (document.getElementById('results').classList.contains('active')) renderResults();
  }
}

// ============ RESULTS ============
function renderResults() {
  const totals = getTotals();
  const standings = state.players.map((p, i) => ({...p, idx: i, total: totals[i]}))
    .sort((a, b) => a.total - b.total);

  document.getElementById('winnerName').textContent = standings[0].name;

  const container = document.getElementById('finalStandings');
  const medals = ['gold', 'silver', 'bronze'];
  let html = '';
  standings.forEach((p, i) => {
    html += `
      <div class="standing-row">
        <div class="standing-position ${medals[i] || ''}">${i + 1}</div>
        <div class="standing-info">
          <div class="name" style="display:flex;align-items:center;gap:.4rem;">
            <div class="player-color" style="background:${p.color}"></div>
            ${p.name}
          </div>
        </div>
        <div class="standing-score">${p.total} ${t('game_pts')}</div>
      </div>`;
  });
  container.innerHTML = html;

  renderResultsHistory();
}

function renderResultsHistory() {
  const table = document.getElementById('resultsHistoryTable');
  let html = `<thead><tr><th>${t('game_round')}</th>`;
  state.players.forEach(p => { html += `<th>${p.name}</th>`; });
  html += '</tr></thead><tbody>';

  state.rounds.forEach((round, ri) => {
    html += `<tr><td>R${ri + 1}</td>`;
    round.forEach(s => { html += `<td>${s}</td>`; });
    html += '</tr>';
  });

  const totals = getTotals();
  html += `<tr style="font-weight:700; background:var(--surface-2);"><td>${t('game_total')}</td>`;
  totals.forEach(t => { html += `<td>${t}</td>`; });
  html += '</tr></tbody>';
  table.innerHTML = html;
}

function showEditableHistory() {
  const table = document.getElementById('resultsHistoryTable');
  let html = `<thead><tr><th>${t('game_round')}</th>`;
  state.players.forEach(p => { html += `<th>${p.name}</th>`; });
  html += '<th></th></tr></thead><tbody>';

  state.rounds.forEach((round, ri) => {
    html += `<tr><td>R${ri + 1}</td>`;
    round.forEach(s => { html += `<td>${s}</td>`; });
    html += `<td class="edit-cell" onclick="openEditModal(${ri})">${t('game_edit')}</td></tr>`;
  });

  const totals = getTotals();
  html += `<tr style="font-weight:700; background:var(--surface-2);"><td>${t('game_total')}</td>`;
  totals.forEach(t => { html += `<td>${t}</td>`; });
  html += '<td></td></tr></tbody>';
  table.innerHTML = html;
}

function printResults() {
  window.print();
}

function newGame() {
  state = {
    playerCount: 2, maxPoints: 500,
    players: [], rounds: [], currentRound: 0, gameOver: false
  };
  document.getElementById('playerCountDisplay').textContent = '2';
  showScreen('home');
}

function confirmQuit() {
  if (confirm(t('game_confirm_quit'))) {
    newGame();
  }
}

// ============ SHARE (beta): PDF roast ============
const PDF_ROASTS = {
  es: [
    'Â¡{name} se llevÃ³ todos los puntos a casa! ðŸ ðŸ“¦',
    '{name} jugÃ³ al "sumÃ¡ todo" en vez del UNO. ðŸ˜‚',
    'Alguien avÃ­sele a {name} que acÃ¡ gana el que tiene menos.',
    '{name}: el rey/la reina de los puntos. (Del malo.)',
  ],
  en: [
    '{name} took the whole pile home! ðŸ ðŸ“¦',
    '{name} was playing "add everything" instead of UNO. ðŸ˜‚',
    'Someone tell {name} the lowest score wins.',
    '{name}: royalty of points. (The bad kind.)',
  ],
};

function downloadPDFRoast() {
  if (typeof jspdf === 'undefined') {
    alert('PDF library not loaded. Check your connection.');
    return;
  }
  const totals = getTotals();
  const standings = state.players.map((p, i) => ({ ...p, idx: i, total: totals[i] }))
    .sort((a, b) => a.total - b.total);
  const lastPlace = standings[standings.length - 1];
  const lang = currentLang in PDF_ROASTS ? currentLang : 'es';
  const roast = PDF_ROASTS[lang][Math.floor(Math.random() * PDF_ROASTS[lang].length)].replace(/\{name\}/g, lastPlace.name);

  const { jsPDF } = jspdf;
  const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
  const w = doc.internal.pageSize.getWidth();
  let y = 22;

  // Title - cartoon style
  doc.setFillColor(237, 28, 36);
  doc.rect(0, 0, w, 18, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(24);
  doc.setFont('helvetica', 'bold');
  doc.text('LUNES DE UNO', w / 2, 12, { align: 'center' });
  doc.setTextColor(0, 0, 0);
  y = 28;

  doc.setFontSize(14);
  doc.text(t('game_total') + ' - ' + (currentLang === 'es' ? 'Resultado final' : 'Final scores'), 14, y);
  y += 10;

  standings.forEach((p, i) => {
    const medal = i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : i === 2 ? 'ðŸ¥‰' : (i + 1) + '.';
    doc.setFontSize(11);
    doc.text(medal + ' ' + p.name + ' â€” ' + p.total + ' ' + t('game_pts'), 18, y);
    y += 7;
  });
  y += 10;

  // Roast in a "speech bubble" style box
  doc.setDrawColor(255, 222, 0);
  doc.setLineWidth(1.5);
  doc.setFillColor(255, 252, 220);
  doc.roundedRect(14, y - 2, w - 28, 22, 3, 3, 'FD');
  doc.roundedRect(14, y - 2, w - 28, 22, 3, 3, 'S');
  doc.setFontSize(10);
  doc.setTextColor(180, 50, 50);
  doc.setFont('helvetica', 'normal');
  doc.text(doc.splitTextToSize(roast, w - 36), 20, y + 8);
  doc.setTextColor(0, 0, 0);

  doc.save('LunesDeUNO-' + lastPlace.name.replace(/\s/g, '') + '.pdf');
}

// ============ SHARE (beta): Photo + cartoon with scores ============
let sharePhotoState = { originalDataUrl: null, cartoonDataUrl: null };

function applyCartoonEffect(imageData, width, height) {
  const data = imageData.data;
  const len = data.length;
  const levels = 6;
  for (let i = 0; i < len; i += 4) {
    data[i] = Math.floor(data[i] / (256 / levels)) * (256 / levels);
    data[i + 1] = Math.floor(data[i + 1] / (256 / levels)) * (256 / levels);
    data[i + 2] = Math.floor(data[i + 2] / (256 / levels)) * (256 / levels);
    const edge = (i / 4) % width > 0 && (i / 4) % width < width - 1
      ? Math.abs(data[i] - data[i - 4]) + Math.abs(data[i + 4] - data[i])
      : 0;
    if (edge > 30) {
      data[i] = 0; data[i + 1] = 0; data[i + 2] = 0;
    }
  }
  return imageData;
}

function drawScoresOnCanvas(canvas, img, isCartoon) {
  const ctx = canvas.getContext('2d');
  const maxW = 400, maxH = 300;
  let w = img.width, h = img.height;
  if (w > maxW || h > maxH) {
    const r = Math.min(maxW / w, maxH / h);
    w = Math.round(w * r); h = Math.round(h * r);
  }
  canvas.width = w; canvas.height = h;
  ctx.drawImage(img, 0, 0, w, h);
  if (isCartoon) {
    const imageData = ctx.getImageData(0, 0, w, h);
    ctx.putImageData(applyCartoonEffect(imageData, w, h), 0, 0);
  }
  const totals = getTotals();
  const standings = state.players.map((p, i) => ({ ...p, total: totals[i] })).sort((a, b) => a.total - b.total);
  ctx.font = 'bold 14px Inter, sans-serif';
  ctx.fillStyle = 'rgba(0,0,0,0.7)';
  ctx.strokeStyle = 'rgba(255,255,255,0.9)';
  ctx.lineWidth = 2;
  let ty = 24;
  standings.forEach((p, i) => {
    const text = (i + 1) + '. ' + p.name + ' â€” ' + p.total + ' pts';
    ctx.strokeText(text, 10, ty);
    ctx.fillText(text, 10, ty);
    ty += 22;
  });
}

function onSharePhotoChange(ev) {
  const file = ev.target.files && ev.target.files[0];
  if (!file || !file.type.startsWith('image/')) return;
  const reader = new FileReader();
  reader.onload = function () {
    const img = new Image();
    img.onload = function () {
      const canvasOrig = document.createElement('canvas');
      const canvasCartoon = document.createElement('canvas');
      drawScoresOnCanvas(canvasOrig, img, false);
      drawScoresOnCanvas(canvasCartoon, img, true);
      sharePhotoState.originalDataUrl = canvasOrig.toDataURL('image/png');
      sharePhotoState.cartoonDataUrl = canvasCartoon.toDataURL('image/png');
      document.getElementById('sharePhotoOriginal').src = sharePhotoState.originalDataUrl;
      document.getElementById('sharePhotoCartoon').src = sharePhotoState.cartoonDataUrl;
      document.getElementById('sharePhotoRow').style.display = 'flex';
    };
    img.src = reader.result;
  };
  reader.readAsDataURL(file);
}

function downloadShareImage(which) {
  const dataUrl = which === 'original' ? sharePhotoState.originalDataUrl : sharePhotoState.cartoonDataUrl;
  if (!dataUrl) return;
  const a = document.createElement('a');
  a.href = dataUrl;
  a.download = 'LunesDeUNO-' + which + '.png';
  a.click();
}

// ============ STATS (example data) ============
const EXAMPLE_STATS = {
  wins: [
    { name: 'Ana', wins: 4, badge: 'gold' },
    { name: 'Bruno', wins: 2, badge: 'silver' },
    { name: 'Cata', wins: 1, badge: 'bronze' },
    { name: 'Dani', wins: 0, badge: '' },
  ],
  biggestRound: [
    { name: 'Dani', round: 8, pts: 89 },
    { name: 'Bruno', round: 5, pts: 76 },
    { name: 'Cata', round: 3, pts: 72 },
    { name: 'Ana', round: 2, pts: 65 },
  ],
  mostRoasts: [
    { name: 'Dani', count: 5 },
    { name: 'Bruno', count: 3 },
    { name: 'Cata', count: 2 },
    { name: 'Ana', count: 0 },
  ],
};

function renderStats() {
  const container = document.getElementById('statsCard');
  const lang = currentLang;
  const winsLabel = t('stats_wins');
  const biggestLabel = t('stats_biggest_round');
  const roastsLabel = t('stats_most_roasts');
  let html = '';
  html += '<h3>' + winsLabel + '</h3><table class="stats-table"><thead><tr><th>' + (lang === 'es' ? 'Jugador' : 'Player') + '</th><th>' + (lang === 'es' ? 'Partidas ganadas' : 'Games won') + '</th></tr></thead><tbody>';
  EXAMPLE_STATS.wins.forEach(function (r) {
    html += '<tr><td>' + r.name + '</td><td><span class="stats-badge ' + r.badge + '">' + r.wins + '</span></td></tr>';
  });
  html += '</tbody></table>';
  html += '<h3 style="margin-top:1.25rem;">' + biggestLabel + '</h3><table class="stats-table"><thead><tr><th>' + (lang === 'es' ? 'Jugador' : 'Player') + '</th><th>' + (lang === 'es' ? 'Ronda' : 'Round') + '</th><th>Pts</th></tr></thead><tbody>';
  EXAMPLE_STATS.biggestRound.forEach(function (r) {
    html += '<tr><td>' + r.name + '</td><td>R' + r.round + '</td><td>' + r.pts + '</td></tr>';
  });
  html += '</tbody></table>';
  html += '<h3 style="margin-top:1.25rem;">' + roastsLabel + '</h3><table class="stats-table"><thead><tr><th>' + (lang === 'es' ? 'Jugador' : 'Player') + '</th><th>#</th></tr></thead><tbody>';
  EXAMPLE_STATS.mostRoasts.forEach(function (r) {
    html += '<tr><td>' + r.name + '</td><td>' + r.count + '</td></tr>';
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}

// ============ INIT ============
setLang(currentLang);
initSetup();
</script>
</body>
</html>
