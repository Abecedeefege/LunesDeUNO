<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lunes de UNO</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --uno-red: #ED1C24;
      --uno-yellow: #FFDE00;
      --uno-green: #00A651;
      --uno-blue: #0072BC;
      --bg: #0f0f1a;
      --surface: #1a1a2e;
      --surface-2: #242442;
      --surface-3: #2e2e50;
      --text: #f0f0f5;
      --text-muted: #8888a8;
      --border: #3a3a5c;
      --danger: #ff4d6a;
      --success: #4dff91;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ---- Header (logo + flags) ---- */
    .app-header {
      position: fixed; top: 0; left: 0; right: 0; z-index: 200;
      height: 10vh;
      min-height: 52px;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 1rem;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }
    .header-logo {
      display: flex; align-items: center; gap: .5rem;
      text-decoration: none; color: var(--text);
      height: 95%;
    }
    .header-logo svg {
      height: 95%;
      width: auto;
      max-height: 10vh;
      display: block;
    }
    .lang-switcher {
      display: flex; gap: .4rem;
      height: 95%;
      align-items: center;
    }
    .lang-btn {
      height: 95%;
      min-width: 40px;
      border-radius: 6px; cursor: pointer;
      border: 2px solid transparent; overflow: hidden;
      transition: all .2s; opacity: .55;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.35rem; line-height: 1;
      background: var(--surface-2);
    }
    .lang-btn:hover { opacity: .85; }
    .lang-btn.active { opacity: 1; border-color: var(--uno-yellow); box-shadow: 0 2px 12px rgba(255,222,0,.25); }

    @media print { .app-header { display: none !important; } .round-roast { display: none !important; } }

    /* ---- Shared Layout ---- */
    .screen {
      display: none;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 2rem 1rem;
      animation: fadeIn .35s ease;
    }
    .screen.active { display: flex; }
    .screen { padding-top: calc(10vh + 2rem); }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    h1, h2, h3, h4 { font-family: 'Fredoka One', cursive; letter-spacing: .02em; }

    /* ---- Buttons ---- */
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: .5rem;
      border: none; border-radius: 14px; cursor: pointer;
      font-family: 'Inter', sans-serif; font-weight: 600;
      transition: all .2s ease;
    }
    .btn:active { transform: scale(.97); }
    .btn:disabled { opacity: .35; cursor: not-allowed; transform: none; }

    .btn-primary {
      background: linear-gradient(135deg, var(--uno-red), #ff4060);
      color: #fff; font-size: 1.15rem; padding: 1rem 2.5rem;
      box-shadow: 0 6px 24px rgba(237,28,36,.35);
    }
    .btn-primary:hover:not(:disabled) { box-shadow: 0 8px 32px rgba(237,28,36,.5); transform: translateY(-2px); }

    .btn-secondary {
      background: var(--surface-2); color: var(--text);
      font-size: .95rem; padding: .75rem 1.5rem; border: 1px solid var(--border);
    }
    .btn-secondary:hover:not(:disabled) { background: var(--surface-3); }

    .btn-small {
      font-size: .8rem; padding: .45rem 1rem; border-radius: 8px;
    }

    .btn-icon {
      width: 38px; height: 38px; padding: 0; border-radius: 10px;
      background: var(--surface-2); color: var(--text); border: 1px solid var(--border);
      font-size: 1.1rem;
    }

    /* ---- Cards ---- */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1.5rem;
      width: 100%;
      max-width: 480px;
    }

    /* ---- Inputs ---- */
    .input-group { display: flex; flex-direction: column; gap: .4rem; }
    .input-group label { font-size: .85rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: .06em; }

    input[type="text"], input[type="number"], select {
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-size: 1rem;
      padding: .7rem 1rem;
      outline: none;
      transition: border-color .2s;
      width: 100%;
    }
    input:focus, select:focus { border-color: var(--uno-blue); }
    input[type="number"] { -moz-appearance: textfield; }
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; }

    /* ---- HOME SCREEN ---- */
    #home { justify-content: center; gap: 2.5rem; text-align: center; }
    .logo-title {
      font-size: 3.2rem;
      background: linear-gradient(135deg, var(--uno-red), var(--uno-yellow), var(--uno-green), var(--uno-blue));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text;
      filter: drop-shadow(0 2px 12px rgba(237,28,36,.3));
    }
    .logo-sub { color: var(--text-muted); font-size: 1rem; margin-top: .5rem; }

    .home-beta-link {
      margin-top: 2rem;
      width: 100%;
      max-width: 480px;
    }
    .under-construction {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 33.333vh;
      min-height: 80px;
      background: transparent;
      border: none;
      border-radius: 16px;
      text-decoration: none;
      color: var(--text-muted);
      transition: color .2s, opacity .2s;
      cursor: pointer;
      min-width: 44px;
    }
    .under-construction:hover {
      color: var(--uno-yellow);
    }
    .under-construction:hover .under-construction-icon {
      opacity: 0.9;
    }
    .under-construction-icon {
      font-size: 0.75rem;
      line-height: 1;
      opacity: 0.25;
    }

    .uno-cards {
      display: flex; gap: .5rem; justify-content: center; margin-bottom: .5rem;
    }
    .uno-card-mini {
      width: clamp(84px, 22.5vw, 120px);
      display: block;
      transform: rotate(var(--rot, 0deg));
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,.35), 0 8px 24px rgba(0,0,0,.2);
    }
    .uno-card-mini img {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 8px;
    }

    /* ---- SETUP SCREEN ---- */
    #setup { gap: 1.5rem; padding-top: calc(20vh + 1.5rem); }
    #setup .card + .card { margin-top: 0; }

    .player-inputs { display: flex; flex-direction: column; gap: .75rem; margin-top: .75rem; }
    .player-input-row {
      display: flex; align-items: center; gap: .5rem;
    }
    .player-color {
      width: 14px; height: 14px; border-radius: 50%; flex-shrink: 0;
    }
    .player-input-row input { flex: 1; }

    .points-presets {
      display: flex; flex-wrap: wrap; gap: .5rem; margin-top: .75rem;
    }
    .preset-btn {
      padding: .5rem 1rem; border-radius: 10px; border: 1px solid var(--border);
      background: var(--surface-2); color: var(--text); cursor: pointer;
      font-family: 'Inter', sans-serif; font-size: .9rem; font-weight: 500;
      transition: all .2s;
    }
    .preset-btn:hover, .preset-btn.selected {
      border-color: var(--uno-yellow); background: rgba(255,222,0,.12); color: var(--uno-yellow);
    }

    .setup-footer { margin-top: .5rem; }

    /* Number selector */
    .number-selector {
      display: flex; align-items: center; gap: 1rem; margin-top: .75rem;
    }
    .number-display {
      font-family: 'Fredoka One', cursive; font-size: 2.2rem;
      width: 60px; text-align: center; color: var(--uno-yellow);
    }

    /* ---- GAME SCREEN ---- */
    #game { gap: 1.25rem; padding-top: calc(20vh + 1rem); }

    .game-header {
      display: flex; align-items: center; justify-content: space-between;
      width: 100%; max-width: 480px;
    }
    .game-header h2 { font-size: 1.4rem; }

    .round-badge {
      background: var(--uno-blue); color: #fff;
      padding: .3rem .9rem; border-radius: 20px;
      font-size: .85rem; font-weight: 600;
    }

    .scoreboard {
      width: 100%; max-width: 480px;
      border-collapse: separate;
      border-spacing: 0;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
    }
    .scoreboard th, .scoreboard td {
      padding: .65rem .75rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    .scoreboard th {
      background: var(--surface-2);
      font-size: .75rem;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: var(--text-muted);
      font-weight: 600;
    }
    .scoreboard tr:last-child td { border-bottom: none; }
    .scoreboard .player-name-cell {
      display: flex; align-items: center; gap: .5rem; font-weight: 600;
    }
    .scoreboard .total-cell {
      font-family: 'Fredoka One', cursive;
      font-size: 1.1rem;
    }
    .scoreboard .over-limit { color: var(--danger); }
    .scoreboard .winner-row { background: rgba(77, 255, 145, .08); }

    .round-inputs { display: flex; flex-direction: column; gap: .65rem; }
    .round-input-row {
      display: flex; align-items: center; gap: .75rem;
    }
    .round-input-row .player-label {
      display: flex; align-items: center; gap: .5rem;
      font-weight: 600; font-size: .95rem;
      min-width: 120px;
    }
    .round-input-row input {
      width: 90px; text-align: center;
      font-size: 1.1rem; font-weight: 600;
      padding: .6rem .5rem;
    }

    .game-actions {
      display: flex; gap: .75rem; flex-wrap: wrap; justify-content: center;
    }

    /* Progress bar */
    .progress-container { width: 100%; max-width: 480px; }
    .progress-label {
      display: flex; justify-content: space-between;
      font-size: .8rem; color: var(--text-muted); margin-bottom: .35rem;
    }
    .progress-bar {
      height: 6px; background: var(--surface-2); border-radius: 3px; overflow: hidden;
    }
    .progress-fill {
      height: 100%; border-radius: 3px;
      transition: width .4s ease;
      background: linear-gradient(90deg, var(--uno-green), var(--uno-yellow), var(--uno-red));
    }

    /* Round history */
    .round-history {
      width: 100%; max-width: 480px;
    }
    /* Round roast carousel */
    .round-roast {
      width: 100%; max-width: 480px;
      display: none;
      flex-direction: column;
      gap: .5rem;
    }
    .round-roast.visible { display: flex; }
    .round-roast-slides {
      min-height: 80px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
    }
    .round-roast-slide {
      display: none;
      padding: 1rem 1.25rem;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: .95rem;
      line-height: 1.4;
      min-height: 80px;
      box-sizing: border-box;
    }
    .round-roast-slide.active {
      display: flex;
    }
    .round-roast-slide.roast { color: var(--danger); }
    .round-roast-slide.brag { color: var(--success); }
    .round-roast-dots {
      display: flex;
      justify-content: center;
      gap: .5rem;
    }
    .round-roast-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--surface-3);
      border: none;
      cursor: pointer;
      padding: 0;
      transition: transform .2s, background .2s;
    }
    .round-roast-dot:hover { background: var(--border); }
    .round-roast-dot.active { background: var(--uno-yellow); transform: scale(1.2); }

    .round-history h3 { font-size: 1rem; margin-bottom: .75rem; color: var(--text-muted); }
    .round-history-table {
      width: 100%; border-collapse: separate; border-spacing: 0;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 14px; overflow: hidden;
      font-size: .85rem;
    }
    .round-history-table th, .round-history-table td {
      padding: .5rem .6rem; text-align: center;
      border-bottom: 1px solid var(--border);
    }
    .round-history-table th {
      background: var(--surface-2); font-size: .7rem;
      text-transform: uppercase; letter-spacing: .04em;
      color: var(--text-muted); font-weight: 600;
    }
    .round-history-table tr:last-child td { border-bottom: none; }
    .round-history-table td:first-child { font-weight: 600; text-align: left; padding-left: .75rem; }
    .round-history-table th:first-child { text-align: left; padding-left: .75rem; }
    .round-history-table .edit-cell {
      cursor: pointer; color: var(--uno-blue); font-weight: 600;
    }
    .round-history-table .edit-cell:hover { text-decoration: underline; }

    /* ---- RESULTS SCREEN ---- */
    #results { gap: 1.5rem; padding-top: calc(20vh + 1.5rem); text-align: center; }

    .trophy { font-size: 4rem; margin-bottom: .25rem; }
    .winner-name {
      font-family: 'Fredoka One', cursive; font-size: 2rem;
      background: linear-gradient(135deg, var(--uno-yellow), #ffaa00);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .winner-subtitle { color: var(--text-muted); font-size: .95rem; margin-top: .25rem; }

    .final-standings {
      width: 100%; max-width: 480px;
    }
    .standing-row {
      display: flex; align-items: center; gap: 1rem;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 12px; padding: .85rem 1rem; margin-bottom: .5rem;
      transition: background .2s;
    }
    .standing-row:first-child { border-color: var(--uno-yellow); background: rgba(255,222,0,.06); }
    .standing-position {
      font-family: 'Fredoka One', cursive; font-size: 1.3rem;
      width: 36px; text-align: center;
    }
    .standing-position.gold { color: var(--uno-yellow); }
    .standing-position.silver { color: #c0c0c0; }
    .standing-position.bronze { color: #cd7f32; }
    .standing-info { flex: 1; text-align: left; }
    .standing-info .name { font-weight: 600; font-size: 1rem; }
    .standing-score {
      font-family: 'Fredoka One', cursive; font-size: 1.2rem;
    }

    .results-actions {
      display: flex; gap: .75rem; flex-wrap: wrap; justify-content: center;
      margin-top: .5rem;
    }

    /* ---- EDIT MODAL ---- */
    .modal-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,.6); backdrop-filter: blur(4px);
      z-index: 100; align-items: center; justify-content: center;
      padding: 1rem;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 1.75rem;
      width: 100%; max-width: 400px;
      animation: fadeIn .25s ease;
    }
    .modal h3 { margin-bottom: 1rem; font-size: 1.15rem; }
    .modal-inputs { display: flex; flex-direction: column; gap: .65rem; }
    .modal-input-row {
      display: flex; align-items: center; justify-content: space-between; gap: 1rem;
    }
    .modal-input-row label { font-weight: 600; font-size: .9rem; }
    .modal-input-row input { width: 90px; text-align: center; font-weight: 600; }
    .modal-actions { display: flex; gap: .75rem; margin-top: 1.25rem; justify-content: flex-end; }

    /* ---- PRINT STYLES ---- */
    @media print {
      body { background: #fff; color: #000; }
      .screen { padding: 0; min-height: auto; }
      .no-print { display: none !important; }
      .card, .scoreboard, .round-history-table, .standing-row {
        background: #fff; border-color: #ddd; color: #000;
      }
      .scoreboard th, .round-history-table th { background: #f5f5f5; color: #333; }
      .scoreboard td, .round-history-table td { color: #000; }
      .logo-title, .winner-name {
        -webkit-text-fill-color: #000;
        background: none; color: #000;
      }
      .standing-position.gold { color: #b8860b; -webkit-text-fill-color: #b8860b; }
      .trophy { font-size: 2rem; }
      .print-header {
        display: block !important;
        text-align: center; margin-bottom: 1rem;
        font-family: 'Fredoka One', cursive; font-size: 1.5rem;
      }
      .standing-row { border-color: #ccc; }
      .standing-row:first-child { border-color: #b8860b; }
    }

    .print-header { display: none; }

    /* ---- Walk of Shame ---- */
    .walk-of-shame {
      width: 100%; max-width: 480px;
      display: none;
    }
    .walk-of-shame.visible { display: block; }
    .walk-of-shame h3 {
      font-size: .95rem; color: var(--danger); margin-bottom: .5rem;
      display: flex; align-items: center; gap: .4rem;
    }
    .shame-list {
      display: flex; flex-direction: column; gap: .4rem;
    }
    .shame-row {
      display: flex; align-items: center; gap: .6rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: .55rem .75rem;
    }
    .shame-rank {
      font-family: 'Fredoka One', cursive;
      font-size: 1rem; width: 24px; text-align: center;
      color: var(--danger);
    }
    .shame-name {
      flex: 1; font-weight: 600; font-size: .9rem;
      display: flex; align-items: center; gap: .4rem;
    }
    .shame-badge {
      background: rgba(255,77,106,.15);
      color: var(--danger);
      padding: .2rem .6rem;
      border-radius: 8px;
      font-size: .8rem;
      font-weight: 700;
      white-space: nowrap;
    }

    /* ---- Responsive ---- */
    @media (max-width: 500px) {
      .logo-title { font-size: 2.4rem; }
      .round-input-row .player-label { min-width: 90px; font-size: .85rem; }
      .round-input-row input { width: 75px; }
      .scoreboard th, .scoreboard td { padding: .5rem .4rem; font-size: .85rem; }
    }
  </style>
</head>
<body>

  <!-- ============ HEADER (logo + flags) ============ -->
  <header class="app-header no-print">
    <a href="#" class="header-logo" onclick="showScreen('home'); return false;" aria-label="Lunes de UNO">
      <svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <!-- Galera negra (top hat): brim + crown -->
        <ellipse cx="20" cy="28" rx="14" ry="4" fill="#0a0a0a"/>
        <path d="M8 28 L8 12 Q8 6 20 6 Q32 6 32 12 L32 28 Z" fill="#0a0a0a"/>
        <ellipse cx="20" cy="12" rx="12" ry="3" fill="#111"/>
        <rect x="10" y="12" width="20" height="16" fill="#0a0a0a"/>
      </svg>
    </a>
    <div class="lang-switcher">
      <button class="lang-btn active" id="langEs" onclick="setLang('es')" title="EspaÃ±ol">ðŸ‡ºðŸ‡¾</button>
      <button class="lang-btn" id="langEn" onclick="setLang('en')" title="English">ðŸ‡ºðŸ‡¸</button>
      <button class="lang-btn" id="langPt" onclick="setLang('pt')" title="PortuguÃªs">ðŸ‡§ðŸ‡·</button>
      <button class="lang-btn" id="langDe" onclick="setLang('de')" title="Deutsch">ðŸ‡©ðŸ‡ª</button>
    </div>
  </header>

  <!-- ============ HOME ============ -->
  <div id="home" class="screen active">
    <div>
      <div class="uno-cards">
        <div class="uno-card-mini" style="--rot:-8deg;"><img src="assets/image-9bf8c041-0dcc-4664-a43d-b08c00b056a6.png" alt="" width="240" height="348"></div>
        <div class="uno-card-mini" style="--rot:-3deg;"><img src="assets/image-f89188ae-0fab-4b0d-906f-3d074070604c.png" alt="" width="240" height="348"></div>
        <div class="uno-card-mini" style="--rot:3deg;"><img src="assets/image-9f0bc4e9-7a6e-4737-8f3d-94efcbed10d2.png" alt="" width="240" height="348"></div>
        <div class="uno-card-mini" style="--rot:8deg;"><img src="assets/image-6203ef81-62d7-487c-9967-86da2115146f.png" alt="" width="240" height="348"></div>
      </div>
      <h1 class="logo-title">Lunes de UNO</h1>
      <p class="logo-sub" data-i18n="home_sub"></p>
    </div>
    <button class="btn btn-primary" onclick="showScreen('setup')" data-i18n="home_start"></button>
    <div class="home-beta-link">
      <a href="index2.html" class="under-construction" data-i18n-title="home_under_construction" title="En construcciÃ³n: compartir resultados" aria-label="En construcciÃ³n: compartir resultados">
        <span class="under-construction-icon" aria-hidden="true">ðŸš§</span>
      </a>
    </div>
  </div>

  <!-- ============ SETUP ============ -->
  <div id="setup" class="screen">
    <h2 style="font-size:1.6rem; margin-bottom:.5rem;" data-i18n="setup_title"></h2>

    <div class="card">
      <div class="input-group">
        <label data-i18n="setup_players_label"></label>
        <div class="number-selector">
          <button class="btn btn-icon" onclick="changePlayerCount(-1)">-</button>
          <div class="number-display" id="playerCountDisplay">2</div>
          <button class="btn btn-icon" onclick="changePlayerCount(1)">+</button>
        </div>
      </div>
      <div class="player-inputs" id="playerInputs"></div>
    </div>

    <div class="card">
      <div class="input-group">
        <label data-i18n="setup_points_label"></label>
        <div class="points-presets" id="pointsPresets">
          <button class="preset-btn" data-val="200" onclick="selectPoints(this, 200)">200</button>
          <button class="preset-btn" data-val="300" onclick="selectPoints(this, 300)">300</button>
          <button class="preset-btn selected" data-val="500" onclick="selectPoints(this, 500)">500</button>
          <button class="preset-btn" data-val="1000" onclick="selectPoints(this, 1000)">1000</button>
        </div>
        <div style="display:flex; align-items:center; gap:.5rem; margin-top:.75rem;">
          <input type="number" id="customPoints" placeholder="" data-i18n-ph="setup_custom_placeholder" min="50" style="flex:1;" oninput="onCustomPoints()">
        </div>
      </div>
    </div>

    <div class="setup-footer">
      <button class="btn btn-primary" id="startGameBtn" onclick="startGame()" data-i18n="setup_start_btn"></button>
    </div>

    <button class="btn btn-secondary btn-small no-print" onclick="showScreen('home')" style="margin-top:.5rem;" data-i18n="back_btn"></button>
  </div>

  <!-- ============ GAME ============ -->
  <div id="game" class="screen">
    <div class="game-header">
      <h2 id="gameTitle">Lunes de UNO</h2>
      <span class="round-badge" id="roundBadge"></span>
    </div>

    <!-- Progress of leading player -->
    <div class="progress-container" id="progressContainer">
      <div class="progress-label">
        <span id="progressLeader">-</span>
        <span id="progressText">0 / 500</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width:0%"></div>
      </div>
    </div>

    <!-- Current Scoreboard -->
    <table class="scoreboard" id="scoreboard"></table>

    <!-- Walk of Shame -->
    <div class="walk-of-shame no-print" id="walkOfShame">
      <h3><span>ðŸ’€</span> <span data-i18n="shame_title"></span></h3>
      <div class="shame-list" id="shameList"></div>
    </div>

    <!-- Round Score Input -->
    <div class="card" id="roundInputCard">
      <h4 style="margin-bottom:.75rem; font-size:1rem;" data-i18n="game_enter_scores"></h4>
      <div class="round-inputs" id="roundInputs"></div>
      <div class="game-actions" style="margin-top:1rem;">
        <button class="btn btn-primary" style="font-size:1rem; padding:.75rem 2rem;" onclick="submitRound()" data-i18n="game_end_round"></button>
      </div>
    </div>

    <!-- Round roast carousel (after each round) -->
    <div class="round-roast no-print" id="roundRoastCarousel">
      <div class="round-roast-slides" id="roundRoastSlides"></div>
      <div class="round-roast-dots" id="roundRoastDots"></div>
    </div>

    <!-- Round History -->
    <div class="round-history" id="roundHistoryContainer" style="display:none;">
      <h3 data-i18n="game_round_history"></h3>
      <table class="round-history-table" id="roundHistoryTable"></table>
    </div>

    <button class="btn btn-secondary btn-small no-print" onclick="confirmQuit()" style="margin-top:.5rem; color:var(--danger);" data-i18n="game_quit"></button>
  </div>

  <!-- ============ RESULTS ============ -->
  <div id="results" class="screen">
    <div class="print-header">Lunes de UNO - Final Scores</div>
    <div class="trophy">&#127942;</div>
    <div>
      <div class="winner-name" id="winnerName">-</div>
      <p class="winner-subtitle" data-i18n="results_winner_sub"></p>
    </div>

    <div class="final-standings" id="finalStandings"></div>

    <!-- Paseo de la vergÃ¼enza / Walk of shame -->
    <div class="card" id="walkOfShameCard" style="display:none;">
      <h3 id="walkTitle"></h3>
      <p id="walkLine" style="margin-top:.35rem;"></p>
      <p id="walkRound" style="margin-top:.25rem; font-size:.85rem; color:var(--text-muted);"></p>
    </div>

    <!-- Full breakdown for print -->
    <div class="round-history" id="resultsHistoryContainer">
      <h3 data-i18n="results_breakdown"></h3>
      <table class="round-history-table" id="resultsHistoryTable"></table>
    </div>

    <div class="results-actions no-print">
      <button class="btn btn-secondary" onclick="printResults()"><span>&#128424;</span> <span data-i18n="results_print"></span></button>
      <button class="btn btn-secondary" onclick="showEditableHistory()"><span>&#9998;</span> <span data-i18n="results_edit"></span></button>
      <button class="btn btn-primary" onclick="newGame()" data-i18n="results_new_game"></button>
    </div>
  </div>

  <!-- ============ EDIT MODAL ============ -->
  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <h3 id="editModalTitle"></h3>
      <div class="modal-inputs" id="editModalInputs"></div>
      <div class="modal-actions">
        <button class="btn btn-secondary btn-small" onclick="closeEditModal()" data-i18n="modal_cancel"></button>
        <button class="btn btn-primary btn-small" onclick="saveEditRound()" data-i18n="modal_save"></button>
      </div>
    </div>
  </div>

<script>
// ============ I18N ============
const STRINGS = {
  es: {
    home_sub: 'Contador de puntos, bÃ³',
    home_start: 'Arrancar partida nueva',
    home_under_construction: 'En construcciÃ³n: compartir resultados',
    setup_title: 'Partida nueva',
    setup_players_label: 'Â¿CuÃ¡ntos juegan?',
    setup_points_label: 'Â¿Hasta cuÃ¡ntos puntos?',
    setup_custom_placeholder: 'Ponele lo que quieras...',
    setup_start_btn: 'Â¡Dale que va!',
    back_btn: 'Volver',
    game_enter_scores: 'Metele los puntos de la ronda',
    game_end_round: 'Cerrar ronda',
    game_round_history: 'Lo que fue pasando',
    game_quit: 'Rajar del juego',
    game_round: 'Ronda',
    game_player: 'Jugador',
    game_total: 'Total',
    game_no_scores: 'TodavÃ­a no arrancÃ³ nadie',
    game_pts: 'pts',
    game_edit: 'editar',
    game_alert_no_scores: 'Bo, metele algÃºn puntaje a alguien por lo menos.',
    game_confirm_quit: 'Â¿Posta te querÃ©s ir? Se pierde todo eh.',
    shame_title: 'Paseo de la VergÃ¼enza',
    shame_round_lost: 'ronda perdida',
    shame_rounds_lost: 'rondas perdidas',
    results_winner_sub: 'Â¡ganÃ³ con menos puntos, quÃ© crack!',
    results_breakdown: 'Ronda por ronda',
    results_print: 'Imprimir',
    results_edit: 'Editar puntajes',
    results_new_game: 'Otra partidita',
    modal_edit_round: 'Editar Ronda',
    modal_cancel: 'Na, dejÃ¡',
    modal_save: 'Guardar',
    player_placeholder: 'Jugador',
  },
  en: {
    home_sub: 'Score Tracker',
    home_start: 'Start New Game',
    home_under_construction: 'Under construction: share results',
    setup_title: 'New Game',
    setup_players_label: 'Number of Players',
    setup_points_label: 'Points to Play',
    setup_custom_placeholder: 'Custom...',
    setup_start_btn: 'Start Game',
    back_btn: 'Back',
    game_enter_scores: 'Enter Round Scores',
    game_end_round: 'End Round',
    game_round_history: 'Round History',
    game_quit: 'Quit Game',
    game_round: 'Round',
    game_player: 'Player',
    game_total: 'Total',
    game_no_scores: 'No scores yet',
    game_pts: 'pts',
    game_edit: 'edit',
    game_alert_no_scores: 'Enter at least one score for this round.',
    game_confirm_quit: 'Are you sure you want to quit this game?',
    shame_title: 'Walk of Shame',
    shame_round_lost: 'round lost',
    shame_rounds_lost: 'rounds lost',
    results_winner_sub: 'wins with the lowest score!',
    results_breakdown: 'Round Breakdown',
    results_print: 'Print Scores',
    results_edit: 'Edit Scores',
    results_new_game: 'New Game',
    modal_edit_round: 'Edit Round',
    modal_cancel: 'Cancel',
    modal_save: 'Save',
    player_placeholder: 'Player',
  },
  pt: {
    home_sub: 'Marcador de pontos',
    home_start: 'ComeÃ§ar nova partida',
    home_under_construction: 'Em construÃ§Ã£o: compartilhar resultados',
    setup_title: 'Nova partida',
    setup_players_label: 'Quantos jogam?',
    setup_points_label: 'AtÃ© quantos pontos?',
    setup_custom_placeholder: 'Coloca o valor que quiser...',
    setup_start_btn: 'Bora jogar!',
    back_btn: 'Voltar',
    game_enter_scores: 'Coloca os pontos da rodada',
    game_end_round: 'Fechar rodada',
    game_round_history: 'O que jÃ¡ rolou',
    game_quit: 'Sair do jogo',
    game_round: 'Rodada',
    game_player: 'Jogador',
    game_total: 'Total',
    game_no_scores: 'NinguÃ©m marcou ainda',
    game_pts: 'pts',
    game_edit: 'editar',
    game_alert_no_scores: 'Bota pelo menos um pontinho pra alguÃ©m.',
    game_confirm_quit: 'Tem certeza que quer sair? Perde tudo hein.',
    shame_title: 'Passeio da vergonha',
    shame_round_lost: 'rodada perdida',
    shame_rounds_lost: 'rodadas perdidas',
    results_winner_sub: 'ganhou com menos pontos, mito!',
    results_breakdown: 'Rodada por rodada',
    results_print: 'Imprimir',
    results_edit: 'Editar pontuaÃ§Ãµes',
    results_new_game: 'Outra partida',
    modal_edit_round: 'Editar rodada',
    modal_cancel: 'Deixa pra lÃ¡',
    modal_save: 'Salvar',
    player_placeholder: 'Jogador',
  },
  de: {
    home_sub: 'Punktestand fÃ¼r UNO',
    home_start: 'Neues Spiel starten',
    home_under_construction: 'Im Bau: Ergebnisse teilen',
    setup_title: 'Neues Spiel',
    setup_players_label: 'Wie viele spielen?',
    setup_points_label: 'Bis zu wie vielen Punkten?',
    setup_custom_placeholder: 'Eigene Punktzahl...',
    setup_start_btn: 'Los gehtâ€™s!',
    back_btn: 'ZurÃ¼ck',
    game_enter_scores: 'Rundenpunkte eintragen',
    game_end_round: 'Runde beenden',
    game_round_history: 'Bisherige Runden',
    game_quit: 'Spiel verlassen',
    game_round: 'Runde',
    game_player: 'Spieler',
    game_total: 'Gesamt',
    game_no_scores: 'Noch keine Punkte',
    game_pts: 'Pkt',
    game_edit: 'bearbeiten',
    game_alert_no_scores: 'Trag wenigstens einen Punkt fÃ¼r jemanden ein.',
    game_confirm_quit: 'Willst du das Spiel wirklich beenden? Alles geht verloren.',
    shame_title: 'Gang der Schande',
    shame_round_lost: 'verlorene Runde',
    shame_rounds_lost: 'verlorene Runden',
    results_winner_sub: 'gewinnt mit der niedrigsten Punktzahl!',
    results_breakdown: 'RundenÃ¼bersicht',
    results_print: 'Punkte drucken',
    results_edit: 'Punkte bearbeiten',
    results_new_game: 'Neues Spiel',
    modal_edit_round: 'Runde bearbeiten',
    modal_cancel: 'Abbrechen',
    modal_save: 'Speichern',
    player_placeholder: 'Spieler',
  }
};

// Messages for round roast carousel: 2 at last (most pts), 1 at second-last, 1 at first (least pts)
const CAROUSEL_MSGS = {
  es: {
    last: [
      'Bo {name}, te comiste todos los puntos de la mesa ðŸ˜‚',
      '{name} juntÃ³ mÃ¡s puntos que boleto de STM, ta bravo.',
      'Â¿{name} estaba jugando al UNO o al â€œsumÃ¡ todo, boâ€?',
      'Pa, {name}, dejale algÃºn punto a los demÃ¡s, Â¿no?',
      'Alguien avÃ­sele a {name} que acÃ¡ gana el que tiene menos, ta.',
    ],
    secondLast: [
      '{name} zafÃ³ por poquito de ser el desastre de la ronda.',
      'Bo {name}, casi quedÃ¡s Ãºltimo tambiÃ©n, ojo ahÃ­.',
    ],
    first: [
      'Â¡{name} saliÃ³ hecho un crack esta ronda, bo! ðŸ†',
      '{name} se fue livianito de puntos, ta que bien jugado.',
      'Esta ronda fue toda de {name}, tremendo nivel.',
    ],
  },
  en: {
    last: [
      '{name} went full send and took the whole pile! ðŸ˜‚',
      '{name} collected more than the dealer. Yikes.',
      'Was {name} playing UNO or â€œadd everythingâ€?',
      '{name} built a monument to points! ðŸ—¿',
      'Someone tell {name} that the lowest score wins.',
    ],
    secondLast: [
      '{name} came second atâ€¦ hoarding. So close.',
      '{name} almost had the highest round. Next time!',
    ],
    first: [
      '{name} crushed it this round! ðŸ†',
      '{name} kept it low. That\'s how you play!',
      'That round belonged to {name}. Applause.',
    ],
  },
};

let currentLang = localStorage.getItem('lunesdeuno_lang') || 'es';
let roundRoastInterval = null;

function t(key) {
  return (STRINGS[currentLang] && STRINGS[currentLang][key]) || STRINGS.en[key] || key;
}

function setLang(lang) {
  currentLang = lang;
  localStorage.setItem('lunesdeuno_lang', lang);
  document.documentElement.lang = lang;

  // Update flag buttons
  const btnEs = document.getElementById('langEs');
  const btnEn = document.getElementById('langEn');
  const btnPt = document.getElementById('langPt');
  const btnDe = document.getElementById('langDe');
  if (btnEs) btnEs.classList.toggle('active', lang === 'es');
  if (btnEn) btnEn.classList.toggle('active', lang === 'en');
  if (btnPt) btnPt.classList.toggle('active', lang === 'pt');
  if (btnDe) btnDe.classList.toggle('active', lang === 'de');

  // Apply all data-i18n
  document.querySelectorAll('[data-i18n]').forEach(el => {
    el.textContent = t(el.dataset.i18n);
  });
  document.querySelectorAll('[data-i18n-ph]').forEach(el => {
    el.placeholder = t(el.dataset.i18nPh);
  });
  document.querySelectorAll('[data-i18n-title]').forEach(el => {
    const val = t(el.dataset.i18nTitle);
    el.title = val;
    el.setAttribute('aria-label', val);
  });

  // Re-render dynamic content if a game screen is active
  if (document.getElementById('setup').classList.contains('active')) renderPlayerInputs();
  if (document.getElementById('game').classList.contains('active')) renderGame();
  if (document.getElementById('results').classList.contains('active')) renderResults();
}

// ============ STATE ============
let state = {
  playerCount: 2,
  maxPoints: 500,
  players: [],
  rounds: [],
  currentRound: 0,
  gameOver: false
};

const PLAYER_COLORS = [
  '#ED1C24', '#FFDE00', '#00A651', '#0072BC',
  '#FF6B35', '#A855F7', '#EC4899', '#14B8A6',
  '#F97316', '#6366F1'
];

// ============ NAVIGATION ============
function showScreen(id) {
  if (id !== 'game' && roundRoastInterval) {
    clearInterval(roundRoastInterval);
    roundRoastInterval = null;
  }
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if (id === 'setup') initSetup();
  if (id === 'game') renderGame();
  if (id === 'results') renderResults();
}

// ============ SETUP ============
function initSetup() {
  renderPlayerInputs();
  validateSetup();
}

function changePlayerCount(delta) {
  state.playerCount = Math.max(2, Math.min(10, state.playerCount + delta));
  document.getElementById('playerCountDisplay').textContent = state.playerCount;
  renderPlayerInputs();
}

function renderPlayerInputs() {
  const container = document.getElementById('playerInputs');
  const existing = container.querySelectorAll('input');
  const oldValues = Array.from(existing).map(i => i.value);

  let html = '';
  for (let i = 0; i < state.playerCount; i++) {
    const color = PLAYER_COLORS[i % PLAYER_COLORS.length];
    const val = oldValues[i] || '';
    html += `
      <div class="player-input-row">
        <div class="player-color" style="background:${color}"></div>
        <input type="text" placeholder="${t('player_placeholder')} ${i + 1}" value="${val}" maxlength="20" oninput="validateSetup()">
      </div>`;
  }
  container.innerHTML = html;
  validateSetup();
}

function selectPoints(btn, val) {
  document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  state.maxPoints = val;
  document.getElementById('customPoints').value = '';
  validateSetup();
}

function onCustomPoints() {
  const v = parseInt(document.getElementById('customPoints').value);
  document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('selected'));
  if (v && v >= 50) {
    state.maxPoints = v;
  }
  validateSetup();
}

function validateSetup() {
  const inputs = document.querySelectorAll('#playerInputs input');
  const allNamed = Array.from(inputs).every(i => i.value.trim().length > 0);
  const hasPoints = state.maxPoints >= 50;
  document.getElementById('startGameBtn').disabled = !(allNamed && hasPoints);
}

function startGame() {
  const inputs = document.querySelectorAll('#playerInputs input');
  state.players = Array.from(inputs).map((inp, i) => ({
    name: inp.value.trim() || `${t('player_placeholder')} ${i+1}`,
    color: PLAYER_COLORS[i % PLAYER_COLORS.length]
  }));
  state.rounds = [];
  state.currentRound = 0;
  state.gameOver = false;
  showScreen('game');
}

// ============ ROUND ROAST CAROUSEL ============
function getRoundRanking(roundScores) {
  const withIdx = state.players.map((p, i) => ({ idx: i, name: p.name, score: roundScores[i] || 0 }));
  const byScoreDesc = [...withIdx].sort((a, b) => b.score - a.score);
  return {
    first: byScoreDesc[byScoreDesc.length - 1],
    secondLast: byScoreDesc.length >= 2 ? byScoreDesc[1] : byScoreDesc[0],
    last: byScoreDesc[0],
  };
}

function buildRoastMessages(roundScores) {
  const rank = getRoundRanking(roundScores);
  const lang = currentLang in CAROUSEL_MSGS ? currentLang : 'es';
  const M = CAROUSEL_MSGS[lang];
  const pick = (arr, name) => arr[Math.floor(Math.random() * arr.length)].replace(/\{name\}/g, name);
  return [
    pick(M.last, rank.last.name),
    pick(M.last, rank.last.name),
    pick(M.secondLast, rank.secondLast.name),
    pick(M.first, rank.first.name),
  ];
}

function setRoundRoastSlide(index) {
  const slides = document.querySelectorAll('.round-roast-slide');
  const dots = document.querySelectorAll('.round-roast-dot');
  slides.forEach((s, i) => s.classList.toggle('active', i === index));
  dots.forEach((d, i) => d.classList.toggle('active', i === index));
}

function updateRoundRoastCarousel(messages, startAutoAdvance) {
  if (roundRoastInterval) clearInterval(roundRoastInterval);
  roundRoastInterval = null;

  const container = document.getElementById('roundRoastCarousel');
  const slidesEl = document.getElementById('roundRoastSlides');
  const dotsEl = document.getElementById('roundRoastDots');
  if (!messages || messages.length === 0) {
    container.classList.remove('visible');
    return;
  }

  const classes = ['roast', 'roast', 'roast', 'brag'];
  slidesEl.innerHTML = messages.map((text, i) =>
    `<div class="round-roast-slide ${classes[i]}" data-index="${i}">${text}</div>`
  ).join('');
  dotsEl.innerHTML = messages.map((_, i) =>
    `<button type="button" class="round-roast-dot" aria-label="Slide ${i + 1}" onclick="setRoundRoastSlide(${i})"></button>`
  ).join('');

  container.classList.add('visible');
  setRoundRoastSlide(0);
  container.scrollIntoView({ behavior: 'smooth', block: 'center' });

  if (startAutoAdvance && messages.length > 1) {
    let idx = 0;
    roundRoastInterval = setInterval(() => {
      idx = (idx + 1) % messages.length;
      setRoundRoastSlide(idx);
    }, 3200);
  }
}

// ============ WALK OF SHAME ============
function getRoundLossCounts() {
  const losses = state.players.map(() => 0);
  state.rounds.forEach(round => {
    const maxScore = Math.max(...round);
    if (maxScore > 0) {
      round.forEach((s, i) => { if (s === maxScore) losses[i]++; });
    }
  });
  return state.players
    .map((p, i) => ({ idx: i, name: p.name, color: p.color, losses: losses[i] }))
    .filter(p => p.losses > 0)
    .sort((a, b) => b.losses - a.losses)
    .slice(0, 3);
}

function renderWalkOfShame() {
  const container = document.getElementById('walkOfShame');
  const list = document.getElementById('shameList');
  const shamers = getRoundLossCounts();
  if (shamers.length === 0) {
    container.classList.remove('visible');
    return;
  }
  container.classList.add('visible');
  const rankEmoji = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'];
  list.innerHTML = shamers.map((p, i) =>
    `<div class="shame-row">
      <div class="shame-rank">${rankEmoji[i] || (i+1)}</div>
      <div class="shame-name">
        <div class="player-color" style="background:${p.color}"></div>
        ${p.name}
      </div>
      <div class="shame-badge">${p.losses} ${p.losses === 1 ? t('shame_round_lost') : t('shame_rounds_lost')}</div>
    </div>`
  ).join('');
}

// ============ GAME ============
function getTotals() {
  return state.players.map((_, pi) =>
    state.rounds.reduce((sum, round) => sum + (round[pi] || 0), 0)
  );
}

function getLeaderIndex() {
  const totals = getTotals();
  let minIdx = 0;
  totals.forEach((t, i) => { if (t < totals[minIdx]) minIdx = i; });
  return minIdx;
}

function getMaxTotal() {
  return Math.max(...getTotals(), 0);
}

function renderGame() {
  const totals = getTotals();
  const roundNum = state.rounds.length + 1;

  document.getElementById('gameTitle').textContent = 'Lunes de UNO';
  document.getElementById('roundBadge').textContent = `${t('game_round')} ${roundNum}`;

  // Progress
  const maxT = getMaxTotal();
  const leaderIdx = totals.indexOf(Math.max(...totals));
  const pct = Math.min((maxT / state.maxPoints) * 100, 100);
  document.getElementById('progressLeader').textContent =
    maxT > 0 ? `${state.players[leaderIdx].name}: ${totals[leaderIdx]} ${t('game_pts')}` : t('game_no_scores');
  document.getElementById('progressText').textContent = `${maxT} / ${state.maxPoints}`;
  document.getElementById('progressFill').style.width = pct + '%';

  // Scoreboard
  renderScoreboard(totals);

  // Walk of Shame
  renderWalkOfShame();

  // Round inputs
  renderRoundInputs();

  // Round roast carousel (after each round)
  if (state.rounds.length > 0) {
    const messages = state.lastRoundRoastMessages || buildRoastMessages(state.rounds[state.rounds.length - 1]);
    if (!state.lastRoundRoastMessages) state.lastRoundRoastMessages = messages;
    updateRoundRoastCarousel(messages, state.justSubmittedRound === true);
    if (state.justSubmittedRound) state.justSubmittedRound = false;
  } else {
    document.getElementById('roundRoastCarousel').classList.remove('visible');
  }

  // Round history
  renderRoundHistory();
}

function renderScoreboard(totals) {
  const table = document.getElementById('scoreboard');
  let html = `<thead><tr><th>${t('game_player')}</th><th style="text-align:right;">${t('game_total')}</th></tr></thead><tbody>`;
  const sorted = state.players.map((p, i) => ({...p, idx: i, total: totals[i]}))
    .sort((a, b) => a.total - b.total);

  sorted.forEach(p => {
    const overLimit = p.total >= state.maxPoints;
    const isLowest = p.total === sorted[0].total && state.rounds.length > 0;
    html += `<tr class="${isLowest && state.rounds.length > 0 ? 'winner-row' : ''}">
      <td><div class="player-name-cell">
        <div class="player-color" style="background:${p.color}"></div>
        ${p.name}
      </div></td>
      <td style="text-align:right;" class="total-cell ${overLimit ? 'over-limit' : ''}">${p.total}</td>
    </tr>`;
  });
  html += '</tbody>';
  table.innerHTML = html;
}

function renderRoundInputs() {
  if (state.gameOver) {
    document.getElementById('roundInputCard').style.display = 'none';
    return;
  }
  document.getElementById('roundInputCard').style.display = '';
  const container = document.getElementById('roundInputs');
  let html = '';
  state.players.forEach((p, i) => {
    html += `
      <div class="round-input-row">
        <div class="player-label">
          <div class="player-color" style="background:${p.color}"></div>
          ${p.name}
        </div>
        <input type="number" id="roundScore_${i}" placeholder="0" min="0">
      </div>`;
  });
  container.innerHTML = html;
}

function submitRound() {
  const scores = state.players.map((_, i) => {
    const val = parseInt(document.getElementById(`roundScore_${i}`).value) || 0;
    return Math.max(0, val);
  });

  if (scores.every(s => s === 0)) {
    alert(t('game_alert_no_scores'));
    return;
  }

  state.rounds.push(scores);
  state.currentRound = state.rounds.length;
  state.lastRoundRoastMessages = buildRoastMessages(scores);
  state.justSubmittedRound = true;

  const totals = getTotals();
  if (totals.some(t => t >= state.maxPoints)) {
    state.gameOver = true;
    showScreen('results');
    return;
  }

  renderGame();
}

function renderRoundHistory() {
  const container = document.getElementById('roundHistoryContainer');
  if (state.rounds.length === 0) {
    container.style.display = 'none';
    return;
  }
  container.style.display = '';

  const table = document.getElementById('roundHistoryTable');
  let html = `<thead><tr><th>${t('game_round')}</th>`;
  state.players.forEach(p => { html += `<th>${p.name}</th>`; });
  html += '<th class="no-print"></th></tr></thead><tbody>';

  state.rounds.forEach((round, ri) => {
    html += `<tr><td>R${ri + 1}</td>`;
    round.forEach(s => { html += `<td>${s}</td>`; });
    html += `<td class="edit-cell no-print" onclick="openEditModal(${ri})">${t('game_edit')}</td></tr>`;
  });

  const totals = getTotals();
  html += `<tr style="font-weight:700; background:var(--surface-2);"><td>${t('game_total')}</td>`;
  totals.forEach(t => { html += `<td>${t}</td>`; });
  html += '<td class="no-print"></td></tr>';

  html += '</tbody>';
  table.innerHTML = html;
}

// ============ EDIT MODAL ============
let editingRound = -1;

function openEditModal(roundIdx) {
  editingRound = roundIdx;
  document.getElementById('editModalTitle').textContent = `${t('modal_edit_round')} ${roundIdx + 1}`;
  const container = document.getElementById('editModalInputs');
  let html = '';
  state.players.forEach((p, i) => {
    html += `
      <div class="modal-input-row">
        <label>${p.name}</label>
        <input type="number" id="editScore_${i}" value="${state.rounds[roundIdx][i]}" min="0">
      </div>`;
  });
  container.innerHTML = html;
  document.getElementById('editModal').classList.add('active');
}

function closeEditModal() {
  document.getElementById('editModal').classList.remove('active');
  editingRound = -1;
}

function saveEditRound() {
  if (editingRound < 0) return;
  state.players.forEach((_, i) => {
    state.rounds[editingRound][i] = Math.max(0, parseInt(document.getElementById(`editScore_${i}`).value) || 0);
  });
  closeEditModal();

  const totals = getTotals();
  const wasOver = state.gameOver;
  state.gameOver = totals.some(t => t >= state.maxPoints);

  if (state.gameOver && document.getElementById('results').classList.contains('active')) {
    renderResults();
  } else if (state.gameOver && !wasOver) {
    showScreen('results');
  } else if (!state.gameOver && wasOver) {
    showScreen('game');
  } else {
    if (document.getElementById('game').classList.contains('active')) renderGame();
    if (document.getElementById('results').classList.contains('active')) renderResults();
  }
}

// ============ RESULTS ============
function renderResults() {
  const totals = getTotals();
  const standings = state.players.map((p, i) => ({...p, idx: i, total: totals[i]}))
    .sort((a, b) => a.total - b.total);

  document.getElementById('winnerName').textContent = standings[0].name;

  const container = document.getElementById('finalStandings');
  const medals = ['gold', 'silver', 'bronze'];
  let html = '';
  standings.forEach((p, i) => {
    html += `
      <div class="standing-row">
        <div class="standing-position ${medals[i] || ''}">${i + 1}</div>
        <div class="standing-info">
          <div class="name" style="display:flex;align-items:center;gap:.4rem;">
            <div class="player-color" style="background:${p.color}"></div>
            ${p.name}
          </div>
        </div>
        <div class="standing-score">${p.total} ${t('game_pts')}</div>
      </div>`;
  });
  container.innerHTML = html;

  renderResultsHistory();
  renderWalkOfShame();
}

function getWalkOfShameData() {
  if (!state.players.length || !state.rounds.length) return null;
  const totals = getTotals();
  let lastIdx = 0;
  totals.forEach((t, i) => { if (t > totals[lastIdx]) lastIdx = i; });
  let worstPts = 0;
  let worstRound = -1;
  state.rounds.forEach((round, ri) => {
    const v = round[lastIdx] || 0;
    if (v > worstPts) {
      worstPts = v;
      worstRound = ri + 1;
    }
  });
  return {
    name: state.players[lastIdx].name,
    total: totals[lastIdx],
    worstPts,
    worstRound
  };
}

function renderWalkOfShame() {
  const card = document.getElementById('walkOfShameCard');
  if (!card) return;
  const data = getWalkOfShameData();
  if (!data) {
    card.style.display = 'none';
    return;
  }
  card.style.display = '';
  const titleEl = document.getElementById('walkTitle');
  const lineEl = document.getElementById('walkLine');
  const roundEl = document.getElementById('walkRound');
  titleEl.textContent = t('shame_title');
  lineEl.textContent = `${data.name} - ${data.total} ${t('game_pts')}`;
  if (data.worstRound > 0 && data.worstPts > 0) {
    const labelSing = t('shame_round_lost');
    const labelPlur = t('shame_rounds_lost');
    const label = data.worstPts === 1 ? labelSing : labelPlur;
    if (currentLang === 'es') {
      roundEl.textContent = `Peor ronda: R${data.worstRound} con ${data.worstPts} puntos (${label}).`;
    } else if (currentLang === 'pt') {
      roundEl.textContent = `Pior rodada: R${data.worstRound} com ${data.worstPts} pontos (${label}).`;
    } else if (currentLang === 'de') {
      roundEl.textContent = `Schlechteste Runde: R${data.worstRound} mit ${data.worstPts} Punkten (${label}).`;
    } else {
      roundEl.textContent = `Worst round: R${data.worstRound} with ${data.worstPts} points (${label}).`;
    }
  } else {
    roundEl.textContent = '';
  }
}

function renderResultsHistory() {
  const table = document.getElementById('resultsHistoryTable');
  let html = `<thead><tr><th>${t('game_round')}</th>`;
  state.players.forEach(p => { html += `<th>${p.name}</th>`; });
  html += '</tr></thead><tbody>';

  state.rounds.forEach((round, ri) => {
    html += `<tr><td>R${ri + 1}</td>`;
    round.forEach(s => { html += `<td>${s}</td>`; });
    html += '</tr>';
  });

  const totals = getTotals();
  html += `<tr style="font-weight:700; background:var(--surface-2);"><td>${t('game_total')}</td>`;
  totals.forEach(t => { html += `<td>${t}</td>`; });
  html += '</tr></tbody>';
  table.innerHTML = html;
}

function showEditableHistory() {
  const table = document.getElementById('resultsHistoryTable');
  let html = `<thead><tr><th>${t('game_round')}</th>`;
  state.players.forEach(p => { html += `<th>${p.name}</th>`; });
  html += '<th></th></tr></thead><tbody>';

  state.rounds.forEach((round, ri) => {
    html += `<tr><td>R${ri + 1}</td>`;
    round.forEach(s => { html += `<td>${s}</td>`; });
    html += `<td class="edit-cell" onclick="openEditModal(${ri})">${t('game_edit')}</td></tr>`;
  });

  const totals = getTotals();
  html += `<tr style="font-weight:700; background:var(--surface-2);"><td>${t('game_total')}</td>`;
  totals.forEach(t => { html += `<td>${t}</td>`; });
  html += '<td></td></tr></tbody>';
  table.innerHTML = html;
}

function printResults() {
  window.print();
}

function newGame() {
  state = {
    playerCount: 2, maxPoints: 500,
    players: [], rounds: [], currentRound: 0, gameOver: false
  };
  document.getElementById('playerCountDisplay').textContent = '2';
  showScreen('home');
}

function confirmQuit() {
  if (confirm(t('game_confirm_quit'))) {
    newGame();
  }
}

// ============ INIT ============
setLang(currentLang);
initSetup();
</script>
</body>
</html>
